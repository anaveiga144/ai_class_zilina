<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <title>HTML5 Genetic Algorithm 2D Car Thingy - Chrome recommended</title> <style>html{ font-size:15px;font-family:sans-serif;color:#112D4E;line-height:1.4;}html *{ box-sizing:border-box;}body{ padding:20px;margin:0;min-width:1200px;width:100%;}.clearfix:after{ content:".";clear:both;display:block;visibility:hidden;height:0;}.float-left{ float:left;}#mainbox{ width:800px;height:400px;border:1px solid #BE4747;}#div{ width:800px;height:400px;border:1px solid #112D4E;}#data{ width:400px;padding:0 20px 20px;}#data table{ width:100%;}[type="button"]{ border:none;background:#3F72AF;color:#F9F7F7;margin:0 0 5px;padding:5px 10px;cursor:pointer;display:inline-block;}.buttons [type="button"]{ min-width:49%;}#graphholder{ position:relative;padding-right:40px;}#graphholder .scale{ position:absolute;left:405px;font-size:9px;}#s0{ top:240px;}#s25{ top:187px;}#s50{ top:125px;}#s75{ top:62px;}#s100{ top:0px;}#graphcanvas{ border:1px solid #112D4E;}#topscoreholder{ font-size:.9rem;}#minimapholder{ position:relative;border:1px solid #112D4E;width:800px;height:200px;overflow:hidden;}.minimapmarker{ position:absolute;left:0;top:0;width:1px;height:200px;z-index:5;border-left:1px solid #112D4E;font-size:9px;padding-left:2px;}.silverdot{ position:absolute;left:0;top:0;width:1px;height:200px;z-index:4;}#minimapfog{ width:798px;height:198px;position:absolute;top:1px;right:1px;z-index:2;background-color:#fff;}#minimapcamera{ position:absolute;top:0px;left:1px;height:199px;width:50px;z-index:3;border:1px dashed #999;}.healthbar{ cursor:pointer;position:relative;border:1px solid #112D4E;width:100px;height:18px;padding:2px;margin-left:25px;}.healthbar .health{ height:100%;width:100%;background-color:#BE4747;}.healthbar .healthtext{ position:absolute;top:0;left:-20px;font-size:.8rem;}#cars{ margin-top:20px;}#explanation{ font-size:.8rem;margin-top:50px;color:#444;}table{ border-collapse:collapse;margin-bottom:5px;}table td, table th{ padding:0 5px;text-align:left;border-bottom:1px solid #CCC;}</style> </head> <body> <div class="clearfix"> <div class="float-left"> <canvas id="mainbox" width="800" height="400"></canvas> <div class="clearfix"> <div class="float-left"> <div id="graphholder"> <canvas id="graphcanvas" width="400" height="250"></canvas> <div class="scale" id="s100">250</div> <div class="scale" id="s75">187</div> <div class="scale" id="s50">125</div> <div class="scale" id="s25">62</div> <div class="scale" id="s0">0</div> </div> </div> <div class="float-left"> <div id="topscoreholder"> <input type="button" value="View top replay" onclick="cw_toggleGhostReplay(this)"><br> <div id="topscores"></div> </div> </div> </div> <div id="minimapholder"> <div id="minimapfog"></div> <canvas id="minimap" width="800" height="200"></canvas> <div id="minimapcamera"></div> </div> <div id="debug"></div> </div> <div class="float-left"> <div id="data"> <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank"> <input type="hidden" name="cmd" value="_s-xclick"> <input type="hidden" name="hosted_button_id" value="X8VB9NDYWQDPE"> <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!"> <img alt="" border="0" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" width="1" height="1"> </form> <br> <div class="buttons"> <input type="button" value="Save Population" onclick="saveProgress();"> <input type="button" value="Restore Saved Population" onclick="restoreProgress();"> <input type="button" value="Surprise!" onclick="toggleDisplay()"> <input type="button" value="New Population" onclick="cw_resetPopulation()"> </div> <div> <label>Create new world with seed</label><br> <input type="text" placeholder="Enter any string" id="newseed"> <input type="button" value="Go!" onclick="cw_confirmResetWorld()"> </div> <table> <tr> <td>Generation</td><td><div id="generation"></div></td> </tr> <tr> <td>Cars alive</td><td><div id="population"></div></td> </tr> <tr> <td>Distance</td><td><div id="distancemeter"></div></td> </tr> <tr> <td>Height</td><td><div id="heightmeter"></div></td> </tr> <tr> <td>Mutation rate:</td> <td> <select id="mutationrate" onchange="cw_setMutation(this.options[this.selectedIndex].value)"> <option value="0">0%</option> <option value="0.01">1%</option> <option value="0.02">2%</option> <option value="0.03">3%</option> <option value="0.04">4%</option> <option value="0.05" selected="selected">5%</option> <option value="0.1">10%</option> <option value="0.2">20%</option> <option value="0.3">30%</option> <option value="0.4">40%</option> <option value="0.5">50%</option> <option value="0.75">75%</option> <option value="1.0">100%</option> </select> </td> </tr> <tr> <td>Mutation size:</td> <td> <select id="mutationsize" onchange="cw_setMutationRange(this.options[this.selectedIndex].value)"> <option value="0">0%</option> <option value="0.01">1%</option> <option value="0.02">2%</option> <option value="0.03">3%</option> <option value="0.04">4%</option> <option value="0.05">5%</option> <option value="0.1">10%</option> <option value="0.2">20%</option> <option value="0.3">30%</option> <option value="0.4">40%</option> <option value="0.5">50%</option> <option value="0.75">75%</option> <option value="1.0" selected="selected">100%</option> </select> </td> </tr> <tr> <td>Floor:</td> <td> <select id="floor" onchange="cw_setMutableFloor(this.options[this.selectedIndex].value)"> <option value="0" selected="selected">fixed</option> <option value="1">mutable</option> </select> </td> </tr> <tr> <td>Gravity:</td> <td> <select id="gravity" onchange="cw_setGravity(this.options[this.selectedIndex].value)"> <option value="24.8">Jupiter (24.8)</option> <option value="11.2">Neptune (11.2)</option> <option value="10.4">Saturn (10.4)</option> <option value="9.81" selected="selected">Earth (9.81)</option> <option value="8.9">Venus (8.9)</option> <option value="8.7">Uranus (8.7)</option> <option value="3.7">Mars/Mercury (3.7)</option> <option value="1.6">Moon (1.6)</option> </select> </td> </tr> <tr> <td>Elite clones:</td> <td> <select id="elitesize" onchange="cw_setEliteSize(this.options[this.selectedIndex].value)"> <option value="0">0</option> <option value="1" selected="selected">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> </select> </td> </tr> </table> <br> <input type="button" value="Watch Leader" onclick="cw_setCameraTarget(-1)"> <div id="health"></div> <div id="cars"></div> </div> </div> </div> <div id="explanation"> <h3>But what is it?</h3> <p>The program uses a simple genetic algorithm to evolve random two-wheeled shapes into cars over generations. Loosely based on <a href="http://boxcar2d.com/">BoxCar2D</a>, but written from scratch, only using the same physics engine (<a href="http://box2d.org/">box2d</a>).<br> seedrandom.js written by <a href="http://davidbau.com/">David Bau</a>. (thanks!)</p> <h3>Controls</h3> <table> <tr> <th>Save Population</th> <td>Saves current population locally.</td> </tr> <tr> <th>Restore Saved Population</th> <td>Restore a previously saved population.</td> </tr> <tr> <th>Suprise</th> <td>Toggles drawing, makes the simulation faster.</td> </tr> <tr> <th>New Population</th> <td>Keeps the generated track and restarts the whole car population.</td> </tr> <tr> <th>Create new world with seed</th> <td>The same seed always creates the same track, so you can agree on a seed with your friends and compete. :) </td> </tr> <tr> <th>Mutation rate</th> <td>The chance that each gene in each individual will mutate to a random value when a new generation is born. </td> </tr> <tr> <th>Mutation size</th> <td>The range each gene can mutate into. Lower numbers mean the gene will have values closer to the original. </td> </tr> <tr> <th>Elite clones</th> <td>The top n cars that will be copied over to the next generation.</td> </tr> <tr> <th>View top replay</th> <td>Pause the current simulation and show the top performing car. Click a second time to resume simulation. </td> </tr> </table> <h3>Graph</h3> <table> <tr> <th>Red</th> <td>Top score in each generation</td> </tr> <tr> <th>Green</th> <td>Average of the top 10 cars in each generation</td> </tr> <tr> <th>Blue</th> <td>Average of the entire generation</td> </tr> </table> <h3>Genome</h3> <p> The genome consists of: </p> <ul> <li>Shape (8 genes, 1 per vertex)</li> <li>Wheel size (2 genes, 1 per wheel)</li> <li>Wheel position (2 genes, 1 per wheel)</li> <li>Wheel density (2 genes, 1 per wheel) darker wheels mean denser wheels</li> <li>Chassis density (1 gene) darker body means denser chassis</li> </ul> <h3>Blurb</h3> <p>This is not as deterministic as it should be, so your best car may not perform as well as it once did. The terrain gets more complex with distance.<br> I'm not in the mood to deal with checking if all scripts have loaded before running, so refresh the page if things seem whack.</p> <h3>GitHub</h3> <p>The code is now on a <a href="https://github.com/red42/HTML5_Genetic_Cars">GitHub repository</a>. Feel free to contribute!</p> <p>Written by <a href="http://rednuht.org">this guy</a>.<br> <a href="mailto:rednuht@rednuht.org">Send me food</a>.</p> </div> <div name="minimapmarker" class="minimapmarker"></div> <div name="healthbar" class="healthbar" onclick="cw_setCameraTarget(this.car_index)"> <div name="health" class="health"></div> <div name="healthtext" class="healthtext"></div> </div> <script>!function(n,r,t,o,e,f,i){function u(n){var r,o,e=this,f=n.length,i=0,u=e.i=e.j=e.m=0;for(e.S=[],e.c=[],f||(n=[f++]);i<t;)e.S[i]=i++;for(i=0;i<t;i++)r=e.S[i],u=g(u+r+n[i%f]),o=e.S[u],e.S[i]=o,e.S[u]=r;e.g=function(n){var r=e.S,o=g(e.i+1),f=r[o],i=g(e.j+f),u=r[i];r[o]=u,r[i]=f;for(var a=r[g(f+u)];--n;)o=g(o+1),f=r[o],i=g(i+f),u=r[i],r[o]=u,r[i]=f,a=a*t+r[g(f+u)];return e.i=o,e.j=i,a},e.g(t)}function a(n,r,t,o){if(t=[],r&&"object"==typeof n)for(o in n)if(o.indexOf("S")<5)try{t.push(a(n[o],r-1))}catch(n){}return t.length?t:""+n}function c(n,r,t,o){for(n+="",t=0,o=0;o<n.length;o++)r[g(o)]=g((t^=19*r[g(o)])+n.charCodeAt(o));n="";for(o in r)n+=String.fromCharCode(r[o]);return n}function g(n){return n&t-1}r.seedrandom=function(o,g){var h,S=[];return o=c(a(g?[o,n]:arguments.length?o:[(new Date).getTime(),n,window],3),S),h=new u(S),c(h.S,n),r.random=function(){for(var n=h.g(6),r=i,o=0;n<e;)n=(n+o)*t,r*=t,o=h.g(1);for(;n>=f;)n/=2,r/=2,o>>>=1;return(n+o)/r},o},i=r.pow(t,6),e=r.pow(2,e),f=2*e,c(r.random(),n)}([],Math,256,0,52);</script> <script>function extend(t,o){for(var e in o)t[e]=o[e]}function isInstanceOf(t,o){for(;"object"==typeof t;){if(t.constructor===o)return!0;t=t._super}return!1}var b2BoundValues=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2BoundValues.prototype.__constructor=function(){this.lowerValues=new Array,this.lowerValues[0]=0,this.lowerValues[1]=0,this.upperValues=new Array,this.upperValues[0]=0,this.upperValues[1]=0},b2BoundValues.prototype.__varz=function(){},b2BoundValues.prototype.lowerValues=null,b2BoundValues.prototype.upperValues=null;var b2PairManager=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2PairManager.prototype.__constructor=function(){this.m_pairs=new Array,this.m_pairBuffer=new Array,this.m_pairCount=0,this.m_pairBufferCount=0,this.m_freePair=null},b2PairManager.prototype.__varz=function(){},b2PairManager.prototype.AddPair=function(t,o){var e=t.pairs[o];return null!=e?e:(null==this.m_freePair&&(this.m_freePair=new b2Pair,this.m_pairs.push(this.m_freePair)),e=this.m_freePair,this.m_freePair=e.next,e.proxy1=t,e.proxy2=o,e.status=0,e.userData=null,e.next=null,t.pairs[o]=e,o.pairs[t]=e,++this.m_pairCount,e)},b2PairManager.prototype.RemovePair=function(t,o){var e=t.pairs[o];if(null==e)return null;var i=e.userData;return delete t.pairs[o],delete o.pairs[t],e.next=this.m_freePair,e.proxy1=null,e.proxy2=null,e.userData=null,e.status=0,this.m_freePair=e,--this.m_pairCount,i},b2PairManager.prototype.Find=function(t,o){return t.pairs[o]},b2PairManager.prototype.ValidateBuffer=function(){},b2PairManager.prototype.ValidateTable=function(){},b2PairManager.prototype.Initialize=function(t){this.m_broadPhase=t},b2PairManager.prototype.AddBufferedPair=function(t,o){var e=this.AddPair(t,o);0==e.IsBuffered()&&(e.SetBuffered(),this.m_pairBuffer[this.m_pairBufferCount]=e,++this.m_pairBufferCount),e.ClearRemoved(),b2BroadPhase.s_validate&&this.ValidateBuffer()},b2PairManager.prototype.RemoveBufferedPair=function(t,o){var e=this.Find(t,o);null!=e&&(0==e.IsBuffered()&&(e.SetBuffered(),this.m_pairBuffer[this.m_pairBufferCount]=e,++this.m_pairBufferCount),e.SetRemoved(),b2BroadPhase.s_validate&&this.ValidateBuffer())},b2PairManager.prototype.Commit=function(t){var o=0;for(o=0;o<this.m_pairBufferCount;++o){var e=this.m_pairBuffer[o];e.ClearBuffered();var i=e.proxy1,n=e.proxy2;e.IsRemoved()||0==e.IsFinal()&&t(i.userData,n.userData)}this.m_pairBufferCount=0,b2BroadPhase.s_validate&&this.ValidateTable()},b2PairManager.prototype.m_broadPhase=null,b2PairManager.prototype.m_pairs=null,b2PairManager.prototype.m_freePair=null,b2PairManager.prototype.m_pairCount=0,b2PairManager.prototype.m_pairBuffer=null,b2PairManager.prototype.m_pairBufferCount=0;var b2TimeStep=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2TimeStep.prototype.__constructor=function(){},b2TimeStep.prototype.__varz=function(){},b2TimeStep.prototype.Set=function(t){this.dt=t.dt,this.inv_dt=t.inv_dt,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.warmStarting=t.warmStarting},b2TimeStep.prototype.dt=null,b2TimeStep.prototype.inv_dt=null,b2TimeStep.prototype.dtRatio=null,b2TimeStep.prototype.velocityIterations=0,b2TimeStep.prototype.positionIterations=0,b2TimeStep.prototype.warmStarting=null;var b2Controller=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Controller.prototype.__constructor=function(){},b2Controller.prototype.__varz=function(){},b2Controller.prototype.Step=function(t){},b2Controller.prototype.Draw=function(t){},b2Controller.prototype.AddBody=function(t){var o=new b2ControllerEdge;o.controller=this,o.body=t,o.nextBody=m_bodyList,o.prevBody=null,m_bodyList=o,o.nextBody&&(o.nextBody.prevBody=o),m_bodyCount++,o.nextController=t.m_controllerList,o.prevController=null,t.m_controllerList=o,o.nextController&&(o.nextController.prevController=o),t.m_controllerCount++},b2Controller.prototype.RemoveBody=function(t){for(var o=t.m_controllerList;o&&o.controller!=this;)o=o.nextController;o.prevBody&&(o.prevBody.nextBody=o.nextBody),o.nextBody&&(o.nextBody.prevBody=o.prevBody),o.nextController&&(o.nextController.prevController=o.prevController),o.prevController&&(o.prevController.nextController=o.nextController),m_bodyList==o&&(m_bodyList=o.nextBody),t.m_controllerList==o&&(t.m_controllerList=o.nextController),t.m_controllerCount--,m_bodyCount--},b2Controller.prototype.Clear=function(){for(;m_bodyList;)this.RemoveBody(m_bodyList.body)},b2Controller.prototype.GetNext=function(){return this.m_next},b2Controller.prototype.GetWorld=function(){return this.m_world},b2Controller.prototype.GetBodyList=function(){return m_bodyList},b2Controller.prototype.m_next=null,b2Controller.prototype.m_prev=null,b2Controller.prototype.m_world=null;var b2GravityController=function(){b2Controller.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2GravityController.prototype,b2Controller.prototype),b2GravityController.prototype._super=b2Controller.prototype,b2GravityController.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2GravityController.prototype.__varz=function(){},b2GravityController.prototype.Step=function(t){var o=null,e=null,i=null,n=0,r=null,s=null,a=null,l=0,m=0,p=0,_=null;if(this.invSqr)for(o=m_bodyList;o;o=o.nextBody)for(e=o.body,i=e.GetWorldCenter(),n=e.GetMass(),r=m_bodyList;r!=o;r=r.nextBody)s=r.body,a=s.GetWorldCenter(),l=a.x-i.x,m=a.y-i.y,(p=l*l+m*m)<Number.MIN_VALUE||(_=new b2Vec2(l,m),_.Multiply(this.G/p/Math.sqrt(p)*n*s.GetMass()),e.IsAwake()&&e.ApplyForce(_,i),_.Multiply(-1),s.IsAwake()&&s.ApplyForce(_,a));else for(o=m_bodyList;o;o=o.nextBody)for(e=o.body,i=e.GetWorldCenter(),n=e.GetMass(),r=m_bodyList;r!=o;r=r.nextBody)s=r.body,a=s.GetWorldCenter(),l=a.x-i.x,m=a.y-i.y,(p=l*l+m*m)<Number.MIN_VALUE||(_=new b2Vec2(l,m),_.Multiply(this.G/p*n*s.GetMass()),e.IsAwake()&&e.ApplyForce(_,i),_.Multiply(-1),s.IsAwake()&&s.ApplyForce(_,a))},b2GravityController.prototype.G=1,b2GravityController.prototype.invSqr=!0;var b2DestructionListener=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DestructionListener.prototype.__constructor=function(){},b2DestructionListener.prototype.__varz=function(){},b2DestructionListener.prototype.SayGoodbyeJoint=function(t){},b2DestructionListener.prototype.SayGoodbyeFixture=function(t){};var b2ContactEdge=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactEdge.prototype.__constructor=function(){},b2ContactEdge.prototype.__varz=function(){},b2ContactEdge.prototype.other=null,b2ContactEdge.prototype.contact=null,b2ContactEdge.prototype.prev=null,b2ContactEdge.prototype.next=null;var b2EdgeChainDef=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2EdgeChainDef.prototype.__constructor=function(){this.vertexCount=0,this.isALoop=!0,this.vertices=[]},b2EdgeChainDef.prototype.__varz=function(){},b2EdgeChainDef.prototype.vertices=null,b2EdgeChainDef.prototype.vertexCount=null,b2EdgeChainDef.prototype.isALoop=null;var b2Vec2=function(t,o){2==arguments.length&&(this.x=t,this.y=o)};b2Vec2.Make=function(t,o){return new b2Vec2(t,o)},b2Vec2.prototype.SetZero=function(){this.x=0,this.y=0},b2Vec2.prototype.Set=function(t,o){this.x=t,this.y=o},b2Vec2.prototype.SetV=function(t){this.x=t.x,this.y=t.y},b2Vec2.prototype.GetNegative=function(){return new b2Vec2(-this.x,-this.y)},b2Vec2.prototype.NegativeSelf=function(){this.x=-this.x,this.y=-this.y},b2Vec2.prototype.Copy=function(){return new b2Vec2(this.x,this.y)},b2Vec2.prototype.Add=function(t){this.x+=t.x,this.y+=t.y},b2Vec2.prototype.Subtract=function(t){this.x-=t.x,this.y-=t.y},b2Vec2.prototype.Multiply=function(t){this.x*=t,this.y*=t},b2Vec2.prototype.MulM=function(t){var o=this.x;this.x=t.col1.x*o+t.col2.x*this.y,this.y=t.col1.y*o+t.col2.y*this.y},b2Vec2.prototype.MulTM=function(t){var o=b2Math.Dot(this,t.col1);this.y=b2Math.Dot(this,t.col2),this.x=o},b2Vec2.prototype.CrossVF=function(t){var o=this.x;this.x=t*this.y,this.y=-t*o},b2Vec2.prototype.CrossFV=function(t){var o=this.x;this.x=-t*this.y,this.y=t*o},b2Vec2.prototype.MinV=function(t){this.x=this.x<t.x?this.x:t.x,this.y=this.y<t.y?this.y:t.y},b2Vec2.prototype.MaxV=function(t){this.x=this.x>t.x?this.x:t.x,this.y=this.y>t.y?this.y:t.y},b2Vec2.prototype.Abs=function(){this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y)},b2Vec2.prototype.Length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},b2Vec2.prototype.LengthSquared=function(){return this.x*this.x+this.y*this.y},b2Vec2.prototype.Normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);if(t<Number.MIN_VALUE)return 0;var o=1/t;return this.x*=o,this.y*=o,t},b2Vec2.prototype.IsValid=function(){return b2Math.IsValid(this.x)&&b2Math.IsValid(this.y)},b2Vec2.prototype.x=0,b2Vec2.prototype.y=0;var b2Vec3=function(t,o,e){3==arguments.length&&(this.x=t,this.y=o,this.z=e)};b2Vec3.prototype.SetZero=function(){this.x=this.y=this.z=0},b2Vec3.prototype.Set=function(t,o,e){this.x=t,this.y=o,this.z=e},b2Vec3.prototype.SetV=function(t){this.x=t.x,this.y=t.y,this.z=t.z},b2Vec3.prototype.GetNegative=function(){return new b2Vec3(-this.x,-this.y,-this.z)},b2Vec3.prototype.NegativeSelf=function(){this.x=-this.x,this.y=-this.y,this.z=-this.z},b2Vec3.prototype.Copy=function(){return new b2Vec3(this.x,this.y,this.z)},b2Vec3.prototype.Add=function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},b2Vec3.prototype.Subtract=function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z},b2Vec3.prototype.Multiply=function(t){this.x*=t,this.y*=t,this.z*=t},b2Vec3.prototype.x=0,b2Vec3.prototype.y=0,b2Vec3.prototype.z=0;var b2DistanceProxy=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DistanceProxy.prototype.__constructor=function(){},b2DistanceProxy.prototype.__varz=function(){},b2DistanceProxy.prototype.Set=function(t){switch(t.GetType()){case b2Shape.e_circleShape:var o=t;this.m_vertices=new Array(1),this.m_vertices[0]=o.m_p,this.m_count=1,this.m_radius=o.m_radius;break;case b2Shape.e_polygonShape:var e=t;this.m_vertices=e.m_vertices,this.m_count=e.m_vertexCount,this.m_radius=e.m_radius;break;default:b2Settings.b2Assert(!1)}},b2DistanceProxy.prototype.GetSupport=function(t){for(var o=0,e=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,i=1;i<this.m_count;++i){var n=this.m_vertices[i].x*t.x+this.m_vertices[i].y*t.y;n>e&&(o=i,e=n)}return o},b2DistanceProxy.prototype.GetSupportVertex=function(t){for(var o=0,e=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,i=1;i<this.m_count;++i){var n=this.m_vertices[i].x*t.x+this.m_vertices[i].y*t.y;n>e&&(o=i,e=n)}return this.m_vertices[o]},b2DistanceProxy.prototype.GetVertexCount=function(){return this.m_count},b2DistanceProxy.prototype.GetVertex=function(t){return b2Settings.b2Assert(0<=t&&t<this.m_count),this.m_vertices[t]},b2DistanceProxy.prototype.m_vertices=null,b2DistanceProxy.prototype.m_count=0,b2DistanceProxy.prototype.m_radius=null;var b2ContactFactory=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactFactory.prototype.__constructor=function(){},b2ContactFactory.prototype.__varz=function(){this.InitializeRegisters()},b2ContactFactory.prototype.AddType=function(t,o,e,i){this.m_registers[e][i].createFcn=t,this.m_registers[e][i].destroyFcn=o,this.m_registers[e][i].primary=!0,e!=i&&(this.m_registers[i][e].createFcn=t,this.m_registers[i][e].destroyFcn=o,this.m_registers[i][e].primary=!1)},b2ContactFactory.prototype.InitializeRegisters=function(){this.m_registers=new Array(b2Shape.e_shapeTypeCount);for(var t=0;t<b2Shape.e_shapeTypeCount;t++){this.m_registers[t]=new Array(b2Shape.e_shapeTypeCount);for(var o=0;o<b2Shape.e_shapeTypeCount;o++)this.m_registers[t][o]=new b2ContactRegister}this.AddType(b2CircleContact.Create,b2CircleContact.Destroy,b2Shape.e_circleShape,b2Shape.e_circleShape),this.AddType(b2PolyAndCircleContact.Create,b2PolyAndCircleContact.Destroy,b2Shape.e_polygonShape,b2Shape.e_circleShape),this.AddType(b2PolygonContact.Create,b2PolygonContact.Destroy,b2Shape.e_polygonShape,b2Shape.e_polygonShape),this.AddType(b2EdgeAndCircleContact.Create,b2EdgeAndCircleContact.Destroy,b2Shape.e_edgeShape,b2Shape.e_circleShape),this.AddType(b2PolyAndEdgeContact.Create,b2PolyAndEdgeContact.Destroy,b2Shape.e_polygonShape,b2Shape.e_edgeShape)},b2ContactFactory.prototype.Create=function(t,o){var e,i=t.GetType(),n=o.GetType(),r=this.m_registers[i][n];if(r.pool)return e=r.pool,r.pool=e.m_next,r.poolCount--,r.primary?e.Reset(t,o):e.Reset(o,t),e;if(r=this.m_registers[n][i],r.pool)return e=r.pool,r.pool=e.m_next,r.poolCount--,r.primary?e.Reset(o,t):e.Reset(t,o),e;r=this.m_registers[i][n];var s=r.createFcn;return null!=s?r.primary?(e=s(this.m_allocator),e.Reset(t,o),e):(e=s(this.m_allocator),e.Reset(o,t),e):null},b2ContactFactory.prototype.Destroy=function(t){t.m_manifold.m_pointCount>0&&(t.m_fixtureA.m_body.SetAwake(!0),t.m_fixtureB.m_body.SetAwake(!0));var o=t.m_fixtureA.GetType(),e=t.m_fixtureB.GetType(),i=this.m_registers[o][e];i.poolCount++,t.m_next=i.pool,i.pool=t,(0,i.destroyFcn)(t,this.m_allocator)},b2ContactFactory.prototype.m_registers=null,b2ContactFactory.prototype.m_allocator=null;var b2ConstantAccelController=function(){b2Controller.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2ConstantAccelController.prototype,b2Controller.prototype),b2ConstantAccelController.prototype._super=b2Controller.prototype,b2ConstantAccelController.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2ConstantAccelController.prototype.__varz=function(){this.A=new b2Vec2(0,0)},b2ConstantAccelController.prototype.Step=function(t){for(var o=new b2Vec2(this.A.x*t.dt,this.A.y*t.dt),e=m_bodyList;e;e=e.nextBody){var i=e.body;i.IsAwake()&&i.SetLinearVelocity(new b2Vec2(i.GetLinearVelocity().x+o.x,i.GetLinearVelocity().y+o.y))}},b2ConstantAccelController.prototype.A=new b2Vec2(0,0);var b2SeparationFunction=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2SeparationFunction.prototype.__constructor=function(){},b2SeparationFunction.prototype.__varz=function(){this.m_localPoint=new b2Vec2,this.m_axis=new b2Vec2},b2SeparationFunction.e_points=1,b2SeparationFunction.e_faceA=2,b2SeparationFunction.e_faceB=4,b2SeparationFunction.prototype.Initialize=function(t,o,e,i,n){this.m_proxyA=o,this.m_proxyB=i;var r=t.count;b2Settings.b2Assert(0<r&&r<3);var s,a,l,m,p,_,c,h,y,u,b,x,d,f,v;if(1==r)this.m_type=b2SeparationFunction.e_points,s=this.m_proxyA.GetVertex(t.indexA[0]),m=this.m_proxyB.GetVertex(t.indexB[0]),f=s,d=e.R,c=e.position.x+(d.col1.x*f.x+d.col2.x*f.y),h=e.position.y+(d.col1.y*f.x+d.col2.y*f.y),f=m,d=n.R,y=n.position.x+(d.col1.x*f.x+d.col2.x*f.y),u=n.position.y+(d.col1.y*f.x+d.col2.y*f.y),this.m_axis.x=y-c,this.m_axis.y=u-h,this.m_axis.Normalize();else if(t.indexB[0]==t.indexB[1])this.m_type=b2SeparationFunction.e_faceA,a=this.m_proxyA.GetVertex(t.indexA[0]),l=this.m_proxyA.GetVertex(t.indexA[1]),m=this.m_proxyB.GetVertex(t.indexB[0]),this.m_localPoint.x=.5*(a.x+l.x),this.m_localPoint.y=.5*(a.y+l.y),this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(l,a),1),this.m_axis.Normalize(),f=this.m_axis,d=e.R,b=d.col1.x*f.x+d.col2.x*f.y,x=d.col1.y*f.x+d.col2.y*f.y,f=this.m_localPoint,d=e.R,c=e.position.x+(d.col1.x*f.x+d.col2.x*f.y),h=e.position.y+(d.col1.y*f.x+d.col2.y*f.y),f=m,d=n.R,y=n.position.x+(d.col1.x*f.x+d.col2.x*f.y),u=n.position.y+(d.col1.y*f.x+d.col2.y*f.y),(v=(y-c)*b+(u-h)*x)<0&&this.m_axis.NegativeSelf();else if(t.indexA[0]==t.indexA[0])this.m_type=b2SeparationFunction.e_faceB,p=this.m_proxyB.GetVertex(t.indexB[0]),_=this.m_proxyB.GetVertex(t.indexB[1]),s=this.m_proxyA.GetVertex(t.indexA[0]),this.m_localPoint.x=.5*(p.x+_.x),this.m_localPoint.y=.5*(p.y+_.y),this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(_,p),1),this.m_axis.Normalize(),f=this.m_axis,d=n.R,b=d.col1.x*f.x+d.col2.x*f.y,x=d.col1.y*f.x+d.col2.y*f.y,f=this.m_localPoint,d=n.R,y=n.position.x+(d.col1.x*f.x+d.col2.x*f.y),u=n.position.y+(d.col1.y*f.x+d.col2.y*f.y),f=s,d=e.R,c=e.position.x+(d.col1.x*f.x+d.col2.x*f.y),h=e.position.y+(d.col1.y*f.x+d.col2.y*f.y),(v=(c-y)*b+(h-u)*x)<0&&this.m_axis.NegativeSelf();else{a=this.m_proxyA.GetVertex(t.indexA[0]),l=this.m_proxyA.GetVertex(t.indexA[1]),p=this.m_proxyB.GetVertex(t.indexB[0]),_=this.m_proxyB.GetVertex(t.indexB[1]);var g=(b2Math.MulX(e,s),b2Math.MulMV(e.R,b2Math.SubtractVV(l,a))),w=(b2Math.MulX(n,m),b2Math.MulMV(n.R,b2Math.SubtractVV(_,p))),S=g.x*g.x+g.y*g.y,C=w.x*w.x+w.y*w.y,A=b2Math.SubtractVV(w,g),B=g.x*A.x+g.y*A.y,M=w.x*A.x+w.y*A.y,V=g.x*w.x+g.y*w.y,I=S*C-V*V;v=0,0!=I&&(v=b2Math.Clamp((V*M-B*C)/I,0,1));var P=(V*v+M)/C;P<0&&(P=0,v=b2Math.Clamp((V-B)/S,0,1)),s=new b2Vec2,s.x=a.x+v*(l.x-a.x),s.y=a.y+v*(l.y-a.y),m=new b2Vec2,m.x=p.x+v*(_.x-p.x),m.y=p.y+v*(_.y-p.y),0==v||1==v?(this.m_type=b2SeparationFunction.e_faceB,this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(_,p),1),this.m_axis.Normalize(),this.m_localPoint=m,f=this.m_axis,d=n.R,b=d.col1.x*f.x+d.col2.x*f.y,x=d.col1.y*f.x+d.col2.y*f.y,f=this.m_localPoint,d=n.R,y=n.position.x+(d.col1.x*f.x+d.col2.x*f.y),u=n.position.y+(d.col1.y*f.x+d.col2.y*f.y),f=s,d=e.R,c=e.position.x+(d.col1.x*f.x+d.col2.x*f.y),h=e.position.y+(d.col1.y*f.x+d.col2.y*f.y),(c-y)*b+(h-u)*x,v<0&&this.m_axis.NegativeSelf()):(this.m_type=b2SeparationFunction.e_faceA,this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(l,a),1),this.m_localPoint=s,f=this.m_axis,d=e.R,b=d.col1.x*f.x+d.col2.x*f.y,x=d.col1.y*f.x+d.col2.y*f.y,f=this.m_localPoint,d=e.R,c=e.position.x+(d.col1.x*f.x+d.col2.x*f.y),h=e.position.y+(d.col1.y*f.x+d.col2.y*f.y),f=m,d=n.R,y=n.position.x+(d.col1.x*f.x+d.col2.x*f.y),u=n.position.y+(d.col1.y*f.x+d.col2.y*f.y),(y-c)*b+(u-h)*x,v<0&&this.m_axis.NegativeSelf())}},b2SeparationFunction.prototype.Evaluate=function(t,o){var e,i,n,r,s,a,l;switch(this.m_type){case b2SeparationFunction.e_points:return e=b2Math.MulTMV(t.R,this.m_axis),i=b2Math.MulTMV(o.R,this.m_axis.GetNegative()),n=this.m_proxyA.GetSupportVertex(e),r=this.m_proxyB.GetSupportVertex(i),s=b2Math.MulX(t,n),a=b2Math.MulX(o,r),(a.x-s.x)*this.m_axis.x+(a.y-s.y)*this.m_axis.y;case b2SeparationFunction.e_faceA:return l=b2Math.MulMV(t.R,this.m_axis),s=b2Math.MulX(t,this.m_localPoint),i=b2Math.MulTMV(o.R,l.GetNegative()),r=this.m_proxyB.GetSupportVertex(i),a=b2Math.MulX(o,r),(a.x-s.x)*l.x+(a.y-s.y)*l.y;case b2SeparationFunction.e_faceB:return l=b2Math.MulMV(o.R,this.m_axis),a=b2Math.MulX(o,this.m_localPoint),e=b2Math.MulTMV(t.R,l.GetNegative()),n=this.m_proxyA.GetSupportVertex(e),s=b2Math.MulX(t,n),(s.x-a.x)*l.x+(s.y-a.y)*l.y;default:return b2Settings.b2Assert(!1),0}},b2SeparationFunction.prototype.m_proxyA=null,b2SeparationFunction.prototype.m_proxyB=null,b2SeparationFunction.prototype.m_type=0,b2SeparationFunction.prototype.m_localPoint=new b2Vec2,b2SeparationFunction.prototype.m_axis=new b2Vec2;var b2DynamicTreePair=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DynamicTreePair.prototype.__constructor=function(){},b2DynamicTreePair.prototype.__varz=function(){},b2DynamicTreePair.prototype.proxyA=null,b2DynamicTreePair.prototype.proxyB=null;var b2ContactConstraintPoint=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactConstraintPoint.prototype.__constructor=function(){},b2ContactConstraintPoint.prototype.__varz=function(){this.localPoint=new b2Vec2,this.rA=new b2Vec2,this.rB=new b2Vec2},b2ContactConstraintPoint.prototype.localPoint=new b2Vec2,b2ContactConstraintPoint.prototype.rA=new b2Vec2,b2ContactConstraintPoint.prototype.rB=new b2Vec2,b2ContactConstraintPoint.prototype.normalImpulse=null,b2ContactConstraintPoint.prototype.tangentImpulse=null,b2ContactConstraintPoint.prototype.normalMass=null,b2ContactConstraintPoint.prototype.tangentMass=null,b2ContactConstraintPoint.prototype.equalizedMass=null,b2ContactConstraintPoint.prototype.velocityBias=null;var b2ControllerEdge=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ControllerEdge.prototype.__constructor=function(){},b2ControllerEdge.prototype.__varz=function(){},b2ControllerEdge.prototype.controller=null,b2ControllerEdge.prototype.body=null,b2ControllerEdge.prototype.prevBody=null,b2ControllerEdge.prototype.nextBody=null,b2ControllerEdge.prototype.prevController=null,b2ControllerEdge.prototype.nextController=null;var b2DistanceInput=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DistanceInput.prototype.__constructor=function(){},b2DistanceInput.prototype.__varz=function(){},b2DistanceInput.prototype.proxyA=null,b2DistanceInput.prototype.proxyB=null,b2DistanceInput.prototype.transformA=null,b2DistanceInput.prototype.transformB=null,b2DistanceInput.prototype.useRadii=null;var b2Settings=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Settings.prototype.__constructor=function(){},b2Settings.prototype.__varz=function(){},b2Settings.b2MixFriction=function(t,o){return Math.sqrt(t*o)},b2Settings.b2MixRestitution=function(t,o){return t>o?t:o},b2Settings.b2Assert=function(t){if(!t)throw"Assertion Failed"},b2Settings.VERSION="2.1alpha",b2Settings.USHRT_MAX=65535,b2Settings.b2_pi=Math.PI,b2Settings.b2_maxManifoldPoints=2,b2Settings.b2_aabbExtension=.1,b2Settings.b2_aabbMultiplier=2,b2Settings.b2_polygonRadius=2*b2Settings.b2_linearSlop,b2Settings.b2_linearSlop=.005,b2Settings.b2_angularSlop=2/180*b2Settings.b2_pi,b2Settings.b2_toiSlop=8*b2Settings.b2_linearSlop,b2Settings.b2_maxTOIContactsPerIsland=32,b2Settings.b2_maxTOIJointsPerIsland=32,b2Settings.b2_velocityThreshold=1,b2Settings.b2_maxLinearCorrection=.2,b2Settings.b2_maxAngularCorrection=8/180*b2Settings.b2_pi,b2Settings.b2_maxTranslation=2,b2Settings.b2_maxTranslationSquared=b2Settings.b2_maxTranslation*b2Settings.b2_maxTranslation,b2Settings.b2_maxRotation=.5*b2Settings.b2_pi,b2Settings.b2_maxRotationSquared=b2Settings.b2_maxRotation*b2Settings.b2_maxRotation,b2Settings.b2_contactBaumgarte=.2,b2Settings.b2_timeToSleep=.5,b2Settings.b2_linearSleepTolerance=.01,b2Settings.b2_angularSleepTolerance=2/180*b2Settings.b2_pi;var b2Proxy=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Proxy.prototype.__constructor=function(){},b2Proxy.prototype.__varz=function(){this.lowerBounds=new Array(2),this.upperBounds=new Array(2),this.pairs=new Object},b2Proxy.prototype.IsValid=function(){return this.overlapCount!=b2BroadPhase.b2_invalid},b2Proxy.prototype.lowerBounds=new Array(2),b2Proxy.prototype.upperBounds=new Array(2),b2Proxy.prototype.overlapCount=0,b2Proxy.prototype.timeStamp=0,b2Proxy.prototype.pairs=new Object,b2Proxy.prototype.next=null,b2Proxy.prototype.userData=null;var b2Point=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Point.prototype.__constructor=function(){},b2Point.prototype.__varz=function(){this.p=new b2Vec2},b2Point.prototype.Support=function(t,o,e){return this.p},b2Point.prototype.GetFirstVertex=function(t){return this.p},b2Point.prototype.p=new b2Vec2;var b2WorldManifold=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2WorldManifold.prototype.__constructor=function(){this.m_points=new Array(b2Settings.b2_maxManifoldPoints);for(var t=0;t<b2Settings.b2_maxManifoldPoints;t++)this.m_points[t]=new b2Vec2},b2WorldManifold.prototype.__varz=function(){this.m_normal=new b2Vec2},b2WorldManifold.prototype.Initialize=function(t,o,e,i,n){if(0!=t.m_pointCount){var r,s,a,l,m,p,_,c,h=0;switch(t.m_type){case b2Manifold.e_circles:s=o.R,r=t.m_localPoint;var y=o.position.x+s.col1.x*r.x+s.col2.x*r.y,u=o.position.y+s.col1.y*r.x+s.col2.y*r.y;s=i.R,r=t.m_points[0].m_localPoint;var b=i.position.x+s.col1.x*r.x+s.col2.x*r.y,x=i.position.y+s.col1.y*r.x+s.col2.y*r.y,d=b-y,f=x-u,v=d*d+f*f;if(v>Number.MIN_VALUE*Number.MIN_VALUE){var g=Math.sqrt(v);this.m_normal.x=d/g,this.m_normal.y=f/g}else this.m_normal.x=1,this.m_normal.y=0;var w=y+e*this.m_normal.x,S=u+e*this.m_normal.y,C=b-n*this.m_normal.x,A=x-n*this.m_normal.y;this.m_points[0].x=.5*(w+C),this.m_points[0].y=.5*(S+A);break;case b2Manifold.e_faceA:for(s=o.R,r=t.m_localPlaneNormal,a=s.col1.x*r.x+s.col2.x*r.y,l=s.col1.y*r.x+s.col2.y*r.y,s=o.R,r=t.m_localPoint,m=o.position.x+s.col1.x*r.x+s.col2.x*r.y,p=o.position.y+s.col1.y*r.x+s.col2.y*r.y,this.m_normal.x=a,this.m_normal.y=l,h=0;h<t.m_pointCount;h++)s=i.R,r=t.m_points[h].m_localPoint,_=i.position.x+s.col1.x*r.x+s.col2.x*r.y,c=i.position.y+s.col1.y*r.x+s.col2.y*r.y,this.m_points[h].x=_+.5*(e-(_-m)*a-(c-p)*l-n)*a,this.m_points[h].y=c+.5*(e-(_-m)*a-(c-p)*l-n)*l;break;case b2Manifold.e_faceB:for(s=i.R,r=t.m_localPlaneNormal,a=s.col1.x*r.x+s.col2.x*r.y,l=s.col1.y*r.x+s.col2.y*r.y,s=i.R,r=t.m_localPoint,m=i.position.x+s.col1.x*r.x+s.col2.x*r.y,p=i.position.y+s.col1.y*r.x+s.col2.y*r.y,this.m_normal.x=-a,this.m_normal.y=-l,h=0;h<t.m_pointCount;h++)s=o.R,r=t.m_points[h].m_localPoint,_=o.position.x+s.col1.x*r.x+s.col2.x*r.y,c=o.position.y+s.col1.y*r.x+s.col2.y*r.y,this.m_points[h].x=_+.5*(n-(_-m)*a-(c-p)*l-e)*a,this.m_points[h].y=c+.5*(n-(_-m)*a-(c-p)*l-e)*l}}},b2WorldManifold.prototype.m_normal=new b2Vec2,b2WorldManifold.prototype.m_points=null;var b2RayCastOutput=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2RayCastOutput.prototype.__constructor=function(){},b2RayCastOutput.prototype.__varz=function(){this.normal=new b2Vec2},b2RayCastOutput.prototype.normal=new b2Vec2,b2RayCastOutput.prototype.fraction=null;var b2ConstantForceController=function(){b2Controller.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2ConstantForceController.prototype,b2Controller.prototype),b2ConstantForceController.prototype._super=b2Controller.prototype,b2ConstantForceController.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2ConstantForceController.prototype.__varz=function(){this.F=new b2Vec2(0,0)},b2ConstantForceController.prototype.Step=function(t){for(var o=m_bodyList;o;o=o.nextBody){var e=o.body;e.IsAwake()&&e.ApplyForce(this.F,e.GetWorldCenter())}},b2ConstantForceController.prototype.F=new b2Vec2(0,0);var b2MassData=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2MassData.prototype.__constructor=function(){},b2MassData.prototype.__varz=function(){this.center=new b2Vec2(0,0)},b2MassData.prototype.mass=0,b2MassData.prototype.center=new b2Vec2(0,0),b2MassData.prototype.I=0;var b2DynamicTree=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DynamicTree.prototype.__constructor=function(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0},b2DynamicTree.prototype.__varz=function(){},b2DynamicTree.prototype.AllocateNode=function(){if(this.m_freeList){var t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t}return new b2DynamicTreeNode},b2DynamicTree.prototype.FreeNode=function(t){t.parent=this.m_freeList,this.m_freeList=t},b2DynamicTree.prototype.InsertLeaf=function(t){if(++this.m_insertionCount,null==this.m_root)return this.m_root=t,void(this.m_root.parent=null);var o=t.aabb.GetCenter(),e=this.m_root;if(0==e.IsLeaf())do{var i=e.child1,n=e.child2,r=Math.abs((i.aabb.lowerBound.x+i.aabb.upperBound.x)/2-o.x)+Math.abs((i.aabb.lowerBound.y+i.aabb.upperBound.y)/2-o.y),s=Math.abs((n.aabb.lowerBound.x+n.aabb.upperBound.x)/2-o.x)+Math.abs((n.aabb.lowerBound.y+n.aabb.upperBound.y)/2-o.y);e=r<s?i:n}while(0==e.IsLeaf());var a=e.parent,l=this.AllocateNode();if(l.parent=a,l.userData=null,l.aabb.Combine(t.aabb,e.aabb),a){e.parent.child1==e?a.child1=l:a.child2=l,l.child1=e,l.child2=t,e.parent=l,t.parent=l;do{if(a.aabb.Contains(l.aabb))break;a.aabb.Combine(a.child1.aabb,a.child2.aabb),l=a,a=a.parent}while(a)}else l.child1=e,l.child2=t,e.parent=l,t.parent=l,this.m_root=l},b2DynamicTree.prototype.RemoveLeaf=function(t){if(t==this.m_root)return void(this.m_root=null);var o,e=t.parent,i=e.parent;if(o=e.child1==t?e.child2:e.child1,i)for(i.child1==e?i.child1=o:i.child2=o,o.parent=i,this.FreeNode(e);i;){var n=i.aabb;if(i.aabb=b2AABB.Combine(i.child1.aabb,i.child2.aabb),n.Contains(i.aabb))break;i=i.parent}else this.m_root=o,o.parent=null,this.FreeNode(e)},b2DynamicTree.prototype.CreateProxy=function(t,o){var e=this.AllocateNode(),i=b2Settings.b2_aabbExtension,n=b2Settings.b2_aabbExtension;return e.aabb.lowerBound.x=t.lowerBound.x-i,e.aabb.lowerBound.y=t.lowerBound.y-n,e.aabb.upperBound.x=t.upperBound.x+i,e.aabb.upperBound.y=t.upperBound.y+n,e.userData=o,this.InsertLeaf(e),e},b2DynamicTree.prototype.DestroyProxy=function(t){this.RemoveLeaf(t),this.FreeNode(t)},b2DynamicTree.prototype.MoveProxy=function(t,o,e){if(b2Settings.b2Assert(t.IsLeaf()),t.aabb.Contains(o))return!1;this.RemoveLeaf(t);var i=b2Settings.b2_aabbExtension+b2Settings.b2_aabbMultiplier*(e.x>0?e.x:-e.x),n=b2Settings.b2_aabbExtension+b2Settings.b2_aabbMultiplier*(e.y>0?e.y:-e.y);return t.aabb.lowerBound.x=o.lowerBound.x-i,t.aabb.lowerBound.y=o.lowerBound.y-n,t.aabb.upperBound.x=o.upperBound.x+i,t.aabb.upperBound.y=o.upperBound.y+n,this.InsertLeaf(t),!0},b2DynamicTree.prototype.Rebalance=function(t){if(null!=this.m_root)for(var o=0;o<t;o++){for(var e=this.m_root,i=0;0==e.IsLeaf();)e=this.m_path>>i&1?e.child2:e.child1,i=i+1&31;++this.m_path,this.RemoveLeaf(e),this.InsertLeaf(e)}},b2DynamicTree.prototype.GetFatAABB=function(t){return t.aabb},b2DynamicTree.prototype.GetUserData=function(t){return t.userData},b2DynamicTree.prototype.Query=function(t,o){if(null!=this.m_root){var e=new Array,i=0;for(e[i++]=this.m_root;i>0;){var n=e[--i];if(n.aabb.TestOverlap(o))if(n.IsLeaf()){var r=t(n);if(!r)return}else e[i++]=n.child1,e[i++]=n.child2}}},b2DynamicTree.prototype.RayCast=function(t,o){if(null!=this.m_root){var e=o.p1,i=o.p2,n=b2Math.SubtractVV(e,i);n.Normalize();var r,s,a=b2Math.CrossFV(1,n),l=b2Math.AbsV(a),m=o.maxFraction,p=new b2AABB;r=e.x+m*(i.x-e.x),s=e.y+m*(i.y-e.y),p.lowerBound.x=Math.min(e.x,r),p.lowerBound.y=Math.min(e.y,s),p.upperBound.x=Math.max(e.x,r),p.upperBound.y=Math.max(e.y,s);var _=new Array,c=0;for(_[c++]=this.m_root;c>0;){var h=_[--c];if(0!=h.aabb.TestOverlap(p)){var y=h.aabb.GetCenter(),u=h.aabb.GetExtents();if(!(Math.abs(a.x*(e.x-y.x)+a.y*(e.y-y.y))-l.x*u.x-l.y*u.y>0))if(h.IsLeaf()){var b=new b2RayCastInput;if(b.p1=o.p1,b.p2=o.p2,b.maxFraction=o.maxFraction,0==(m=t(b,h)))return;r=e.x+m*(i.x-e.x),s=e.y+m*(i.y-e.y),p.lowerBound.x=Math.min(e.x,r),p.lowerBound.y=Math.min(e.y,s),p.upperBound.x=Math.max(e.x,r),p.upperBound.y=Math.max(e.y,s)}else _[c++]=h.child1,_[c++]=h.child2}}}},b2DynamicTree.prototype.m_root=null,b2DynamicTree.prototype.m_freeList=null,b2DynamicTree.prototype.m_path=0,b2DynamicTree.prototype.m_insertionCount=0;var b2JointEdge=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2JointEdge.prototype.__constructor=function(){},b2JointEdge.prototype.__varz=function(){},b2JointEdge.prototype.other=null,b2JointEdge.prototype.joint=null,b2JointEdge.prototype.prev=null,b2JointEdge.prototype.next=null;var b2RayCastInput=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2RayCastInput.prototype.__constructor=function(){},b2RayCastInput.prototype.__varz=function(){this.p1=new b2Vec2,this.p2=new b2Vec2},b2RayCastInput.prototype.p1=new b2Vec2,b2RayCastInput.prototype.p2=new b2Vec2,b2RayCastInput.prototype.maxFraction=null;var Features=function(){this.__varz(),this.__constructor.apply(this,arguments)};Features.prototype.__constructor=function(){},Features.prototype.__varz=function(){},Features.prototype.__defineGetter__("referenceEdge",function(){return this._referenceEdge}),Features.prototype.__defineSetter__("referenceEdge",function(t){this._referenceEdge=t,this._m_id._key=4294967040&this._m_id._key|255&this._referenceEdge}),Features.prototype.__defineGetter__("incidentEdge",function(){return this._incidentEdge}),Features.prototype.__defineSetter__("incidentEdge",function(t){this._incidentEdge=t,this._m_id._key=4294902015&this._m_id._key|this._incidentEdge<<8&65280}),Features.prototype.__defineGetter__("incidentVertex",function(){return this._incidentVertex}),Features.prototype.__defineSetter__("incidentVertex",function(t){ this._incidentVertex=t,this._m_id._key=4278255615&this._m_id._key|this._incidentVertex<<16&16711680}),Features.prototype.__defineGetter__("flip",function(){return this._flip}),Features.prototype.__defineSetter__("flip",function(t){this._flip=t,this._m_id._key=16777215&this._m_id._key|this._flip<<24&4278190080}),Features.prototype._referenceEdge=0,Features.prototype._incidentEdge=0,Features.prototype._incidentVertex=0,Features.prototype._flip=0,Features.prototype._m_id=null;var b2FilterData=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2FilterData.prototype.__constructor=function(){},b2FilterData.prototype.__varz=function(){this.categoryBits=1,this.maskBits=65535},b2FilterData.prototype.Copy=function(){var t=new b2FilterData;return t.categoryBits=this.categoryBits,t.maskBits=this.maskBits,t.groupIndex=this.groupIndex,t},b2FilterData.prototype.categoryBits=1,b2FilterData.prototype.maskBits=65535,b2FilterData.prototype.groupIndex=0;var b2AABB=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2AABB.prototype.__constructor=function(){},b2AABB.prototype.__varz=function(){this.lowerBound=new b2Vec2,this.upperBound=new b2Vec2},b2AABB.Combine=function(t,o){var e=new b2AABB;return e.Combine(t,o),e},b2AABB.prototype.IsValid=function(){var t=this.upperBound.x-this.lowerBound.x,o=this.upperBound.y-this.lowerBound.y,e=t>=0&&o>=0;return e=e&&this.lowerBound.IsValid()&&this.upperBound.IsValid()},b2AABB.prototype.GetCenter=function(){return new b2Vec2((this.lowerBound.x+this.upperBound.x)/2,(this.lowerBound.y+this.upperBound.y)/2)},b2AABB.prototype.GetExtents=function(){return new b2Vec2((this.upperBound.x-this.lowerBound.x)/2,(this.upperBound.y-this.lowerBound.y)/2)},b2AABB.prototype.Contains=function(t){return this.lowerBound.x<=t.lowerBound.x&&this.lowerBound.y<=t.lowerBound.y&&t.upperBound.x<=this.upperBound.x&&t.upperBound.y<=this.upperBound.y},b2AABB.prototype.RayCast=function(t,o){var e,i,n,r,s,a=-Number.MAX_VALUE,l=Number.MAX_VALUE,m=o.p1.x,p=o.p1.y,_=o.p2.x-o.p1.x,c=o.p2.y-o.p1.y,h=Math.abs(_),y=Math.abs(c),u=t.normal;if(h<Number.MIN_VALUE){if(m<this.lowerBound.x||this.upperBound.x<m)return!1}else if(e=1/_,i=(this.lowerBound.x-m)*e,n=(this.upperBound.x-m)*e,s=-1,i>n&&(r=i,i=n,n=r,s=1),i>a&&(u.x=s,u.y=0,a=i),l=Math.min(l,n),a>l)return!1;if(y<Number.MIN_VALUE){if(p<this.lowerBound.y||this.upperBound.y<p)return!1}else if(e=1/c,i=(this.lowerBound.y-p)*e,n=(this.upperBound.y-p)*e,s=-1,i>n&&(r=i,i=n,n=r,s=1),i>a&&(u.y=s,u.x=0,a=i),l=Math.min(l,n),a>l)return!1;return t.fraction=a,!0},b2AABB.prototype.TestOverlap=function(t){var o=t.lowerBound.x-this.upperBound.x,e=t.lowerBound.y-this.upperBound.y,i=this.lowerBound.x-t.upperBound.x,n=this.lowerBound.y-t.upperBound.y;return!(o>0||e>0)&&!(i>0||n>0)},b2AABB.prototype.Combine=function(t,o){this.lowerBound.x=Math.min(t.lowerBound.x,o.lowerBound.x),this.lowerBound.y=Math.min(t.lowerBound.y,o.lowerBound.y),this.upperBound.x=Math.max(t.upperBound.x,o.upperBound.x),this.upperBound.y=Math.max(t.upperBound.y,o.upperBound.y)},b2AABB.prototype.lowerBound=new b2Vec2,b2AABB.prototype.upperBound=new b2Vec2;var b2Jacobian=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Jacobian.prototype.__constructor=function(){},b2Jacobian.prototype.__varz=function(){this.linearA=new b2Vec2,this.linearB=new b2Vec2},b2Jacobian.prototype.SetZero=function(){this.linearA.SetZero(),this.angularA=0,this.linearB.SetZero(),this.angularB=0},b2Jacobian.prototype.Set=function(t,o,e,i){this.linearA.SetV(t),this.angularA=o,this.linearB.SetV(e),this.angularB=i},b2Jacobian.prototype.Compute=function(t,o,e,i){return this.linearA.x*t.x+this.linearA.y*t.y+this.angularA*o+(this.linearB.x*e.x+this.linearB.y*e.y)+this.angularB*i},b2Jacobian.prototype.linearA=new b2Vec2,b2Jacobian.prototype.angularA=null,b2Jacobian.prototype.linearB=new b2Vec2,b2Jacobian.prototype.angularB=null;var b2Bound=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Bound.prototype.__constructor=function(){},b2Bound.prototype.__varz=function(){},b2Bound.prototype.IsLower=function(){return 0==(1&this.value)},b2Bound.prototype.IsUpper=function(){return 1==(1&this.value)},b2Bound.prototype.Swap=function(t){var o=this.value,e=this.proxy,i=this.stabbingCount;this.value=t.value,this.proxy=t.proxy,this.stabbingCount=t.stabbingCount,t.value=o,t.proxy=e,t.stabbingCount=i},b2Bound.prototype.value=0,b2Bound.prototype.proxy=null,b2Bound.prototype.stabbingCount=0;var b2SimplexVertex=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2SimplexVertex.prototype.__constructor=function(){},b2SimplexVertex.prototype.__varz=function(){},b2SimplexVertex.prototype.Set=function(t){this.wA.SetV(t.wA),this.wB.SetV(t.wB),this.w.SetV(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB},b2SimplexVertex.prototype.wA=null,b2SimplexVertex.prototype.wB=null,b2SimplexVertex.prototype.w=null,b2SimplexVertex.prototype.a=null,b2SimplexVertex.prototype.indexA=0,b2SimplexVertex.prototype.indexB=0;var b2Mat22=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Mat22.prototype.__constructor=function(){this.col1.x=this.col2.y=1},b2Mat22.prototype.__varz=function(){this.col1=new b2Vec2,this.col2=new b2Vec2},b2Mat22.FromAngle=function(t){var o=new b2Mat22;return o.Set(t),o},b2Mat22.FromVV=function(t,o){var e=new b2Mat22;return e.SetVV(t,o),e},b2Mat22.prototype.Set=function(t){var o=Math.cos(t),e=Math.sin(t);this.col1.x=o,this.col2.x=-e,this.col1.y=e,this.col2.y=o},b2Mat22.prototype.SetVV=function(t,o){this.col1.SetV(t),this.col2.SetV(o)},b2Mat22.prototype.Copy=function(){var t=new b2Mat22;return t.SetM(this),t},b2Mat22.prototype.SetM=function(t){this.col1.SetV(t.col1),this.col2.SetV(t.col2)},b2Mat22.prototype.AddM=function(t){this.col1.x+=t.col1.x,this.col1.y+=t.col1.y,this.col2.x+=t.col2.x,this.col2.y+=t.col2.y},b2Mat22.prototype.SetIdentity=function(){this.col1.x=1,this.col2.x=0,this.col1.y=0,this.col2.y=1},b2Mat22.prototype.SetZero=function(){this.col1.x=0,this.col2.x=0,this.col1.y=0,this.col2.y=0},b2Mat22.prototype.GetAngle=function(){return Math.atan2(this.col1.y,this.col1.x)},b2Mat22.prototype.GetInverse=function(t){var o=this.col1.x,e=this.col2.x,i=this.col1.y,n=this.col2.y,r=o*n-e*i;return 0!=r&&(r=1/r),t.col1.x=r*n,t.col2.x=-r*e,t.col1.y=-r*i,t.col2.y=r*o,t},b2Mat22.prototype.Solve=function(t,o,e){var i=this.col1.x,n=this.col2.x,r=this.col1.y,s=this.col2.y,a=i*s-n*r;return 0!=a&&(a=1/a),t.x=a*(s*o-n*e),t.y=a*(i*e-r*o),t},b2Mat22.prototype.Abs=function(){this.col1.Abs(),this.col2.Abs()},b2Mat22.prototype.col1=new b2Vec2,b2Mat22.prototype.col2=new b2Vec2;var b2SimplexCache=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2SimplexCache.prototype.__constructor=function(){},b2SimplexCache.prototype.__varz=function(){this.indexA=new Array(3),this.indexB=new Array(3)},b2SimplexCache.prototype.metric=null,b2SimplexCache.prototype.count=0,b2SimplexCache.prototype.indexA=new Array(3),b2SimplexCache.prototype.indexB=new Array(3);var b2Shape=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Shape.prototype.__constructor=function(){this.m_type=b2Shape.e_unknownShape,this.m_radius=b2Settings.b2_linearSlop},b2Shape.prototype.__varz=function(){},b2Shape.TestOverlap=function(t,o,e,i){var n=new b2DistanceInput;n.proxyA=new b2DistanceProxy,n.proxyA.Set(t),n.proxyB=new b2DistanceProxy,n.proxyB.Set(e),n.transformA=o,n.transformB=i,n.useRadii=!0;var r=new b2SimplexCache;r.count=0;var s=new b2DistanceOutput;return b2Distance.Distance(s,r,n),s.distance<10*Number.MIN_VALUE},b2Shape.e_hitCollide=1,b2Shape.e_missCollide=0,b2Shape.e_startsInsideCollide=-1,b2Shape.e_unknownShape=-1,b2Shape.e_circleShape=0,b2Shape.e_polygonShape=1,b2Shape.e_edgeShape=2,b2Shape.e_shapeTypeCount=3,b2Shape.prototype.Copy=function(){return null},b2Shape.prototype.Set=function(t){this.m_radius=t.m_radius},b2Shape.prototype.GetType=function(){return this.m_type},b2Shape.prototype.TestPoint=function(t,o){return!1},b2Shape.prototype.RayCast=function(t,o,e){return!1},b2Shape.prototype.ComputeAABB=function(t,o){},b2Shape.prototype.ComputeMass=function(t,o){},b2Shape.prototype.ComputeSubmergedArea=function(t,o,e,i){return 0},b2Shape.prototype.m_type=0,b2Shape.prototype.m_radius=null;var b2Segment=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Segment.prototype.__constructor=function(){},b2Segment.prototype.__varz=function(){this.p1=new b2Vec2,this.p2=new b2Vec2},b2Segment.prototype.TestSegment=function(t,o,e,i){var n=e.p1,r=e.p2.x-n.x,s=e.p2.y-n.y,a=this.p2.x-this.p1.x,l=this.p2.y-this.p1.y,m=l,p=-a,_=100*Number.MIN_VALUE,c=-(r*m+s*p);if(c>_){var h=n.x-this.p1.x,y=n.y-this.p1.y,u=h*m+y*p;if(0<=u&&u<=i*c){var b=-r*y+s*h;if(-_*c<=b&&b<=c*(1+_)){u/=c;var x=Math.sqrt(m*m+p*p);return m/=x,p/=x,t[0]=u,o.Set(m,p),!0}}}return!1},b2Segment.prototype.Extend=function(t){this.ExtendForward(t),this.ExtendBackward(t)},b2Segment.prototype.ExtendForward=function(t){var o=this.p2.x-this.p1.x,e=this.p2.y-this.p1.y,i=Math.min(o>0?(t.upperBound.x-this.p1.x)/o:o<0?(t.lowerBound.x-this.p1.x)/o:Number.POSITIVE_INFINITY,e>0?(t.upperBound.y-this.p1.y)/e:e<0?(t.lowerBound.y-this.p1.y)/e:Number.POSITIVE_INFINITY);this.p2.x=this.p1.x+o*i,this.p2.y=this.p1.y+e*i},b2Segment.prototype.ExtendBackward=function(t){var o=-this.p2.x+this.p1.x,e=-this.p2.y+this.p1.y,i=Math.min(o>0?(t.upperBound.x-this.p2.x)/o:o<0?(t.lowerBound.x-this.p2.x)/o:Number.POSITIVE_INFINITY,e>0?(t.upperBound.y-this.p2.y)/e:e<0?(t.lowerBound.y-this.p2.y)/e:Number.POSITIVE_INFINITY);this.p1.x=this.p2.x+o*i,this.p1.y=this.p2.y+e*i},b2Segment.prototype.p1=new b2Vec2,b2Segment.prototype.p2=new b2Vec2;var b2ContactRegister=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactRegister.prototype.__constructor=function(){},b2ContactRegister.prototype.__varz=function(){},b2ContactRegister.prototype.createFcn=null,b2ContactRegister.prototype.destroyFcn=null,b2ContactRegister.prototype.primary=null,b2ContactRegister.prototype.pool=null,b2ContactRegister.prototype.poolCount=0;var b2DebugDraw=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DebugDraw.prototype.__constructor=function(){this.m_drawFlags=0},b2DebugDraw.prototype.__varz=function(){},b2DebugDraw.e_shapeBit=1,b2DebugDraw.e_jointBit=2,b2DebugDraw.e_aabbBit=4,b2DebugDraw.e_pairBit=8,b2DebugDraw.e_centerOfMassBit=16,b2DebugDraw.e_controllerBit=32,b2DebugDraw.prototype.SetFlags=function(t){this.m_drawFlags=t},b2DebugDraw.prototype.GetFlags=function(){return this.m_drawFlags},b2DebugDraw.prototype.AppendFlags=function(t){this.m_drawFlags|=t},b2DebugDraw.prototype.ClearFlags=function(t){this.m_drawFlags&=~t},b2DebugDraw.prototype.SetSprite=function(t){this.m_sprite=t},b2DebugDraw.prototype.GetSprite=function(){return this.m_sprite},b2DebugDraw.prototype.SetDrawScale=function(t){this.m_drawScale=t},b2DebugDraw.prototype.GetDrawScale=function(){return this.m_drawScale},b2DebugDraw.prototype.SetLineThickness=function(t){this.m_lineThickness=t},b2DebugDraw.prototype.GetLineThickness=function(){return this.m_lineThickness},b2DebugDraw.prototype.SetAlpha=function(t){this.m_alpha=t},b2DebugDraw.prototype.GetAlpha=function(){return this.m_alpha},b2DebugDraw.prototype.SetFillAlpha=function(t){this.m_fillAlpha=t},b2DebugDraw.prototype.GetFillAlpha=function(){return this.m_fillAlpha},b2DebugDraw.prototype.SetXFormScale=function(t){this.m_xformScale=t},b2DebugDraw.prototype.GetXFormScale=function(){return this.m_xformScale},b2DebugDraw.prototype.Clear=function(){this.m_sprite.clearRect(0,0,this.m_sprite.canvas.width,this.m_sprite.canvas.height)},b2DebugDraw.prototype.Y=function(t){return this.m_sprite.canvas.height-t},b2DebugDraw.prototype.ToWorldPoint=function(t){return new b2Vec2(t.x/this.m_drawScale,this.Y(t.y)/this.m_drawScale)},b2DebugDraw.prototype.ColorStyle=function(t,o){return"rgba("+t.r+", "+t.g+", "+t.b+", "+o+")"},b2DebugDraw.prototype.DrawPolygon=function(t,o,e){this.m_sprite.graphics.lineStyle(this.m_lineThickness,e.color,this.m_alpha),this.m_sprite.graphics.moveTo(t[0].x*this.m_drawScale,t[0].y*this.m_drawScale);for(var i=1;i<o;i++)this.m_sprite.graphics.lineTo(t[i].x*this.m_drawScale,t[i].y*this.m_drawScale);this.m_sprite.graphics.lineTo(t[0].x*this.m_drawScale,t[0].y*this.m_drawScale)},b2DebugDraw.prototype.DrawSolidPolygon=function(t,o,e){this.m_sprite.strokeSyle=this.ColorStyle(e,this.m_alpha),this.m_sprite.lineWidth=this.m_lineThickness,this.m_sprite.fillStyle=this.ColorStyle(e,this.m_fillAlpha),this.m_sprite.beginPath(),this.m_sprite.moveTo(t[0].x*this.m_drawScale,this.Y(t[0].y*this.m_drawScale));for(var i=1;i<o;i++)this.m_sprite.lineTo(t[i].x*this.m_drawScale,this.Y(t[i].y*this.m_drawScale));this.m_sprite.lineTo(t[0].x*this.m_drawScale,this.Y(t[0].y*this.m_drawScale)),this.m_sprite.fill(),this.m_sprite.stroke(),this.m_sprite.closePath()},b2DebugDraw.prototype.DrawCircle=function(t,o,e){this.m_sprite.graphics.lineStyle(this.m_lineThickness,e.color,this.m_alpha),this.m_sprite.graphics.drawCircle(t.x*this.m_drawScale,t.y*this.m_drawScale,o*this.m_drawScale)},b2DebugDraw.prototype.DrawSolidCircle=function(t,o,e,i){this.m_sprite.strokeSyle=this.ColorStyle(i,this.m_alpha),this.m_sprite.lineWidth=this.m_lineThickness,this.m_sprite.fillStyle=this.ColorStyle(i,this.m_fillAlpha),this.m_sprite.beginPath(),this.m_sprite.arc(t.x*this.m_drawScale,this.Y(t.y*this.m_drawScale),o*this.m_drawScale,0,2*Math.PI,!0),this.m_sprite.fill(),this.m_sprite.stroke(),this.m_sprite.closePath()},b2DebugDraw.prototype.DrawSegment=function(t,o,e){this.m_sprite.lineWidth=this.m_lineThickness,this.m_sprite.strokeSyle=this.ColorStyle(e,this.m_alpha),this.m_sprite.beginPath(),this.m_sprite.moveTo(t.x*this.m_drawScale,this.Y(t.y*this.m_drawScale)),this.m_sprite.lineTo(o.x*this.m_drawScale,this.Y(o.y*this.m_drawScale)),this.m_sprite.stroke(),this.m_sprite.closePath()},b2DebugDraw.prototype.DrawTransform=function(t){this.m_sprite.lineWidth=this.m_lineThickness,this.m_sprite.strokeSyle=this.ColorStyle(new b2Color(255,0,0),this.m_alpha),this.m_sprite.beginPath(),this.m_sprite.moveTo(t.position.x*this.m_drawScale,this.Y(t.position.y*this.m_drawScale)),this.m_sprite.lineTo((t.position.x+this.m_xformScale*t.R.col1.x)*this.m_drawScale,this.Y((t.position.y+this.m_xformScale*t.R.col1.y)*this.m_drawScale)),this.m_sprite.stroke(),this.m_sprite.closePath(),this.m_sprite.strokeSyle=this.ColorStyle(new b2Color(0,255,0),this.m_alpha),this.m_sprite.beginPath(),this.m_sprite.moveTo(t.position.x*this.m_drawScale,this.Y(t.position.y*this.m_drawScale)),this.m_sprite.lineTo((t.position.x+this.m_xformScale*t.R.col2.x)*this.m_drawScale,this.Y((t.position.y+this.m_xformScale*t.R.col2.y)*this.m_drawScale)),this.m_sprite.stroke(),this.m_sprite.closePath()},b2DebugDraw.prototype.m_drawFlags=0,b2DebugDraw.prototype.m_sprite=null,b2DebugDraw.prototype.m_drawScale=1,b2DebugDraw.prototype.m_lineThickness=1,b2DebugDraw.prototype.m_alpha=1,b2DebugDraw.prototype.m_fillAlpha=1,b2DebugDraw.prototype.m_xformScale=1;var b2Sweep=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Sweep.prototype.__constructor=function(){},b2Sweep.prototype.__varz=function(){this.localCenter=new b2Vec2,this.c0=new b2Vec2,this.c=new b2Vec2},b2Sweep.prototype.Set=function(t){this.localCenter.SetV(t.localCenter),this.c0.SetV(t.c0),this.c.SetV(t.c),this.a0=t.a0,this.a=t.a,this.t0=t.t0},b2Sweep.prototype.Copy=function(){var t=new b2Sweep;return t.localCenter.SetV(this.localCenter),t.c0.SetV(this.c0),t.c.SetV(this.c),t.a0=this.a0,t.a=this.a,t.t0=this.t0,t},b2Sweep.prototype.GetTransform=function(t,o){t.position.x=(1-o)*this.c0.x+o*this.c.x,t.position.y=(1-o)*this.c0.y+o*this.c.y;var e=(1-o)*this.a0+o*this.a;t.R.Set(e);var i=t.R;t.position.x-=i.col1.x*this.localCenter.x+i.col2.x*this.localCenter.y,t.position.y-=i.col1.y*this.localCenter.x+i.col2.y*this.localCenter.y},b2Sweep.prototype.Advance=function(t){if(this.t0<t&&1-this.t0>Number.MIN_VALUE){var o=(t-this.t0)/(1-this.t0);this.c0.x=(1-o)*this.c0.x+o*this.c.x,this.c0.y=(1-o)*this.c0.y+o*this.c.y,this.a0=(1-o)*this.a0+o*this.a,this.t0=t}},b2Sweep.prototype.localCenter=new b2Vec2,b2Sweep.prototype.c0=new b2Vec2,b2Sweep.prototype.c=new b2Vec2,b2Sweep.prototype.a0=null,b2Sweep.prototype.a=null,b2Sweep.prototype.t0=null;var b2DistanceOutput=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DistanceOutput.prototype.__constructor=function(){},b2DistanceOutput.prototype.__varz=function(){this.pointA=new b2Vec2,this.pointB=new b2Vec2},b2DistanceOutput.prototype.pointA=new b2Vec2,b2DistanceOutput.prototype.pointB=new b2Vec2,b2DistanceOutput.prototype.distance=null,b2DistanceOutput.prototype.iterations=0;var b2Mat33=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Mat33.prototype.__constructor=function(t,o,e){t||o||e?(this.col1.SetV(t),this.col2.SetV(o),this.col3.SetV(e)):(this.col1.SetZero(),this.col2.SetZero(),this.col3.SetZero())},b2Mat33.prototype.__varz=function(){this.col1=new b2Vec3,this.col2=new b2Vec3,this.col3=new b2Vec3},b2Mat33.prototype.SetVVV=function(t,o,e){this.col1.SetV(t),this.col2.SetV(o),this.col3.SetV(e)},b2Mat33.prototype.Copy=function(){return new b2Mat33(this.col1,this.col2,this.col3)},b2Mat33.prototype.SetM=function(t){this.col1.SetV(t.col1),this.col2.SetV(t.col2),this.col3.SetV(t.col3)},b2Mat33.prototype.AddM=function(t){this.col1.x+=t.col1.x,this.col1.y+=t.col1.y,this.col1.z+=t.col1.z,this.col2.x+=t.col2.x,this.col2.y+=t.col2.y,this.col2.z+=t.col2.z,this.col3.x+=t.col3.x,this.col3.y+=t.col3.y,this.col3.z+=t.col3.z},b2Mat33.prototype.SetIdentity=function(){this.col1.x=1,this.col2.x=0,this.col3.x=0,this.col1.y=0,this.col2.y=1,this.col3.y=0,this.col1.z=0,this.col2.z=0,this.col3.z=1},b2Mat33.prototype.SetZero=function(){this.col1.x=0,this.col2.x=0,this.col3.x=0,this.col1.y=0,this.col2.y=0,this.col3.y=0,this.col1.z=0,this.col2.z=0,this.col3.z=0},b2Mat33.prototype.Solve22=function(t,o,e){var i=this.col1.x,n=this.col2.x,r=this.col1.y,s=this.col2.y,a=i*s-n*r;return 0!=a&&(a=1/a),t.x=a*(s*o-n*e),t.y=a*(i*e-r*o),t},b2Mat33.prototype.Solve33=function(t,o,e,i){var n=this.col1.x,r=this.col1.y,s=this.col1.z,a=this.col2.x,l=this.col2.y,m=this.col2.z,p=this.col3.x,_=this.col3.y,c=this.col3.z,h=n*(l*c-m*_)+r*(m*p-a*c)+s*(a*_-l*p);return 0!=h&&(h=1/h),t.x=h*(o*(l*c-m*_)+e*(m*p-a*c)+i*(a*_-l*p)),t.y=h*(n*(e*c-i*_)+r*(i*p-o*c)+s*(o*_-e*p)),t.z=h*(n*(l*i-m*e)+r*(m*o-a*i)+s*(a*e-l*o)),t},b2Mat33.prototype.col1=new b2Vec3,b2Mat33.prototype.col2=new b2Vec3,b2Mat33.prototype.col3=new b2Vec3;var b2PositionSolverManifold=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2PositionSolverManifold.prototype.__constructor=function(){this.m_normal=new b2Vec2,this.m_separations=new Array(b2Settings.b2_maxManifoldPoints),this.m_points=new Array(b2Settings.b2_maxManifoldPoints);for(var t=0;t<b2Settings.b2_maxManifoldPoints;t++)this.m_points[t]=new b2Vec2},b2PositionSolverManifold.prototype.__varz=function(){},b2PositionSolverManifold.circlePointA=new b2Vec2,b2PositionSolverManifold.circlePointB=new b2Vec2,b2PositionSolverManifold.prototype.Initialize=function(t){b2Settings.b2Assert(t.pointCount>0);var o,e,i,n,r,s,a=0;switch(t.type){case b2Manifold.e_circles:i=t.bodyA.m_xf.R,n=t.localPoint;var l=t.bodyA.m_xf.position.x+(i.col1.x*n.x+i.col2.x*n.y),m=t.bodyA.m_xf.position.y+(i.col1.y*n.x+i.col2.y*n.y);i=t.bodyB.m_xf.R,n=t.points[0].localPoint;var p=t.bodyB.m_xf.position.x+(i.col1.x*n.x+i.col2.x*n.y),_=t.bodyB.m_xf.position.y+(i.col1.y*n.x+i.col2.y*n.y),c=p-l,h=_-m,y=c*c+h*h;if(y>Number.MIN_VALUE*Number.MIN_VALUE){var u=Math.sqrt(y);this.m_normal.x=c/u,this.m_normal.y=h/u}else this.m_normal.x=1,this.m_normal.y=0;this.m_points[0].x=.5*(l+p),this.m_points[0].y=.5*(m+_),this.m_separations[0]=c*this.m_normal.x+h*this.m_normal.y-t.radius;break;case b2Manifold.e_faceA:for(i=t.bodyA.m_xf.R,n=t.localPlaneNormal,this.m_normal.x=i.col1.x*n.x+i.col2.x*n.y,this.m_normal.y=i.col1.y*n.x+i.col2.y*n.y,i=t.bodyA.m_xf.R,n=t.localPoint,r=t.bodyA.m_xf.position.x+(i.col1.x*n.x+i.col2.x*n.y),s=t.bodyA.m_xf.position.y+(i.col1.y*n.x+i.col2.y*n.y),i=t.bodyB.m_xf.R,a=0;a<t.pointCount;++a)n=t.points[a].localPoint,o=t.bodyB.m_xf.position.x+(i.col1.x*n.x+i.col2.x*n.y),e=t.bodyB.m_xf.position.y+(i.col1.y*n.x+i.col2.y*n.y),this.m_separations[a]=(o-r)*this.m_normal.x+(e-s)*this.m_normal.y-t.radius,this.m_points[a].x=o,this.m_points[a].y=e;break;case b2Manifold.e_faceB:for(i=t.bodyB.m_xf.R,n=t.localPlaneNormal,this.m_normal.x=i.col1.x*n.x+i.col2.x*n.y,this.m_normal.y=i.col1.y*n.x+i.col2.y*n.y,i=t.bodyB.m_xf.R,n=t.localPoint,r=t.bodyB.m_xf.position.x+(i.col1.x*n.x+i.col2.x*n.y),s=t.bodyB.m_xf.position.y+(i.col1.y*n.x+i.col2.y*n.y),i=t.bodyA.m_xf.R,a=0;a<t.pointCount;++a)n=t.points[a].localPoint,o=t.bodyA.m_xf.position.x+(i.col1.x*n.x+i.col2.x*n.y),e=t.bodyA.m_xf.position.y+(i.col1.y*n.x+i.col2.y*n.y),this.m_separations[a]=(o-r)*this.m_normal.x+(e-s)*this.m_normal.y-t.radius,this.m_points[a].Set(o,e);this.m_normal.x*=-1,this.m_normal.y*=-1}},b2PositionSolverManifold.prototype.m_normal=null,b2PositionSolverManifold.prototype.m_points=null,b2PositionSolverManifold.prototype.m_separations=null;var b2OBB=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2OBB.prototype.__constructor=function(){},b2OBB.prototype.__varz=function(){this.R=new b2Mat22,this.center=new b2Vec2,this.extents=new b2Vec2},b2OBB.prototype.R=new b2Mat22,b2OBB.prototype.center=new b2Vec2,b2OBB.prototype.extents=new b2Vec2;var b2Pair=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Pair.prototype.__constructor=function(){},b2Pair.prototype.__varz=function(){},b2Pair.b2_nullProxy=b2Settings.USHRT_MAX,b2Pair.e_pairBuffered=1,b2Pair.e_pairRemoved=2,b2Pair.e_pairFinal=4,b2Pair.prototype.SetBuffered=function(){this.status|=b2Pair.e_pairBuffered},b2Pair.prototype.ClearBuffered=function(){this.status&=~b2Pair.e_pairBuffered},b2Pair.prototype.IsBuffered=function(){return(this.status&b2Pair.e_pairBuffered)==b2Pair.e_pairBuffered},b2Pair.prototype.SetRemoved=function(){this.status|=b2Pair.e_pairRemoved},b2Pair.prototype.ClearRemoved=function(){this.status&=~b2Pair.e_pairRemoved},b2Pair.prototype.IsRemoved=function(){return(this.status&b2Pair.e_pairRemoved)==b2Pair.e_pairRemoved},b2Pair.prototype.SetFinal=function(){this.status|=b2Pair.e_pairFinal},b2Pair.prototype.IsFinal=function(){return(this.status&b2Pair.e_pairFinal)==b2Pair.e_pairFinal},b2Pair.prototype.userData=null,b2Pair.prototype.proxy1=null,b2Pair.prototype.proxy2=null,b2Pair.prototype.next=null,b2Pair.prototype.status=0;var b2FixtureDef=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2FixtureDef.prototype.__constructor=function(){this.shape=null,this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.filter.categoryBits=1,this.filter.maskBits=65535,this.filter.groupIndex=0,this.isSensor=!1},b2FixtureDef.prototype.__varz=function(){this.filter=new b2FilterData},b2FixtureDef.prototype.shape=null,b2FixtureDef.prototype.userData=null,b2FixtureDef.prototype.friction=null,b2FixtureDef.prototype.restitution=null,b2FixtureDef.prototype.density=null,b2FixtureDef.prototype.isSensor=null,b2FixtureDef.prototype.filter=new b2FilterData;var b2ContactID=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactID.prototype.__constructor=function(){this.features._m_id=this},b2ContactID.prototype.__varz=function(){this.features=new Features},b2ContactID.prototype.Set=function(t){key=t._key},b2ContactID.prototype.Copy=function(){var t=new b2ContactID;return t.key=key,t},b2ContactID.prototype.__defineSetter__("key",function(){return this._key}),b2ContactID.prototype.__defineSetter__("key",function(t){this._key=t,this.features._referenceEdge=255&this._key,this.features._incidentEdge=(65280&this._key)>>8&255,this.features._incidentVertex=(16711680&this._key)>>16&255,this.features._flip=(4278190080&this._key)>>24&255}),b2ContactID.prototype._key=0,b2ContactID.prototype.features=new Features;var b2Transform=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Transform.prototype.__constructor=function(t,o){t&&(this.position.SetV(t),this.R.SetM(o))},b2Transform.prototype.__varz=function(){this.position=new b2Vec2,this.R=new b2Mat22},b2Transform.prototype.Initialize=function(t,o){this.position.SetV(t),this.R.SetM(o)},b2Transform.prototype.SetIdentity=function(){this.position.SetZero(),this.R.SetIdentity()},b2Transform.prototype.Set=function(t){this.position.SetV(t.position),this.R.SetM(t.R)},b2Transform.prototype.GetAngle=function(){return Math.atan2(this.R.col1.y,this.R.col1.x)},b2Transform.prototype.position=new b2Vec2,b2Transform.prototype.R=new b2Mat22;var b2EdgeShape=function(){b2Shape.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2EdgeShape.prototype,b2Shape.prototype),b2EdgeShape.prototype._super=b2Shape.prototype,b2EdgeShape.prototype.__constructor=function(t,o){this._super.__constructor.apply(this,[]),this.m_type=b2Shape.e_edgeShape,this.m_prevEdge=null,this.m_nextEdge=null,this.m_v1=t,this.m_v2=o,this.m_direction.Set(this.m_v2.x-this.m_v1.x,this.m_v2.y-this.m_v1.y),this.m_length=this.m_direction.Normalize(),this.m_normal.Set(this.m_direction.y,-this.m_direction.x),this.m_coreV1.Set(-b2Settings.b2_toiSlop*(this.m_normal.x-this.m_direction.x)+this.m_v1.x,-b2Settings.b2_toiSlop*(this.m_normal.y-this.m_direction.y)+this.m_v1.y),this.m_coreV2.Set(-b2Settings.b2_toiSlop*(this.m_normal.x+this.m_direction.x)+this.m_v2.x,-b2Settings.b2_toiSlop*(this.m_normal.y+this.m_direction.y)+this.m_v2.y),this.m_cornerDir1=this.m_normal,this.m_cornerDir2.Set(-this.m_normal.x,-this.m_normal.y)},b2EdgeShape.prototype.__varz=function(){this.s_supportVec=new b2Vec2,this.m_v1=new b2Vec2,this.m_v2=new b2Vec2,this.m_coreV1=new b2Vec2,this.m_coreV2=new b2Vec2,this.m_normal=new b2Vec2,this.m_direction=new b2Vec2,this.m_cornerDir1=new b2Vec2,this.m_cornerDir2=new b2Vec2},b2EdgeShape.prototype.SetPrevEdge=function(t,o,e,i){this.m_prevEdge=t,this.m_coreV1=o,this.m_cornerDir1=e,this.m_cornerConvex1=i},b2EdgeShape.prototype.SetNextEdge=function(t,o,e,i){this.m_nextEdge=t,this.m_coreV2=o,this.m_cornerDir2=e,this.m_cornerConvex2=i},b2EdgeShape.prototype.TestPoint=function(t,o){return!1},b2EdgeShape.prototype.RayCast=function(t,o,e){var i,n=o.p2.x-o.p1.x,r=o.p2.y-o.p1.y;i=e.R;var s=e.position.x+(i.col1.x*this.m_v1.x+i.col2.x*this.m_v1.y),a=e.position.y+(i.col1.y*this.m_v1.x+i.col2.y*this.m_v1.y),l=e.position.y+(i.col1.y*this.m_v2.x+i.col2.y*this.m_v2.y)-a,m=-(e.position.x+(i.col1.x*this.m_v2.x+i.col2.x*this.m_v2.y)-s),p=100*Number.MIN_VALUE,_=-(n*l+r*m);if(_>p){var c=o.p1.x-s,h=o.p1.y-a,y=c*l+h*m;if(0<=y&&y<=o.maxFraction*_){var u=-n*h+r*c;if(-p*_<=u&&u<=_*(1+p)){y/=_,t.fraction=y;var b=Math.sqrt(l*l+m*m);return t.normal.x=l/b,t.normal.y=m/b,!0}}}return!1},b2EdgeShape.prototype.ComputeAABB=function(t,o){var e=o.R,i=o.position.x+(e.col1.x*this.m_v1.x+e.col2.x*this.m_v1.y),n=o.position.y+(e.col1.y*this.m_v1.x+e.col2.y*this.m_v1.y),r=o.position.x+(e.col1.x*this.m_v2.x+e.col2.x*this.m_v2.y),s=o.position.y+(e.col1.y*this.m_v2.x+e.col2.y*this.m_v2.y);i<r?(t.lowerBound.x=i,t.upperBound.x=r):(t.lowerBound.x=r,t.upperBound.x=i),n<s?(t.lowerBound.y=n,t.upperBound.y=s):(t.lowerBound.y=s,t.upperBound.y=n)},b2EdgeShape.prototype.ComputeMass=function(t,o){t.mass=0,t.center.SetV(this.m_v1),t.I=0},b2EdgeShape.prototype.ComputeSubmergedArea=function(t,o,e,i){var n=new b2Vec2(t.x*o,t.y*o),r=b2Math.MulX(e,this.m_v1),s=b2Math.MulX(e,this.m_v2),a=b2Math.Dot(t,r)-o,l=b2Math.Dot(t,s)-o;if(a>0){if(l>0)return 0;r.x=-l/(a-l)*r.x+a/(a-l)*s.x,r.y=-l/(a-l)*r.y+a/(a-l)*s.y}else l>0&&(s.x=-l/(a-l)*r.x+a/(a-l)*s.x,s.y=-l/(a-l)*r.y+a/(a-l)*s.y);return i.x=(n.x+r.x+s.x)/3,i.y=(n.y+r.y+s.y)/3,.5*((r.x-n.x)*(s.y-n.y)-(r.y-n.y)*(s.x-n.x))},b2EdgeShape.prototype.GetLength=function(){return this.m_length},b2EdgeShape.prototype.GetVertex1=function(){return this.m_v1},b2EdgeShape.prototype.GetVertex2=function(){return this.m_v2},b2EdgeShape.prototype.GetCoreVertex1=function(){return this.m_coreV1},b2EdgeShape.prototype.GetCoreVertex2=function(){return this.m_coreV2},b2EdgeShape.prototype.GetNormalVector=function(){return this.m_normal},b2EdgeShape.prototype.GetDirectionVector=function(){return this.m_direction},b2EdgeShape.prototype.GetCorner1Vector=function(){return this.m_cornerDir1},b2EdgeShape.prototype.GetCorner2Vector=function(){return this.m_cornerDir2},b2EdgeShape.prototype.Corner1IsConvex=function(){return this.m_cornerConvex1},b2EdgeShape.prototype.Corner2IsConvex=function(){return this.m_cornerConvex2},b2EdgeShape.prototype.GetFirstVertex=function(t){var o=t.R;return new b2Vec2(t.position.x+(o.col1.x*this.m_coreV1.x+o.col2.x*this.m_coreV1.y),t.position.y+(o.col1.y*this.m_coreV1.x+o.col2.y*this.m_coreV1.y))},b2EdgeShape.prototype.GetNextEdge=function(){return this.m_nextEdge},b2EdgeShape.prototype.GetPrevEdge=function(){return this.m_prevEdge},b2EdgeShape.prototype.Support=function(t,o,e){var i=t.R,n=t.position.x+(i.col1.x*this.m_coreV1.x+i.col2.x*this.m_coreV1.y),r=t.position.y+(i.col1.y*this.m_coreV1.x+i.col2.y*this.m_coreV1.y),s=t.position.x+(i.col1.x*this.m_coreV2.x+i.col2.x*this.m_coreV2.y),a=t.position.y+(i.col1.y*this.m_coreV2.x+i.col2.y*this.m_coreV2.y);return n*o+r*e>s*o+a*e?(this.s_supportVec.x=n,this.s_supportVec.y=r):(this.s_supportVec.x=s,this.s_supportVec.y=a),this.s_supportVec},b2EdgeShape.prototype.s_supportVec=new b2Vec2,b2EdgeShape.prototype.m_v1=new b2Vec2,b2EdgeShape.prototype.m_v2=new b2Vec2,b2EdgeShape.prototype.m_coreV1=new b2Vec2,b2EdgeShape.prototype.m_coreV2=new b2Vec2,b2EdgeShape.prototype.m_length=null,b2EdgeShape.prototype.m_normal=new b2Vec2,b2EdgeShape.prototype.m_direction=new b2Vec2,b2EdgeShape.prototype.m_cornerDir1=new b2Vec2,b2EdgeShape.prototype.m_cornerDir2=new b2Vec2,b2EdgeShape.prototype.m_cornerConvex1=null,b2EdgeShape.prototype.m_cornerConvex2=null,b2EdgeShape.prototype.m_nextEdge=null,b2EdgeShape.prototype.m_prevEdge=null;var b2BuoyancyController=function(){b2Controller.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2BuoyancyController.prototype,b2Controller.prototype),b2BuoyancyController.prototype._super=b2Controller.prototype,b2BuoyancyController.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2BuoyancyController.prototype.__varz=function(){this.normal=new b2Vec2(0,-1),this.velocity=new b2Vec2(0,0)},b2BuoyancyController.prototype.Step=function(t){if(m_bodyList){this.useWorldGravity&&(this.gravity=this.GetWorld().GetGravity().Copy());for(var o=m_bodyList;o;o=o.nextBody){var e=o.body;if(0!=e.IsAwake()){for(var i=new b2Vec2,n=new b2Vec2,r=0,s=0,a=e.GetFixtureList();a;a=a.GetNext()){var l=new b2Vec2,m=a.GetShape().ComputeSubmergedArea(this.normal,this.offset,e.GetTransform(),l);r+=m,i.x+=m*l.x,i.y+=m*l.y;var p;p=(this.useDensity,1),s+=m*p,n.x+=m*l.x*p,n.y+=m*l.y*p}if(i.x/=r,i.y/=r,n.x/=s,n.y/=s,!(r<Number.MIN_VALUE)){var _=this.gravity.GetNegative();_.Multiply(this.density*r),e.ApplyForce(_,n);var c=e.GetLinearVelocityFromWorldPoint(i);c.Subtract(this.velocity),c.Multiply(-this.linearDrag*r),e.ApplyForce(c,i),e.ApplyTorque(-e.GetInertia()/e.GetMass()*r*e.GetAngularVelocity()*this.angularDrag)}}}}},b2BuoyancyController.prototype.Draw=function(t){var o=1e3,e=new b2Vec2,i=new b2Vec2;e.x=this.normal.x*this.offset+this.normal.y*o,e.y=this.normal.y*this.offset-this.normal.x*o,i.x=this.normal.x*this.offset-this.normal.y*o,i.y=this.normal.y*this.offset+this.normal.x*o;var n=new b2Color(0,0,1);t.DrawSegment(e,i,n)},b2BuoyancyController.prototype.normal=new b2Vec2(0,-1),b2BuoyancyController.prototype.offset=0,b2BuoyancyController.prototype.density=0,b2BuoyancyController.prototype.velocity=new b2Vec2(0,0),b2BuoyancyController.prototype.linearDrag=2,b2BuoyancyController.prototype.angularDrag=1,b2BuoyancyController.prototype.useDensity=!1,b2BuoyancyController.prototype.useWorldGravity=!0,b2BuoyancyController.prototype.gravity=null ;var b2Body=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Body.prototype.__constructor=function(t,o){this.m_flags=0,t.bullet&&(this.m_flags|=b2Body.e_bulletFlag),t.fixedRotation&&(this.m_flags|=b2Body.e_fixedRotationFlag),t.allowSleep&&(this.m_flags|=b2Body.e_allowSleepFlag),t.awake&&(this.m_flags|=b2Body.e_awakeFlag),t.active&&(this.m_flags|=b2Body.e_activeFlag),this.m_world=o,this.m_xf.position.SetV(t.position),this.m_xf.R.Set(t.angle),this.m_sweep.localCenter.SetZero(),this.m_sweep.t0=1,this.m_sweep.a0=this.m_sweep.a=t.angle;var e=this.m_xf.R,i=this.m_sweep.localCenter;this.m_sweep.c.x=e.col1.x*i.x+e.col2.x*i.y,this.m_sweep.c.y=e.col1.y*i.x+e.col2.y*i.y,this.m_sweep.c.x+=this.m_xf.position.x,this.m_sweep.c.y+=this.m_xf.position.y,this.m_sweep.c0.SetV(this.m_sweep.c),this.m_jointList=null,this.m_controllerList=null,this.m_contactList=null,this.m_controllerCount=0,this.m_prev=null,this.m_next=null,this.m_linearVelocity.SetV(t.linearVelocity),this.m_angularVelocity=t.angularVelocity,this.m_linearDamping=t.linearDamping,this.m_angularDamping=t.angularDamping,this.m_force.Set(0,0),this.m_torque=0,this.m_sleepTime=0,this.m_type=t.type,this.m_type==b2Body.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_inertiaScale=t.inertiaScale,this.m_userData=t.userData,this.m_fixtureList=null,this.m_fixtureCount=0},b2Body.prototype.__varz=function(){this.m_xf=new b2Transform,this.m_sweep=new b2Sweep,this.m_linearVelocity=new b2Vec2,this.m_force=new b2Vec2},b2Body.b2_staticBody=0,b2Body.b2_kinematicBody=1,b2Body.b2_dynamicBody=2,b2Body.s_xf1=new b2Transform,b2Body.e_islandFlag=1,b2Body.e_awakeFlag=2,b2Body.e_allowSleepFlag=4,b2Body.e_bulletFlag=8,b2Body.e_fixedRotationFlag=16,b2Body.e_activeFlag=32,b2Body.prototype.connectEdges=function(t,o,e){var i=Math.atan2(o.GetDirectionVector().y,o.GetDirectionVector().x),n=Math.tan(.5*(i-e)),r=b2Math.MulFV(n,o.GetDirectionVector());r=b2Math.SubtractVV(r,o.GetNormalVector()),r=b2Math.MulFV(b2Settings.b2_toiSlop,r),r=b2Math.AddVV(r,o.GetVertex1());var s=b2Math.AddVV(t.GetDirectionVector(),o.GetDirectionVector());s.Normalize();var a=b2Math.Dot(t.GetDirectionVector(),o.GetNormalVector())>0;return t.SetNextEdge(o,r,s,a),o.SetPrevEdge(t,r,s,a),i},b2Body.prototype.SynchronizeFixtures=function(){var t=b2Body.s_xf1;t.R.Set(this.m_sweep.a0);var o=t.R,e=this.m_sweep.localCenter;t.position.x=this.m_sweep.c0.x-(o.col1.x*e.x+o.col2.x*e.y),t.position.y=this.m_sweep.c0.y-(o.col1.y*e.x+o.col2.y*e.y);var i,n=this.m_world.m_contactManager.m_broadPhase;for(i=this.m_fixtureList;i;i=i.m_next)i.Synchronize(n,t,this.m_xf)},b2Body.prototype.SynchronizeTransform=function(){this.m_xf.R.Set(this.m_sweep.a);var t=this.m_xf.R,o=this.m_sweep.localCenter;this.m_xf.position.x=this.m_sweep.c.x-(t.col1.x*o.x+t.col2.x*o.y),this.m_xf.position.y=this.m_sweep.c.y-(t.col1.y*o.x+t.col2.y*o.y)},b2Body.prototype.ShouldCollide=function(t){if(this.m_type!=b2Body.b2_dynamicBody&&t.m_type!=b2Body.b2_dynamicBody)return!1;for(var o=this.m_jointList;o;o=o.next)if(o.other==t&&0==o.joint.m_collideConnected)return!1;return!0},b2Body.prototype.Advance=function(t){this.m_sweep.Advance(t),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.SynchronizeTransform()},b2Body.prototype.CreateFixture=function(t){if(1==this.m_world.IsLocked())return null;var o=new b2Fixture;if(o.Create(this,this.m_xf,t),this.m_flags&b2Body.e_activeFlag){var e=this.m_world.m_contactManager.m_broadPhase;o.CreateProxy(e,this.m_xf)}return o.m_next=this.m_fixtureList,this.m_fixtureList=o,++this.m_fixtureCount,o.m_body=this,o.m_density>0&&this.ResetMassData(),this.m_world.m_flags|=b2World.e_newFixture,o},b2Body.prototype.CreateFixture2=function(t,o){var e=new b2FixtureDef;return e.shape=t,e.density=o,this.CreateFixture(e)},b2Body.prototype.DestroyFixture=function(t){if(1!=this.m_world.IsLocked()){for(var o=this.m_fixtureList,e=null;null!=o;){if(o==t){e?e.m_next=t.m_next:this.m_fixtureList=t.m_next,!0;break}e=o,o=o.m_next}for(var i=this.m_contactList;i;){var n=i.contact;i=i.next;var r=n.GetFixtureA(),s=n.GetFixtureB();t!=r&&t!=s||this.m_world.m_contactManager.Destroy(n)}if(this.m_flags&b2Body.e_activeFlag){var a=this.m_world.m_contactManager.m_broadPhase;t.DestroyProxy(a)}t.Destroy(),t.m_body=null,t.m_next=null,--this.m_fixtureCount,this.ResetMassData()}},b2Body.prototype.SetPositionAndAngle=function(t,o){var e;if(1!=this.m_world.IsLocked()){this.m_xf.R.Set(o),this.m_xf.position.SetV(t);var i=this.m_xf.R,n=this.m_sweep.localCenter;this.m_sweep.c.x=i.col1.x*n.x+i.col2.x*n.y,this.m_sweep.c.y=i.col1.y*n.x+i.col2.y*n.y,this.m_sweep.c.x+=this.m_xf.position.x,this.m_sweep.c.y+=this.m_xf.position.y,this.m_sweep.c0.SetV(this.m_sweep.c),this.m_sweep.a0=this.m_sweep.a=o;var r=this.m_world.m_contactManager.m_broadPhase;for(e=this.m_fixtureList;e;e=e.m_next)e.Synchronize(r,this.m_xf,this.m_xf);this.m_world.m_contactManager.FindNewContacts()}},b2Body.prototype.SetTransform=function(t){this.SetPositionAndAngle(t.position,t.GetAngle())},b2Body.prototype.GetTransform=function(){return this.m_xf},b2Body.prototype.GetPosition=function(){return this.m_xf.position},b2Body.prototype.SetPosition=function(t){this.SetPositionAndAngle(t,this.GetAngle())},b2Body.prototype.GetAngle=function(){return this.m_sweep.a},b2Body.prototype.SetAngle=function(t){this.SetPositionAndAngle(this.GetPosition(),t)},b2Body.prototype.GetWorldCenter=function(){return this.m_sweep.c},b2Body.prototype.GetLocalCenter=function(){return this.m_sweep.localCenter},b2Body.prototype.SetLinearVelocity=function(t){this.m_type!=b2Body.b2_staticBody&&this.m_linearVelocity.SetV(t)},b2Body.prototype.GetLinearVelocity=function(){return this.m_linearVelocity},b2Body.prototype.SetAngularVelocity=function(t){this.m_type!=b2Body.b2_staticBody&&(this.m_angularVelocity=t)},b2Body.prototype.GetAngularVelocity=function(){return this.m_angularVelocity},b2Body.prototype.GetDefinition=function(){var t=new b2BodyDef;return t.type=this.GetType(),t.allowSleep=(this.m_flags&b2Body.e_allowSleepFlag)==b2Body.e_allowSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=(this.m_flags&b2Body.e_fixedRotationFlag)==b2Body.e_fixedRotationFlag,t.bullet=(this.m_flags&b2Body.e_bulletFlag)==b2Body.e_bulletFlag,t.awake=(this.m_flags&b2Body.e_awakeFlag)==b2Body.e_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.SetV(this.GetLinearVelocity()),t.position=this.GetPosition(),t.userData=this.GetUserData(),t},b2Body.prototype.ApplyForce=function(t,o){this.m_type==b2Body.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_force.x+=t.x,this.m_force.y+=t.y,this.m_torque+=(o.x-this.m_sweep.c.x)*t.y-(o.y-this.m_sweep.c.y)*t.x)},b2Body.prototype.ApplyTorque=function(t){this.m_type==b2Body.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_torque+=t)},b2Body.prototype.ApplyImpulse=function(t,o){this.m_type==b2Body.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y,this.m_angularVelocity+=this.m_invI*((o.x-this.m_sweep.c.x)*t.y-(o.y-this.m_sweep.c.y)*t.x))},b2Body.prototype.Split=function(t){for(var o,e=this.GetLinearVelocity().Copy(),i=this.GetAngularVelocity(),n=this.GetWorldCenter(),r=this,s=this.m_world.CreateBody(this.GetDefinition()),a=r.m_fixtureList;a;)if(t(a)){var l=a.m_next;o?o.m_next=l:r.m_fixtureList=l,r.m_fixtureCount--,a.m_next=s.m_fixtureList,s.m_fixtureList=a,s.m_fixtureCount++,a.m_body=s,a=l}else o=a,a=a.m_next;r.ResetMassData(),s.ResetMassData();var m=r.GetWorldCenter(),p=s.GetWorldCenter(),_=b2Math.AddVV(e,b2Math.CrossFV(i,b2Math.SubtractVV(m,n))),c=b2Math.AddVV(e,b2Math.CrossFV(i,b2Math.SubtractVV(p,n)));return r.SetLinearVelocity(_),s.SetLinearVelocity(c),r.SetAngularVelocity(i),s.SetAngularVelocity(i),r.SynchronizeFixtures(),s.SynchronizeFixtures(),s},b2Body.prototype.Merge=function(t){var o;for(o=t.m_fixtureList;o;){var e=o.m_next;t.m_fixtureCount--,o.m_next=this.m_fixtureList,this.m_fixtureList=o,this.m_fixtureCount++,o.m_body=n,o=e}i.m_fixtureCount=0;var i=this,n=t;i.GetWorldCenter(),n.GetWorldCenter(),i.GetLinearVelocity().Copy(),n.GetLinearVelocity().Copy(),i.GetAngularVelocity(),n.GetAngularVelocity();i.ResetMassData(),this.SynchronizeFixtures()},b2Body.prototype.GetMass=function(){return this.m_mass},b2Body.prototype.GetInertia=function(){return this.m_I},b2Body.prototype.GetMassData=function(t){t.mass=this.m_mass,t.I=this.m_I,t.center.SetV(this.m_sweep.localCenter)},b2Body.prototype.SetMassData=function(t){if(b2Settings.b2Assert(0==this.m_world.IsLocked()),1!=this.m_world.IsLocked()&&this.m_type==b2Body.b2_dynamicBody){this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=t.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,t.I>0&&0==(this.m_flags&b2Body.e_fixedRotationFlag)&&(this.m_I=t.I-this.m_mass*(t.center.x*t.center.x+t.center.y*t.center.y),this.m_invI=1/this.m_I);var o=this.m_sweep.c.Copy();this.m_sweep.localCenter.SetV(t.center),this.m_sweep.c0.SetV(b2Math.MulX(this.m_xf,this.m_sweep.localCenter)),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-o.y),this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-o.x)}},b2Body.prototype.ResetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type!=b2Body.b2_staticBody&&this.m_type!=b2Body.b2_kinematicBody){for(var t=b2Vec2.Make(0,0),o=this.m_fixtureList;o;o=o.m_next)if(0!=o.m_density){var e=o.GetMassData();this.m_mass+=e.mass,t.x+=e.center.x*e.mass,t.y+=e.center.y*e.mass,this.m_I+=e.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,t.x*=this.m_invMass,t.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&0==(this.m_flags&b2Body.e_fixedRotationFlag)?(this.m_I-=this.m_mass*(t.x*t.x+t.y*t.y),this.m_I*=this.m_inertiaScale,b2Settings.b2Assert(this.m_I>0),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);var i=this.m_sweep.c.Copy();this.m_sweep.localCenter.SetV(t),this.m_sweep.c0.SetV(b2Math.MulX(this.m_xf,this.m_sweep.localCenter)),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-i.y),this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-i.x)}},b2Body.prototype.GetWorldPoint=function(t){var o=this.m_xf.R,e=new b2Vec2(o.col1.x*t.x+o.col2.x*t.y,o.col1.y*t.x+o.col2.y*t.y);return e.x+=this.m_xf.position.x,e.y+=this.m_xf.position.y,e},b2Body.prototype.GetWorldVector=function(t){return b2Math.MulMV(this.m_xf.R,t)},b2Body.prototype.GetLocalPoint=function(t){return b2Math.MulXT(this.m_xf,t)},b2Body.prototype.GetLocalVector=function(t){return b2Math.MulTMV(this.m_xf.R,t)},b2Body.prototype.GetLinearVelocityFromWorldPoint=function(t){return new b2Vec2(this.m_linearVelocity.x-this.m_angularVelocity*(t.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(t.x-this.m_sweep.c.x))},b2Body.prototype.GetLinearVelocityFromLocalPoint=function(t){var o=this.m_xf.R,e=new b2Vec2(o.col1.x*t.x+o.col2.x*t.y,o.col1.y*t.x+o.col2.y*t.y);return e.x+=this.m_xf.position.x,e.y+=this.m_xf.position.y,new b2Vec2(this.m_linearVelocity.x-this.m_angularVelocity*(e.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(e.x-this.m_sweep.c.x))},b2Body.prototype.GetLinearDamping=function(){return this.m_linearDamping},b2Body.prototype.SetLinearDamping=function(t){this.m_linearDamping=t},b2Body.prototype.GetAngularDamping=function(){return this.m_angularDamping},b2Body.prototype.SetAngularDamping=function(t){this.m_angularDamping=t},b2Body.prototype.SetType=function(t){if(this.m_type!=t){this.m_type=t,this.ResetMassData(),this.m_type==b2Body.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;for(var o=this.m_contactList;o;o=o.next)o.contact.FlagForFiltering()}},b2Body.prototype.GetType=function(){return this.m_type},b2Body.prototype.SetBullet=function(t){t?this.m_flags|=b2Body.e_bulletFlag:this.m_flags&=~b2Body.e_bulletFlag},b2Body.prototype.IsBullet=function(){return(this.m_flags&b2Body.e_bulletFlag)==b2Body.e_bulletFlag},b2Body.prototype.SetSleepingAllowed=function(t){t?this.m_flags|=b2Body.e_allowSleepFlag:(this.m_flags&=~b2Body.e_allowSleepFlag,this.SetAwake(!0))},b2Body.prototype.SetAwake=function(t){t?(this.m_flags|=b2Body.e_awakeFlag,this.m_sleepTime=0):(this.m_flags&=~b2Body.e_awakeFlag,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)},b2Body.prototype.IsAwake=function(){return(this.m_flags&b2Body.e_awakeFlag)==b2Body.e_awakeFlag},b2Body.prototype.SetFixedRotation=function(t){t?this.m_flags|=b2Body.e_fixedRotationFlag:this.m_flags&=~b2Body.e_fixedRotationFlag,this.ResetMassData()},b2Body.prototype.IsFixedRotation=function(){return(this.m_flags&b2Body.e_fixedRotationFlag)==b2Body.e_fixedRotationFlag},b2Body.prototype.SetActive=function(t){if(t!=this.IsActive()){var o,e;if(t)for(this.m_flags|=b2Body.e_activeFlag,o=this.m_world.m_contactManager.m_broadPhase,e=this.m_fixtureList;e;e=e.m_next)e.CreateProxy(o,this.m_xf);else{for(this.m_flags&=~b2Body.e_activeFlag,o=this.m_world.m_contactManager.m_broadPhase,e=this.m_fixtureList;e;e=e.m_next)e.DestroyProxy(o);for(var i=this.m_contactList;i;){var n=i;i=i.next,this.m_world.m_contactManager.Destroy(n.contact)}this.m_contactList=null}}},b2Body.prototype.IsActive=function(){return(this.m_flags&b2Body.e_activeFlag)==b2Body.e_activeFlag},b2Body.prototype.IsSleepingAllowed=function(){return(this.m_flags&b2Body.e_allowSleepFlag)==b2Body.e_allowSleepFlag},b2Body.prototype.GetFixtureList=function(){return this.m_fixtureList},b2Body.prototype.GetJointList=function(){return this.m_jointList},b2Body.prototype.GetControllerList=function(){return this.m_controllerList},b2Body.prototype.GetContactList=function(){return this.m_contactList},b2Body.prototype.GetNext=function(){return this.m_next},b2Body.prototype.GetUserData=function(){return this.m_userData},b2Body.prototype.SetUserData=function(t){this.m_userData=t},b2Body.prototype.GetWorld=function(){return this.m_world},b2Body.prototype.m_flags=0,b2Body.prototype.m_type=0,b2Body.prototype.m_islandIndex=0,b2Body.prototype.m_xf=new b2Transform,b2Body.prototype.m_sweep=new b2Sweep,b2Body.prototype.m_linearVelocity=new b2Vec2,b2Body.prototype.m_angularVelocity=null,b2Body.prototype.m_force=new b2Vec2,b2Body.prototype.m_torque=null,b2Body.prototype.m_world=null,b2Body.prototype.m_prev=null,b2Body.prototype.m_next=null,b2Body.prototype.m_fixtureList=null,b2Body.prototype.m_fixtureCount=0,b2Body.prototype.m_controllerList=null,b2Body.prototype.m_controllerCount=0,b2Body.prototype.m_jointList=null,b2Body.prototype.m_contactList=null,b2Body.prototype.m_mass=null,b2Body.prototype.m_invMass=null,b2Body.prototype.m_I=null,b2Body.prototype.m_invI=null,b2Body.prototype.m_inertiaScale=null,b2Body.prototype.m_linearDamping=null,b2Body.prototype.m_angularDamping=null,b2Body.prototype.m_sleepTime=null,b2Body.prototype.m_userData=null;var b2ContactImpulse=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactImpulse.prototype.__constructor=function(){},b2ContactImpulse.prototype.__varz=function(){this.normalImpulses=new Array(b2Settings.b2_maxManifoldPoints),this.tangentImpulses=new Array(b2Settings.b2_maxManifoldPoints)},b2ContactImpulse.prototype.normalImpulses=new Array(b2Settings.b2_maxManifoldPoints),b2ContactImpulse.prototype.tangentImpulses=new Array(b2Settings.b2_maxManifoldPoints);var b2TensorDampingController=function(){b2Controller.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2TensorDampingController.prototype,b2Controller.prototype),b2TensorDampingController.prototype._super=b2Controller.prototype,b2TensorDampingController.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2TensorDampingController.prototype.__varz=function(){this.T=new b2Mat22},b2TensorDampingController.prototype.SetAxisAligned=function(t,o){this.T.col1.x=-t,this.T.col1.y=0,this.T.col2.x=0,this.T.col2.y=-o,this.maxTimestep=t>0||o>0?1/Math.max(t,o):0},b2TensorDampingController.prototype.Step=function(t){var o=t.dt;if(!(o<=Number.MIN_VALUE)){o>this.maxTimestep&&this.maxTimestep>0&&(o=this.maxTimestep);for(var e=m_bodyList;e;e=e.nextBody){var i=e.body;if(i.IsAwake()){var n=i.GetWorldVector(b2Math.MulMV(this.T,i.GetLocalVector(i.GetLinearVelocity())));i.SetLinearVelocity(new b2Vec2(i.GetLinearVelocity().x+n.x*o,i.GetLinearVelocity().y+n.y*o))}}}},b2TensorDampingController.prototype.T=new b2Mat22,b2TensorDampingController.prototype.maxTimestep=0;var b2ManifoldPoint=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ManifoldPoint.prototype.__constructor=function(){this.Reset()},b2ManifoldPoint.prototype.__varz=function(){this.m_localPoint=new b2Vec2,this.m_id=new b2ContactID},b2ManifoldPoint.prototype.Reset=function(){this.m_localPoint.SetZero(),this.m_normalImpulse=0,this.m_tangentImpulse=0,this.m_id.key=0},b2ManifoldPoint.prototype.Set=function(t){this.m_localPoint.SetV(t.m_localPoint),this.m_normalImpulse=t.m_normalImpulse,this.m_tangentImpulse=t.m_tangentImpulse,this.m_id.Set(t.m_id)},b2ManifoldPoint.prototype.m_localPoint=new b2Vec2,b2ManifoldPoint.prototype.m_normalImpulse=null,b2ManifoldPoint.prototype.m_tangentImpulse=null,b2ManifoldPoint.prototype.m_id=new b2ContactID;var b2PolygonShape=function(){b2Shape.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PolygonShape.prototype,b2Shape.prototype),b2PolygonShape.prototype._super=b2Shape.prototype,b2PolygonShape.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.m_type=b2Shape.e_polygonShape,this.m_centroid=new b2Vec2,this.m_vertices=new Array,this.m_normals=new Array},b2PolygonShape.prototype.__varz=function(){},b2PolygonShape.AsArray=function(t,o){var e=new b2PolygonShape;return e.SetAsArray(t,o),e},b2PolygonShape.AsVector=function(t,o){var e=new b2PolygonShape;return e.SetAsVector(t,o),e},b2PolygonShape.AsBox=function(t,o){var e=new b2PolygonShape;return e.SetAsBox(t,o),e},b2PolygonShape.AsOrientedBox=function(t,o,e,i){var n=new b2PolygonShape;return n.SetAsOrientedBox(t,o,e,i),n},b2PolygonShape.AsEdge=function(t,o){var e=new b2PolygonShape;return e.SetAsEdge(t,o),e},b2PolygonShape.ComputeCentroid=function(t,o){for(var e=new b2Vec2,i=0,n=0;n<o;++n){var r=t[n],s=n+1<o?t[parseInt(n+1)]:t[0],a=r.x-0,l=r.y-0,m=s.x-0,p=s.y-0,_=a*p-l*m,c=.5*_;i+=c,e.x+=c*(1/3)*(0+r.x+s.x),e.y+=c*(1/3)*(0+r.y+s.y)}return e.x*=1/i,e.y*=1/i,e},b2PolygonShape.ComputeOBB=function(t,o,e){var i=0,n=new Array(e+1);for(i=0;i<e;++i)n[i]=o[i];n[e]=n[0];var r=Number.MAX_VALUE;for(i=1;i<=e;++i){var s=n[parseInt(i-1)],a=n[i].x-s.x,l=n[i].y-s.y,m=Math.sqrt(a*a+l*l);a/=m,l/=m;for(var p=-l,_=a,c=Number.MAX_VALUE,h=Number.MAX_VALUE,y=-Number.MAX_VALUE,u=-Number.MAX_VALUE,b=0;b<e;++b){var x=n[b].x-s.x,d=n[b].y-s.y,f=a*x+l*d,v=p*x+_*d;f<c&&(c=f),v<h&&(h=v),f>y&&(y=f),v>u&&(u=v)}var g=(y-c)*(u-h);if(g<.95*r){r=g,t.R.col1.x=a,t.R.col1.y=l,t.R.col2.x=p,t.R.col2.y=_;var w=.5*(c+y),S=.5*(h+u),C=t.R;t.center.x=s.x+(C.col1.x*w+C.col2.x*S),t.center.y=s.y+(C.col1.y*w+C.col2.y*S),t.extents.x=.5*(y-c),t.extents.y=.5*(u-h)}}},b2PolygonShape.s_mat=new b2Mat22,b2PolygonShape.prototype.Validate=function(){return!1},b2PolygonShape.prototype.Reserve=function(t){for(var o=this.m_vertices.length;o<t;o++)this.m_vertices[o]=new b2Vec2,this.m_normals[o]=new b2Vec2},b2PolygonShape.prototype.Copy=function(){var t=new b2PolygonShape;return t.Set(this),t},b2PolygonShape.prototype.Set=function(t){if(this._super.Set.apply(this,[t]),isInstanceOf(t,b2PolygonShape)){var o=t;this.m_centroid.SetV(o.m_centroid),this.m_vertexCount=o.m_vertexCount,this.Reserve(this.m_vertexCount);for(var e=0;e<this.m_vertexCount;e++)this.m_vertices[e].SetV(o.m_vertices[e]),this.m_normals[e].SetV(o.m_normals[e])}},b2PolygonShape.prototype.SetAsArray=function(t,o){for(var e=new Array,i=0,n=null;t.length,n=t[i];i++)e.push(n);this.SetAsVector(e,o)},b2PolygonShape.prototype.SetAsVector=function(t,o){void 0===o&&(o=t.length),b2Settings.b2Assert(2<=o),this.m_vertexCount=o,this.Reserve(o);var e=0;for(e=0;e<this.m_vertexCount;e++)this.m_vertices[e].SetV(t[e]);for(e=0;e<this.m_vertexCount;++e){var i=e,n=e+1<this.m_vertexCount?e+1:0,r=b2Math.SubtractVV(this.m_vertices[n],this.m_vertices[i]);b2Settings.b2Assert(r.LengthSquared()>Number.MIN_VALUE),this.m_normals[e].SetV(b2Math.CrossVF(r,1)),this.m_normals[e].Normalize()}this.m_centroid=b2PolygonShape.ComputeCentroid(this.m_vertices,this.m_vertexCount)},b2PolygonShape.prototype.SetAsBox=function(t,o){this.m_vertexCount=4,this.Reserve(4),this.m_vertices[0].Set(-t,-o),this.m_vertices[1].Set(t,-o),this.m_vertices[2].Set(t,o),this.m_vertices[3].Set(-t,o),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero()},b2PolygonShape.prototype.SetAsOrientedBox=function(t,o,e,i){this.m_vertexCount=4,this.Reserve(4),this.m_vertices[0].Set(-t,-o),this.m_vertices[1].Set(t,-o),this.m_vertices[2].Set(t,o),this.m_vertices[3].Set(-t,o),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid=e;var n=new b2Transform;n.position=e,n.R.Set(i);for(var r=0;r<this.m_vertexCount;++r)this.m_vertices[r]=b2Math.MulX(n,this.m_vertices[r]),this.m_normals[r]=b2Math.MulMV(n.R,this.m_normals[r])},b2PolygonShape.prototype.SetAsEdge=function(t,o){this.m_vertexCount=2,this.Reserve(2),this.m_vertices[0].SetV(t),this.m_vertices[1].SetV(o),this.m_centroid.x=.5*(t.x+o.x),this.m_centroid.y=.5*(t.y+o.y),this.m_normals[0]=b2Math.CrossVF(b2Math.SubtractVV(o,t),1),this.m_normals[0].Normalize(),this.m_normals[1].x=-this.m_normals[0].x,this.m_normals[1].y=-this.m_normals[0].y},b2PolygonShape.prototype.TestPoint=function(t,o){for(var e,i=t.R,n=o.x-t.position.x,r=o.y-t.position.y,s=n*i.col1.x+r*i.col1.y,a=n*i.col2.x+r*i.col2.y,l=0;l<this.m_vertexCount;++l){e=this.m_vertices[l],n=s-e.x,r=a-e.y,e=this.m_normals[l];if(e.x*n+e.y*r>0)return!1}return!0},b2PolygonShape.prototype.RayCast=function(t,o,e){var i,n,r,s,a=0,l=o.maxFraction;i=o.p1.x-e.position.x,n=o.p1.y-e.position.y,r=e.R;var m=i*r.col1.x+n*r.col1.y,p=i*r.col2.x+n*r.col2.y;i=o.p2.x-e.position.x,n=o.p2.y-e.position.y,r=e.R;for(var _=i*r.col1.x+n*r.col1.y,c=i*r.col2.x+n*r.col2.y,h=_-m,y=c-p,u=-1,b=0;b<this.m_vertexCount;++b){s=this.m_vertices[b],i=s.x-m,n=s.y-p,s=this.m_normals[b];var x=s.x*i+s.y*n,d=s.x*h+s.y*y;if(0==d){if(x<0)return!1}else d<0&&x<a*d?(a=x/d,u=b):d>0&&x<l*d&&(l=x/d);if(l<a-Number.MIN_VALUE)return!1}return u>=0&&(t.fraction=a,r=e.R,s=this.m_normals[u],t.normal.x=r.col1.x*s.x+r.col2.x*s.y,t.normal.y=r.col1.y*s.x+r.col2.y*s.y,!0)},b2PolygonShape.prototype.ComputeAABB=function(t,o){for(var e=o.R,i=this.m_vertices[0],n=o.position.x+(e.col1.x*i.x+e.col2.x*i.y),r=o.position.y+(e.col1.y*i.x+e.col2.y*i.y),s=n,a=r,l=1;l<this.m_vertexCount;++l){i=this.m_vertices[l];var m=o.position.x+(e.col1.x*i.x+e.col2.x*i.y),p=o.position.y+(e.col1.y*i.x+e.col2.y*i.y);n=n<m?n:m,r=r<p?r:p,s=s>m?s:m,a=a>p?a:p}t.lowerBound.x=n-this.m_radius,t.lowerBound.y=r-this.m_radius,t.upperBound.x=s+this.m_radius,t.upperBound.y=a+this.m_radius},b2PolygonShape.prototype.ComputeMass=function(t,o){if(2==this.m_vertexCount)return t.center.x=.5*(this.m_vertices[0].x+this.m_vertices[1].x),t.center.y=.5*(this.m_vertices[0].y+this.m_vertices[1].y),t.mass=0,void(t.I=0);for(var e=0,i=0,n=0,r=0,s=0;s<this.m_vertexCount;++s){var a=this.m_vertices[s],l=s+1<this.m_vertexCount?this.m_vertices[parseInt(s+1)]:this.m_vertices[0],m=a.x-0,p=a.y-0,_=l.x-0,c=l.y-0,h=m*c-p*_,y=.5*h;n+=y,e+=y*(1/3)*(0+a.x+l.x),i+=y*(1/3)*(0+a.y+l.y);var u=m,b=p,x=_,d=c;r+=h*(1/3*(.25*(u*u+x*u+x*x)+(0*u+0*x))+0+(1/3*(.25*(b*b+d*b+d*d)+(0*b+0*d))+0))}t.mass=o*n,e*=1/n,i*=1/n,t.center.Set(e,i),t.I=o*r},b2PolygonShape.prototype.ComputeSubmergedArea=function(t,o,e,i){var n=b2Math.MulTMV(e.R,t),r=o-b2Math.Dot(t,e.position),s=new Array,a=0,l=-1,m=-1,p=!1,_=0;for(_=0;_<this.m_vertexCount;++_){s[_]=b2Math.Dot(n,this.m_vertices[_])-r;var c=s[_]<-Number.MIN_VALUE;_>0&&(c?p||(l=_-1,a++):p&&(m=_-1,a++)),p=c}switch(a){case 0:if(p){var h=new b2MassData;return this.ComputeMass(h,1),i.SetV(b2Math.MulX(e,h.center)),h.mass}return 0;case 1:l==-1?l=this.m_vertexCount-1:m=this.m_vertexCount-1}var y,u=(l+1)%this.m_vertexCount,b=(m+1)%this.m_vertexCount,x=(0-s[l])/(s[u]-s[l]),d=(0-s[m])/(s[b]-s[m]),f=new b2Vec2(this.m_vertices[l].x*(1-x)+this.m_vertices[u].x*x,this.m_vertices[l].y*(1-x)+this.m_vertices[u].y*x),v=new b2Vec2(this.m_vertices[m].x*(1-d)+this.m_vertices[b].x*d,this.m_vertices[m].y*(1-d)+this.m_vertices[b].y*d),g=0,w=new b2Vec2,S=this.m_vertices[u];for(_=u;_!=b;){_=(_+1)%this.m_vertexCount,y=_==b?v:this.m_vertices[_];var C=.5*((S.x-f.x)*(y.y-f.y)-(S.y-f.y)*(y.x-f.x));g+=C,w.x+=C*(f.x+S.x+y.x)/3,w.y+=C*(f.y+S.y+y.y)/3,S=y}return w.Multiply(1/g),i.SetV(b2Math.MulX(e,w)),g},b2PolygonShape.prototype.GetVertexCount=function(){return this.m_vertexCount},b2PolygonShape.prototype.GetVertices=function(){return this.m_vertices},b2PolygonShape.prototype.GetNormals=function(){return this.m_normals},b2PolygonShape.prototype.GetSupport=function(t){for(var o=0,e=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,i=1;i<this.m_vertexCount;++i){var n=this.m_vertices[i].x*t.x+this.m_vertices[i].y*t.y;n>e&&(o=i,e=n)}return o},b2PolygonShape.prototype.GetSupportVertex=function(t){for(var o=0,e=this.m_vertices[0].x*t.x+this.m_vertices[0].y*t.y,i=1;i<this.m_vertexCount;++i){var n=this.m_vertices[i].x*t.x+this.m_vertices[i].y*t.y;n>e&&(o=i,e=n)}return this.m_vertices[o]},b2PolygonShape.prototype.m_centroid=null,b2PolygonShape.prototype.m_vertices=null,b2PolygonShape.prototype.m_normals=null,b2PolygonShape.prototype.m_vertexCount=0;var b2Fixture=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Fixture.prototype.__constructor=function(){this.m_aabb=new b2AABB,this.m_userData=null,this.m_body=null,this.m_next=null,this.m_shape=null,this.m_density=0,this.m_friction=0,this.m_restitution=0},b2Fixture.prototype.__varz=function(){this.m_filter=new b2FilterData},b2Fixture.prototype.Create=function(t,o,e){this.m_userData=e.userData,this.m_friction=e.friction,this.m_restitution=e.restitution,this.m_body=t,this.m_next=null,this.m_filter=e.filter.Copy(),this.m_isSensor=e.isSensor,this.m_shape=e.shape.Copy(),this.m_density=e.density},b2Fixture.prototype.Destroy=function(){this.m_shape=null},b2Fixture.prototype.CreateProxy=function(t,o){this.m_shape.ComputeAABB(this.m_aabb,o),this.m_proxy=t.CreateProxy(this.m_aabb,this)},b2Fixture.prototype.DestroyProxy=function(t){null!=this.m_proxy&&(t.DestroyProxy(this.m_proxy),this.m_proxy=null)},b2Fixture.prototype.Synchronize=function(t,o,e){if(this.m_proxy){var i=new b2AABB,n=new b2AABB;this.m_shape.ComputeAABB(i,o),this.m_shape.ComputeAABB(n,e),this.m_aabb.Combine(i,n);var r=b2Math.SubtractVV(e.position,o.position);t.MoveProxy(this.m_proxy,this.m_aabb,r)}},b2Fixture.prototype.GetType=function(){return this.m_shape.GetType()},b2Fixture.prototype.GetShape=function(){return this.m_shape},b2Fixture.prototype.SetSensor=function(t){if(this.m_isSensor!=t&&(this.m_isSensor=t,null!=this.m_body))for(var o=this.m_body.GetContactList();o;){var e=o.contact,i=e.GetFixtureA(),n=e.GetFixtureB();i!=this&&n!=this||e.SetSensor(i.IsSensor()||n.IsSensor()),o=o.next}},b2Fixture.prototype.IsSensor=function(){return this.m_isSensor},b2Fixture.prototype.SetFilterData=function(t){if(this.m_filter=t.Copy(),!this.m_body)for(var o=this.m_body.GetContactList();o;){var e=o.contact,i=e.GetFixtureA(),n=e.GetFixtureB();i!=this&&n!=this||e.FlagForFiltering(),o=o.next}},b2Fixture.prototype.GetFilterData=function(){return this.m_filter.Copy()},b2Fixture.prototype.GetBody=function(){return this.m_body},b2Fixture.prototype.GetNext=function(){return this.m_next},b2Fixture.prototype.GetUserData=function(){return this.m_userData},b2Fixture.prototype.SetUserData=function(t){this.m_userData=t},b2Fixture.prototype.TestPoint=function(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)},b2Fixture.prototype.RayCast=function(t,o){return this.m_shape.RayCast(t,o,this.m_body.GetTransform())},b2Fixture.prototype.GetMassData=function(t){return null==t&&(t=new b2MassData),this.m_shape.ComputeMass(t,this.m_density),t},b2Fixture.prototype.SetDensity=function(t){this.m_density=t},b2Fixture.prototype.GetDensity=function(){return this.m_density},b2Fixture.prototype.GetFriction=function(){return this.m_friction},b2Fixture.prototype.SetFriction=function(t){this.m_friction=t},b2Fixture.prototype.GetRestitution=function(){return this.m_restitution},b2Fixture.prototype.SetRestitution=function(t){this.m_restitution=t},b2Fixture.prototype.GetAABB=function(){return this.m_aabb},b2Fixture.prototype.m_massData=null,b2Fixture.prototype.m_aabb=null,b2Fixture.prototype.m_density=null,b2Fixture.prototype.m_next=null,b2Fixture.prototype.m_body=null,b2Fixture.prototype.m_shape=null,b2Fixture.prototype.m_friction=null,b2Fixture.prototype.m_restitution=null,b2Fixture.prototype.m_proxy=null,b2Fixture.prototype.m_filter=new b2FilterData,b2Fixture.prototype.m_isSensor=null,b2Fixture.prototype.m_userData=null;var b2DynamicTreeNode=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DynamicTreeNode.prototype.__constructor=function(){},b2DynamicTreeNode.prototype.__varz=function(){this.aabb=new b2AABB},b2DynamicTreeNode.prototype.IsLeaf=function(){return null==this.child1},b2DynamicTreeNode.prototype.userData=null,b2DynamicTreeNode.prototype.aabb=new b2AABB,b2DynamicTreeNode.prototype.parent=null,b2DynamicTreeNode.prototype.child1=null,b2DynamicTreeNode.prototype.child2=null;var b2BodyDef=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2BodyDef.prototype.__constructor=function(){this.userData=null,this.position.Set(0,0),this.angle=0,this.linearVelocity.Set(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.type=b2Body.b2_staticBody,this.active=!0,this.inertiaScale=1},b2BodyDef.prototype.__varz=function(){this.position=new b2Vec2,this.linearVelocity=new b2Vec2},b2BodyDef.prototype.type=0,b2BodyDef.prototype.position=new b2Vec2,b2BodyDef.prototype.angle=null,b2BodyDef.prototype.linearVelocity=new b2Vec2,b2BodyDef.prototype.angularVelocity=null,b2BodyDef.prototype.linearDamping=null,b2BodyDef.prototype.angularDamping=null,b2BodyDef.prototype.allowSleep=null,b2BodyDef.prototype.awake=null,b2BodyDef.prototype.fixedRotation=null,b2BodyDef.prototype.bullet=null,b2BodyDef.prototype.active=null,b2BodyDef.prototype.userData=null,b2BodyDef.prototype.inertiaScale=null;var b2DynamicTreeBroadPhase=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DynamicTreeBroadPhase.prototype.__constructor=function(){},b2DynamicTreeBroadPhase.prototype.__varz=function(){this.m_tree=new b2DynamicTree,this.m_moveBuffer=new Array,this.m_pairBuffer=new Array},b2DynamicTreeBroadPhase.prototype.BufferMove=function(t){this.m_moveBuffer[this.m_moveBuffer.length]=t},b2DynamicTreeBroadPhase.prototype.UnBufferMove=function(t){var o=this.m_moveBuffer.indexOf(t);this.m_moveBuffer.splice(o,1)},b2DynamicTreeBroadPhase.prototype.ComparePairs=function(t,o){return 0},b2DynamicTreeBroadPhase.prototype.CreateProxy=function(t,o){var e=this.m_tree.CreateProxy(t,o);return++this.m_proxyCount,this.BufferMove(e),e},b2DynamicTreeBroadPhase.prototype.DestroyProxy=function(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)},b2DynamicTreeBroadPhase.prototype.MoveProxy=function(t,o,e){this.m_tree.MoveProxy(t,o,e)&&this.BufferMove(t)},b2DynamicTreeBroadPhase.prototype.TestOverlap=function(t,o){ var e=this.m_tree.GetFatAABB(t),i=this.m_tree.GetFatAABB(o);return e.TestOverlap(i)},b2DynamicTreeBroadPhase.prototype.GetUserData=function(t){return this.m_tree.GetUserData(t)},b2DynamicTreeBroadPhase.prototype.GetFatAABB=function(t){return this.m_tree.GetFatAABB(t)},b2DynamicTreeBroadPhase.prototype.GetProxyCount=function(){return this.m_proxyCount},b2DynamicTreeBroadPhase.prototype.UpdatePairs=function(t){function o(t){if(t==i)return!0;n.m_pairCount==n.m_pairBuffer.length&&(n.m_pairBuffer[n.m_pairCount]=new b2DynamicTreePair);var o=n.m_pairBuffer[n.m_pairCount];return o.proxyA=t<i?t:i,o.proxyB=t>=i?t:i,++n.m_pairCount,!0}this.m_pairCount=0;for(var e=0,i=null;this.m_moveBuffer.length,i=this.m_moveBuffer[e];e++){var n=this,r=this.m_tree.GetFatAABB(i);this.m_tree.Query(o,r)}this.m_moveBuffer.length=0;for(var e=0;e<this.m_pairCount;){var s=this.m_pairBuffer[e],a=this.m_tree.GetUserData(s.proxyA),l=this.m_tree.GetUserData(s.proxyB);for(t(a,l),++e;e<this.m_pairCount;){var m=this.m_pairBuffer[e];if(m.proxyA!=s.proxyA||m.proxyB!=s.proxyB)break;++e}}},b2DynamicTreeBroadPhase.prototype.Query=function(t,o){this.m_tree.Query(t,o)},b2DynamicTreeBroadPhase.prototype.RayCast=function(t,o){this.m_tree.RayCast(t,o)},b2DynamicTreeBroadPhase.prototype.Validate=function(){},b2DynamicTreeBroadPhase.prototype.Rebalance=function(t){this.m_tree.Rebalance(t)},b2DynamicTreeBroadPhase.prototype.m_tree=new b2DynamicTree,b2DynamicTreeBroadPhase.prototype.m_proxyCount=0,b2DynamicTreeBroadPhase.prototype.m_moveBuffer=new Array,b2DynamicTreeBroadPhase.prototype.m_pairBuffer=new Array,b2DynamicTreeBroadPhase.prototype.m_pairCount=0;var b2BroadPhase=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2BroadPhase.prototype.__constructor=function(t){var o=0;for(this.m_pairManager.Initialize(this),this.m_worldAABB=t,this.m_proxyCount=0,this.m_bounds=new Array,o=0;o<2;o++)this.m_bounds[o]=new Array;var e=t.upperBound.x-t.lowerBound.x,i=t.upperBound.y-t.lowerBound.y;this.m_quantizationFactor.x=b2Settings.USHRT_MAX/e,this.m_quantizationFactor.y=b2Settings.USHRT_MAX/i,this.m_timeStamp=1,this.m_queryResultCount=0},b2BroadPhase.prototype.__varz=function(){this.m_pairManager=new b2PairManager,this.m_proxyPool=new Array,this.m_querySortKeys=new Array,this.m_queryResults=new Array,this.m_quantizationFactor=new b2Vec2},b2BroadPhase.BinarySearch=function(t,o,e){for(var i=0,n=o-1;i<=n;){var r=Math.round((i+n)/2),s=t[r];if(s.value>e)n=r-1;else{if(!(s.value<e))return parseInt(r);i=r+1}}return parseInt(i)},b2BroadPhase.s_validate=!1,b2BroadPhase.b2_invalid=b2Settings.USHRT_MAX,b2BroadPhase.b2_nullEdge=b2Settings.USHRT_MAX,b2BroadPhase.prototype.ComputeBounds=function(t,o,e){var i=e.lowerBound.x,n=e.lowerBound.y;i=b2Math.Min(i,this.m_worldAABB.upperBound.x),n=b2Math.Min(n,this.m_worldAABB.upperBound.y),i=b2Math.Max(i,this.m_worldAABB.lowerBound.x),n=b2Math.Max(n,this.m_worldAABB.lowerBound.y);var r=e.upperBound.x,s=e.upperBound.y;r=b2Math.Min(r,this.m_worldAABB.upperBound.x),s=b2Math.Min(s,this.m_worldAABB.upperBound.y),r=b2Math.Max(r,this.m_worldAABB.lowerBound.x),s=b2Math.Max(s,this.m_worldAABB.lowerBound.y),t[0]=parseInt(this.m_quantizationFactor.x*(i-this.m_worldAABB.lowerBound.x))&b2Settings.USHRT_MAX-1,o[0]=parseInt(this.m_quantizationFactor.x*(r-this.m_worldAABB.lowerBound.x))%65535|1,t[1]=parseInt(this.m_quantizationFactor.y*(n-this.m_worldAABB.lowerBound.y))&b2Settings.USHRT_MAX-1,o[1]=parseInt(this.m_quantizationFactor.y*(s-this.m_worldAABB.lowerBound.y))%65535|1},b2BroadPhase.prototype.TestOverlapValidate=function(t,o){for(var e=0;e<2;++e){var i=this.m_bounds[e],n=i[t.lowerBounds[e]],r=i[o.upperBounds[e]];if(n.value>r.value)return!1;if(n=i[t.upperBounds[e]],r=i[o.lowerBounds[e]],n.value<r.value)return!1}return!0},b2BroadPhase.prototype.QueryAxis=function(t,o,e,i,n,r,s){for(var a,l=b2BroadPhase.BinarySearch(n,r,e),m=b2BroadPhase.BinarySearch(n,r,i),p=l;p<m;++p)a=n[p],a.IsLower()&&this.IncrementOverlapCount(a.proxy);if(l>0){var _=l-1;a=n[_];for(var c=a.stabbingCount;c;){if(a=n[_],a.IsLower()){l<=a.proxy.upperBounds[s]&&(this.IncrementOverlapCount(a.proxy),--c)}--_}}t[0]=l,o[0]=m},b2BroadPhase.prototype.IncrementOverlapCount=function(t){t.timeStamp<this.m_timeStamp?(t.timeStamp=this.m_timeStamp,t.overlapCount=1):(t.overlapCount=2,this.m_queryResults[this.m_queryResultCount]=t,++this.m_queryResultCount)},b2BroadPhase.prototype.IncrementTimeStamp=function(){if(this.m_timeStamp==b2Settings.USHRT_MAX){for(var t=0;t<this.m_proxyPool.length;++t)this.m_proxyPool[t].timeStamp=0;this.m_timeStamp=1}else++this.m_timeStamp},b2BroadPhase.prototype.InRange=function(t){var o,e,i,n;return o=t.lowerBound.x,e=t.lowerBound.y,o-=this.m_worldAABB.upperBound.x,e-=this.m_worldAABB.upperBound.y,i=this.m_worldAABB.lowerBound.x,n=this.m_worldAABB.lowerBound.y,i-=t.upperBound.x,n-=t.upperBound.y,o=b2Math.Max(o,i),e=b2Math.Max(e,n),b2Math.Max(o,e)<0},b2BroadPhase.prototype.CreateProxy=function(t,o){var e,i=0,n=0,r=0;if(!this.m_freeProxy)for(this.m_freeProxy=this.m_proxyPool[this.m_proxyCount]=new b2Proxy,this.m_freeProxy.next=null,this.m_freeProxy.timeStamp=0,this.m_freeProxy.overlapCount=b2BroadPhase.b2_invalid,this.m_freeProxy.userData=null,n=0;n<2;n++)r=2*this.m_proxyCount,this.m_bounds[n][r++]=new b2Bound,this.m_bounds[n][r]=new b2Bound;e=this.m_freeProxy,this.m_freeProxy=e.next,e.overlapCount=0,e.userData=o;var s=2*this.m_proxyCount,a=new Array,l=new Array;this.ComputeBounds(a,l,t);for(var m=0;m<2;++m){var p=this.m_bounds[m],_=0,c=0,h=new Array;h.push(_);var y=new Array;y.push(c),this.QueryAxis(h,y,a[m],l[m],p,s,m),_=h[0],c=y[0],p.splice(c,0,p[p.length-1]),p.length--,p.splice(_,0,p[p.length-1]),p.length--,++c;var u=p[_],b=p[c];u.value=a[m],u.proxy=e,b.value=l[m],b.proxy=e;var x=p[parseInt(_-1)];for(u.stabbingCount=0==_?0:x.stabbingCount,x=p[parseInt(c-1)],b.stabbingCount=x.stabbingCount,i=_;i<c;++i)x=p[i],x.stabbingCount++;for(i=_;i<s+2;++i){u=p[i];var d=u.proxy;u.IsLower()?d.lowerBounds[m]=i:d.upperBounds[m]=i}}for(++this.m_proxyCount,n=0;n<this.m_queryResultCount;++n)this.m_pairManager.AddBufferedPair(e,this.m_queryResults[n]);return this.m_queryResultCount=0,this.IncrementTimeStamp(),e},b2BroadPhase.prototype.DestroyProxy=function(t){for(var o,e,i=t,n=2*this.m_proxyCount,r=0;r<2;++r){var s=this.m_bounds[r],a=i.lowerBounds[r],l=i.upperBounds[r];o=s[a];var m=o.value;e=s[l];var p=e.value;s.splice(l,1),s.splice(a,1),s.push(o),s.push(e);for(var _=n-2,c=a;c<_;++c){o=s[c];var h=o.proxy;o.IsLower()?h.lowerBounds[r]=c:h.upperBounds[r]=c}_=l-1;for(var y=a;y<_;++y)o=s[y],o.stabbingCount--;var u=new Array;this.QueryAxis(u,u,m,p,s,n-2,r)}for(var b=0;b<this.m_queryResultCount;++b)this.m_pairManager.RemoveBufferedPair(i,this.m_queryResults[b]);this.m_queryResultCount=0,this.IncrementTimeStamp(),i.userData=null,i.overlapCount=b2BroadPhase.b2_invalid,i.lowerBounds[0]=b2BroadPhase.b2_invalid,i.lowerBounds[1]=b2BroadPhase.b2_invalid,i.upperBounds[0]=b2BroadPhase.b2_invalid,i.upperBounds[1]=b2BroadPhase.b2_invalid,i.next=this.m_freeProxy,this.m_freeProxy=i,--this.m_proxyCount},b2BroadPhase.prototype.MoveProxy=function(t,o,e){var i,n,r,s,a,l=t,m=0,p=0,_=0;if(null!=l&&0!=o.IsValid()){var c=2*this.m_proxyCount,h=new b2BoundValues;this.ComputeBounds(h.lowerValues,h.upperValues,o);var y=new b2BoundValues;for(p=0;p<2;++p)n=this.m_bounds[p][l.lowerBounds[p]],y.lowerValues[p]=n.value,n=this.m_bounds[p][l.upperBounds[p]],y.upperValues[p]=n.value;for(p=0;p<2;++p){var u=this.m_bounds[p],b=l.lowerBounds[p],x=l.upperBounds[p],d=h.lowerValues[p],f=h.upperValues[p];n=u[b];var v=d-n.value;n.value=d,n=u[x];var g=f-n.value;if(n.value=f,v<0)for(_=b;_>0&&d<u[parseInt(_-1)].value;){n=u[_],r=u[parseInt(_-1)];var w=r.proxy;r.stabbingCount++,1==r.IsUpper()?(this.TestOverlapBound(h,w)&&this.m_pairManager.AddBufferedPair(l,w),i=w.upperBounds,m=i[p],m++,i[p]=m,n.stabbingCount++):(i=w.lowerBounds,m=i[p],m++,i[p]=m,n.stabbingCount--),i=l.lowerBounds,m=i[p],m--,i[p]=m,n.Swap(r),--_}if(g>0)for(_=x;_<c-1&&u[parseInt(_+1)].value<=f;)n=u[_],s=u[parseInt(_+1)],a=s.proxy,s.stabbingCount++,1==s.IsLower()?(this.TestOverlapBound(h,a)&&this.m_pairManager.AddBufferedPair(l,a),i=a.lowerBounds,m=i[p],m--,i[p]=m,n.stabbingCount++):(i=a.upperBounds,m=i[p],m--,i[p]=m,n.stabbingCount--),i=l.upperBounds,m=i[p],m++,i[p]=m,n.Swap(s),_++;if(v>0)for(_=b;_<c-1&&u[parseInt(_+1)].value<=d;)n=u[_],s=u[parseInt(_+1)],a=s.proxy,s.stabbingCount--,s.IsUpper()?(this.TestOverlapBound(y,a)&&this.m_pairManager.RemoveBufferedPair(l,a),i=a.upperBounds,m=i[p],m--,i[p]=m,n.stabbingCount--):(i=a.lowerBounds,m=i[p],m--,i[p]=m,n.stabbingCount++),i=l.lowerBounds,m=i[p],m++,i[p]=m,n.Swap(s),_++;if(g<0)for(_=x;_>0&&f<u[parseInt(_-1)].value;)n=u[_],r=u[parseInt(_-1)],w=r.proxy,r.stabbingCount--,1==r.IsLower()?(this.TestOverlapBound(y,w)&&this.m_pairManager.RemoveBufferedPair(l,w),i=w.lowerBounds,m=i[p],m++,i[p]=m,n.stabbingCount--):(i=w.upperBounds,m=i[p],m++,i[p]=m,n.stabbingCount++),i=l.upperBounds,m=i[p],m--,i[p]=m,n.Swap(r),_--}}},b2BroadPhase.prototype.UpdatePairs=function(t){this.m_pairManager.Commit(t)},b2BroadPhase.prototype.TestOverlap=function(t,o){var e=t,i=o;return!(e.lowerBounds[0]>i.upperBounds[0])&&(!(i.lowerBounds[0]>e.upperBounds[0])&&(!(e.lowerBounds[1]>i.upperBounds[1])&&!(i.lowerBounds[1]>e.upperBounds[1])))},b2BroadPhase.prototype.GetUserData=function(t){return t.userData},b2BroadPhase.prototype.GetFatAABB=function(t){var o=new b2AABB,e=t;return o.lowerBound.x=this.m_worldAABB.lowerBound.x+this.m_bounds[0][e.lowerBounds[0]].value/this.m_quantizationFactor.x,o.lowerBound.y=this.m_worldAABB.lowerBound.y+this.m_bounds[1][e.lowerBounds[1]].value/this.m_quantizationFactor.y,o.upperBound.x=this.m_worldAABB.lowerBound.x+this.m_bounds[0][e.upperBounds[0]].value/this.m_quantizationFactor.x,o.upperBound.y=this.m_worldAABB.lowerBound.y+this.m_bounds[1][e.upperBounds[1]].value/this.m_quantizationFactor.y,o},b2BroadPhase.prototype.GetProxyCount=function(){return this.m_proxyCount},b2BroadPhase.prototype.Query=function(t,o){var e=new Array,i=new Array;this.ComputeBounds(e,i,o);var n=new Array;n.push(0);var r=new Array;r.push(0),this.QueryAxis(n,r,e[0],i[0],this.m_bounds[0],2*this.m_proxyCount,0),this.QueryAxis(n,r,e[1],i[1],this.m_bounds[1],2*this.m_proxyCount,1);for(var s=0;s<this.m_queryResultCount;++s){if(!t(this.m_queryResults[s]))break}this.m_queryResultCount=0,this.IncrementTimeStamp()},b2BroadPhase.prototype.Validate=function(){for(var t=0;t<2;++t)for(var o=this.m_bounds[t],e=2*this.m_proxyCount,i=0,n=0;n<e;++n){var r=o[n];1==r.IsLower()?i++:i--}},b2BroadPhase.prototype.Rebalance=function(t){},b2BroadPhase.prototype.RayCast=function(t,o){var e=new b2RayCastInput;e.p1.SetV(o.p1),e.p2.SetV(o.p2),e.maxFraction=o.maxFraction;var i=(o.p2.x-o.p1.x)*this.m_quantizationFactor.x,n=(o.p2.y-o.p1.y)*this.m_quantizationFactor.y,r=i<-Number.MIN_VALUE?-1:i>Number.MIN_VALUE?1:0,s=n<-Number.MIN_VALUE?-1:n>Number.MIN_VALUE?1:0,a=this.m_quantizationFactor.x*(o.p1.x-this.m_worldAABB.lowerBound.x),l=this.m_quantizationFactor.y*(o.p1.y-this.m_worldAABB.lowerBound.y),m=new Array,p=new Array;m[0]=parseInt(a)&b2Settings.USHRT_MAX-1,m[1]=parseInt(l)&b2Settings.USHRT_MAX-1,p[0]=m[0]+1,p[1]=m[1]+1;var _,c=(new Array,0),h=0,y=new Array;y.push(0);var u=new Array;u.push(0),this.QueryAxis(y,u,m[0],p[0],this.m_bounds[0],2*this.m_proxyCount,0),c=r>=0?u[0]-1:y[0],this.QueryAxis(y,u,m[1],p[1],this.m_bounds[1],2*this.m_proxyCount,1),h=s>=0?u[0]-1:y[0];for(var b=0;b<this.m_queryResultCount;b++)e.maxFraction=t(this.m_queryResults[b],e);for(;;){var x=0,d=0;if((c+=r>=0?1:-1)<0||c>=2*this.m_proxyCount)break;if(0!=r&&(x=(this.m_bounds[0][c].value-a)/i),(h+=s>=0?1:-1)<0||h>=2*this.m_proxyCount)break;for(0!=s&&(d=(this.m_bounds[1][h].value-l)/n);;)if(0==s||0!=r&&x<d){if(x>e.maxFraction)break;if((r>0?this.m_bounds[0][c].IsLower():this.m_bounds[0][c].IsUpper())&&(_=this.m_bounds[0][c].proxy,s>=0?_.lowerBounds[1]<=h-1&&_.upperBounds[1]>=h&&(e.maxFraction=t(_,e)):_.lowerBounds[1]<=h&&_.upperBounds[1]>=h+1&&(e.maxFraction=t(_,e))),0==e.maxFraction)break;if(r>0){if(++c==2*this.m_proxyCount)break}else if(--c<0)break;x=(this.m_bounds[0][c].value-a)/i}else{if(d>e.maxFraction)break;if((s>0?this.m_bounds[1][h].IsLower():this.m_bounds[1][h].IsUpper())&&(_=this.m_bounds[1][h].proxy,r>=0?_.lowerBounds[0]<=c-1&&_.upperBounds[0]>=c&&(e.maxFraction=t(_,e)):_.lowerBounds[0]<=c&&_.upperBounds[0]>=c+1&&(e.maxFraction=t(_,e))),0==e.maxFraction)break;if(s>0){if(++h==2*this.m_proxyCount)break}else if(--h<0)break;d=(this.m_bounds[1][h].value-l)/n}break}this.m_queryResultCount=0,this.IncrementTimeStamp()},b2BroadPhase.prototype.TestOverlapBound=function(t,o){for(var e=0;e<2;++e){var i=this.m_bounds[e],n=i[o.upperBounds[e]];if(t.lowerValues[e]>n.value)return!1;if(n=i[o.lowerBounds[e]],t.upperValues[e]<n.value)return!1}return!0},b2BroadPhase.prototype.m_pairManager=new b2PairManager,b2BroadPhase.prototype.m_proxyPool=new Array,b2BroadPhase.prototype.m_freeProxy=null,b2BroadPhase.prototype.m_bounds=null,b2BroadPhase.prototype.m_querySortKeys=new Array,b2BroadPhase.prototype.m_queryResults=new Array,b2BroadPhase.prototype.m_queryResultCount=0,b2BroadPhase.prototype.m_worldAABB=null,b2BroadPhase.prototype.m_quantizationFactor=new b2Vec2,b2BroadPhase.prototype.m_proxyCount=0,b2BroadPhase.prototype.m_timeStamp=0;var b2Manifold=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Manifold.prototype.__constructor=function(){this.m_points=new Array(b2Settings.b2_maxManifoldPoints);for(var t=0;t<b2Settings.b2_maxManifoldPoints;t++)this.m_points[t]=new b2ManifoldPoint;this.m_localPlaneNormal=new b2Vec2,this.m_localPoint=new b2Vec2},b2Manifold.prototype.__varz=function(){},b2Manifold.e_circles=1,b2Manifold.e_faceA=2,b2Manifold.e_faceB=4,b2Manifold.prototype.Reset=function(){for(var t=0;t<b2Settings.b2_maxManifoldPoints;t++)this.m_points[t].Reset();this.m_localPlaneNormal.SetZero(),this.m_localPoint.SetZero(),this.m_type=0,this.m_pointCount=0},b2Manifold.prototype.Set=function(t){this.m_pointCount=t.m_pointCount;for(var o=0;o<b2Settings.b2_maxManifoldPoints;o++)this.m_points[o].Set(t.m_points[o]);this.m_localPlaneNormal.SetV(t.m_localPlaneNormal),this.m_localPoint.SetV(t.m_localPoint),this.m_type=t.m_type},b2Manifold.prototype.Copy=function(){var t=new b2Manifold;return t.Set(this),t},b2Manifold.prototype.m_points=null,b2Manifold.prototype.m_localPlaneNormal=null,b2Manifold.prototype.m_localPoint=null,b2Manifold.prototype.m_type=0,b2Manifold.prototype.m_pointCount=0;var b2CircleShape=function(){b2Shape.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2CircleShape.prototype,b2Shape.prototype),b2CircleShape.prototype._super=b2Shape.prototype,b2CircleShape.prototype.__constructor=function(t){this._super.__constructor.apply(this,[]),this.m_type=b2Shape.e_circleShape,this.m_radius=t},b2CircleShape.prototype.__varz=function(){this.m_p=new b2Vec2},b2CircleShape.prototype.Copy=function(){var t=new b2CircleShape;return t.Set(this),t},b2CircleShape.prototype.Set=function(t){if(this._super.Set.apply(this,[t]),isInstanceOf(t,b2CircleShape)){var o=t;this.m_p.SetV(o.m_p)}},b2CircleShape.prototype.TestPoint=function(t,o){var e=t.R,i=t.position.x+(e.col1.x*this.m_p.x+e.col2.x*this.m_p.y),n=t.position.y+(e.col1.y*this.m_p.x+e.col2.y*this.m_p.y);return i=o.x-i,n=o.y-n,i*i+n*n<=this.m_radius*this.m_radius},b2CircleShape.prototype.RayCast=function(t,o,e){var i=e.R,n=e.position.x+(i.col1.x*this.m_p.x+i.col2.x*this.m_p.y),r=e.position.y+(i.col1.y*this.m_p.x+i.col2.y*this.m_p.y),s=o.p1.x-n,a=o.p1.y-r,l=s*s+a*a-this.m_radius*this.m_radius,m=o.p2.x-o.p1.x,p=o.p2.y-o.p1.y,_=s*m+a*p,c=m*m+p*p,h=_*_-c*l;if(h<0||c<Number.MIN_VALUE)return!1;var y=-(_+Math.sqrt(h));return 0<=y&&y<=o.maxFraction*c&&(y/=c,t.fraction=y,t.normal.x=s+y*m,t.normal.y=a+y*p,t.normal.Normalize(),!0)},b2CircleShape.prototype.ComputeAABB=function(t,o){var e=o.R,i=o.position.x+(e.col1.x*this.m_p.x+e.col2.x*this.m_p.y),n=o.position.y+(e.col1.y*this.m_p.x+e.col2.y*this.m_p.y);t.lowerBound.Set(i-this.m_radius,n-this.m_radius),t.upperBound.Set(i+this.m_radius,n+this.m_radius)},b2CircleShape.prototype.ComputeMass=function(t,o){t.mass=o*b2Settings.b2_pi*this.m_radius*this.m_radius,t.center.SetV(this.m_p),t.I=t.mass*(.5*this.m_radius*this.m_radius+(this.m_p.x*this.m_p.x+this.m_p.y*this.m_p.y))},b2CircleShape.prototype.ComputeSubmergedArea=function(t,o,e,i){var n=b2Math.MulX(e,this.m_p),r=-(b2Math.Dot(t,n)-o);if(r<-this.m_radius+Number.MIN_VALUE)return 0;if(r>this.m_radius)return i.SetV(n),Math.PI*this.m_radius*this.m_radius;var s=this.m_radius*this.m_radius,a=r*r,l=s*(Math.asin(r/this.m_radius)+Math.PI/2)+r*Math.sqrt(s-a),m=-2/3*Math.pow(s-a,1.5)/l;return i.x=n.x+t.x*m,i.y=n.y+t.y*m,l},b2CircleShape.prototype.GetLocalPosition=function(){return this.m_p},b2CircleShape.prototype.SetLocalPosition=function(t){this.m_p.SetV(t)},b2CircleShape.prototype.GetRadius=function(){return this.m_radius},b2CircleShape.prototype.SetRadius=function(t){this.m_radius=t},b2CircleShape.prototype.m_p=new b2Vec2;var b2Joint=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Joint.prototype.__constructor=function(t){b2Settings.b2Assert(t.bodyA!=t.bodyB),this.m_type=t.type,this.m_prev=null,this.m_next=null,this.m_bodyA=t.bodyA,this.m_bodyB=t.bodyB,this.m_collideConnected=t.collideConnected,this.m_islandFlag=!1,this.m_userData=t.userData},b2Joint.prototype.__varz=function(){this.m_edgeA=new b2JointEdge,this.m_edgeB=new b2JointEdge,this.m_localCenterA=new b2Vec2,this.m_localCenterB=new b2Vec2},b2Joint.Create=function(t,o){var e=null;switch(t.type){case b2Joint.e_distanceJoint:e=new b2DistanceJoint(t);break;case b2Joint.e_mouseJoint:e=new b2MouseJoint(t);break;case b2Joint.e_prismaticJoint:e=new b2PrismaticJoint(t);break;case b2Joint.e_revoluteJoint:e=new b2RevoluteJoint(t);break;case b2Joint.e_pulleyJoint:e=new b2PulleyJoint(t);break;case b2Joint.e_gearJoint:e=new b2GearJoint(t);break;case b2Joint.e_lineJoint:e=new b2LineJoint(t);break;case b2Joint.e_weldJoint:e=new b2WeldJoint(t);break;case b2Joint.e_frictionJoint:e=new b2FrictionJoint(t)}return e},b2Joint.Destroy=function(t,o){},b2Joint.e_unknownJoint=0,b2Joint.e_revoluteJoint=1,b2Joint.e_prismaticJoint=2,b2Joint.e_distanceJoint=3,b2Joint.e_pulleyJoint=4,b2Joint.e_mouseJoint=5,b2Joint.e_gearJoint=6,b2Joint.e_lineJoint=7,b2Joint.e_weldJoint=8,b2Joint.e_frictionJoint=9,b2Joint.e_inactiveLimit=0,b2Joint.e_atLowerLimit=1,b2Joint.e_atUpperLimit=2,b2Joint.e_equalLimits=3,b2Joint.prototype.InitVelocityConstraints=function(t){},b2Joint.prototype.SolveVelocityConstraints=function(t){},b2Joint.prototype.FinalizeVelocityConstraints=function(){},b2Joint.prototype.SolvePositionConstraints=function(t){return!1},b2Joint.prototype.GetType=function(){return this.m_type},b2Joint.prototype.GetAnchorA=function(){return null},b2Joint.prototype.GetAnchorB=function(){return null},b2Joint.prototype.GetReactionForce=function(t){return null},b2Joint.prototype.GetReactionTorque=function(t){return 0},b2Joint.prototype.GetBodyA=function(){return this.m_bodyA},b2Joint.prototype.GetBodyB=function(){return this.m_bodyB},b2Joint.prototype.GetNext=function(){return this.m_next},b2Joint.prototype.GetUserData=function(){return this.m_userData},b2Joint.prototype.SetUserData=function(t){this.m_userData=t},b2Joint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()},b2Joint.prototype.m_type=0,b2Joint.prototype.m_prev=null,b2Joint.prototype.m_next=null,b2Joint.prototype.m_edgeA=new b2JointEdge,b2Joint.prototype.m_edgeB=new b2JointEdge,b2Joint.prototype.m_bodyA=null,b2Joint.prototype.m_bodyB=null,b2Joint.prototype.m_islandFlag=null,b2Joint.prototype.m_collideConnected=null,b2Joint.prototype.m_userData=null,b2Joint.prototype.m_localCenterA=new b2Vec2,b2Joint.prototype.m_localCenterB=new b2Vec2,b2Joint.prototype.m_invMassA=null,b2Joint.prototype.m_invMassB=null,b2Joint.prototype.m_invIA=null,b2Joint.prototype.m_invIB=null;var b2LineJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2LineJoint.prototype,b2Joint.prototype),b2LineJoint.prototype._super=b2Joint.prototype,b2LineJoint.prototype.__constructor=function(t){this._super.__constructor.apply(this,[t]);this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_localXAxis1.SetV(t.localAxisA),this.m_localYAxis1.x=-this.m_localXAxis1.y,this.m_localYAxis1.y=this.m_localXAxis1.x,this.m_impulse.SetZero(),this.m_motorMass=0,this.m_motorImpulse=0,this.m_lowerTranslation=t.lowerTranslation,this.m_upperTranslation=t.upperTranslation,this.m_maxMotorForce=t.maxMotorForce,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=b2Joint.e_inactiveLimit,this.m_axis.SetZero(),this.m_perp.SetZero()},b2LineJoint.prototype.__varz=function(){this.m_localAnchor1=new b2Vec2,this.m_localAnchor2=new b2Vec2,this.m_localXAxis1=new b2Vec2,this.m_localYAxis1=new b2Vec2,this.m_axis=new b2Vec2,this.m_perp=new b2Vec2,this.m_K=new b2Mat22,this.m_impulse=new b2Vec2},b2LineJoint.prototype.InitVelocityConstraints=function(t){var o,e,i=this.m_bodyA,n=this.m_bodyB;this.m_localCenterA.SetV(i.GetLocalCenter()),this.m_localCenterB.SetV(n.GetLocalCenter());var r=i.GetTransform();n.GetTransform();o=i.m_xf.R;var s=this.m_localAnchor1.x-this.m_localCenterA.x,a=this.m_localAnchor1.y-this.m_localCenterA.y;e=o.col1.x*s+o.col2.x*a,a=o.col1.y*s+o.col2.y*a,s=e,o=n.m_xf.R;var l=this.m_localAnchor2.x-this.m_localCenterB.x,m=this.m_localAnchor2.y-this.m_localCenterB.y;e=o.col1.x*l+o.col2.x*m,m=o.col1.y*l+o.col2.y*m,l=e;var p=n.m_sweep.c.x+l-i.m_sweep.c.x-s,_=n.m_sweep.c.y+m-i.m_sweep.c.y-a;this.m_invMassA=i.m_invMass,this.m_invMassB=n.m_invMass,this.m_invIA=i.m_invI,this.m_invIB=n.m_invI,this.m_axis.SetV(b2Math.MulMV(r.R,this.m_localXAxis1)),this.m_a1=(p+s)*this.m_axis.y-(_+a)*this.m_axis.x,this.m_a2=l*this.m_axis.y-m*this.m_axis.x,this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2,this.m_motorMass=this.m_motorMass>Number.MIN_VALUE?1/this.m_motorMass:0,this.m_perp.SetV(b2Math.MulMV(r.R,this.m_localYAxis1)),this.m_s1=(p+s)*this.m_perp.y-(_+a)*this.m_perp.x,this.m_s2=l*this.m_perp.y-m*this.m_perp.x;var c=this.m_invMassA,h=this.m_invMassB,y=this.m_invIA,u=this.m_invIB;if(this.m_K.col1.x=c+h+y*this.m_s1*this.m_s1+u*this.m_s2*this.m_s2,this.m_K.col1.y=y*this.m_s1*this.m_a1+u*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=c+h+y*this.m_a1*this.m_a1+u*this.m_a2*this.m_a2,this.m_enableLimit){var b=this.m_axis.x*p+this.m_axis.y*_;b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop?this.m_limitState=b2Joint.e_equalLimits:b<=this.m_lowerTranslation?this.m_limitState!=b2Joint.e_atLowerLimit&&(this.m_limitState=b2Joint.e_atLowerLimit,this.m_impulse.y=0):b>=this.m_upperTranslation?this.m_limitState!=b2Joint.e_atUpperLimit&&(this.m_limitState=b2Joint.e_atUpperLimit,this.m_impulse.y=0):(this.m_limitState=b2Joint.e_inactiveLimit,this.m_impulse.y=0)}else this.m_limitState=b2Joint.e_inactiveLimit;if(0==this.m_enableMotor&&(this.m_motorImpulse=0),t.warmStarting){this.m_impulse.x*=t.dtRatio,this.m_impulse.y*=t.dtRatio,this.m_motorImpulse*=t.dtRatio;var x=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x,d=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y,f=this.m_impulse.x*this.m_s1+(this.m_motorImpulse+this.m_impulse.y)*this.m_a1,v=this.m_impulse.x*this.m_s2+(this.m_motorImpulse+this.m_impulse.y)*this.m_a2;i.m_linearVelocity.x-=this.m_invMassA*x,i.m_linearVelocity.y-=this.m_invMassA*d,i.m_angularVelocity-=this.m_invIA*f,n.m_linearVelocity.x+=this.m_invMassB*x,n.m_linearVelocity.y+=this.m_invMassB*d,n.m_angularVelocity+=this.m_invIB*v}else this.m_impulse.SetZero(),this.m_motorImpulse=0},b2LineJoint.prototype.SolveVelocityConstraints=function(t){var o,e,i,n,r=this.m_bodyA,s=this.m_bodyB,a=r.m_linearVelocity,l=r.m_angularVelocity,m=s.m_linearVelocity,p=s.m_angularVelocity;if(this.m_enableMotor&&this.m_limitState!=b2Joint.e_equalLimits){var _=this.m_axis.x*(m.x-a.x)+this.m_axis.y*(m.y-a.y)+this.m_a2*p-this.m_a1*l,c=this.m_motorMass*(this.m_motorSpeed-_),h=this.m_motorImpulse,y=t.dt*this.m_maxMotorForce;this.m_motorImpulse=b2Math.Clamp(this.m_motorImpulse+c,-y,y),c=this.m_motorImpulse-h,o=c*this.m_axis.x,e=c*this.m_axis.y,i=c*this.m_a1,n=c*this.m_a2,a.x-=this.m_invMassA*o,a.y-=this.m_invMassA*e,l-=this.m_invIA*i,m.x+=this.m_invMassB*o,m.y+=this.m_invMassB*e,p+=this.m_invIB*n}var u=this.m_perp.x*(m.x-a.x)+this.m_perp.y*(m.y-a.y)+this.m_s2*p-this.m_s1*l;if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){var b=this.m_axis.x*(m.x-a.x)+this.m_axis.y*(m.y-a.y)+this.m_a2*p-this.m_a1*l,x=this.m_impulse.Copy(),d=this.m_K.Solve(new b2Vec2,-u,-b);this.m_impulse.Add(d),this.m_limitState==b2Joint.e_atLowerLimit?this.m_impulse.y=b2Math.Max(this.m_impulse.y,0):this.m_limitState==b2Joint.e_atUpperLimit&&(this.m_impulse.y=b2Math.Min(this.m_impulse.y,0));var f,v=-u-(this.m_impulse.y-x.y)*this.m_K.col2.x;f=0!=this.m_K.col1.x?v/this.m_K.col1.x+x.x:x.x,this.m_impulse.x=f,d.x=this.m_impulse.x-x.x,d.y=this.m_impulse.y-x.y,o=d.x*this.m_perp.x+d.y*this.m_axis.x,e=d.x*this.m_perp.y+d.y*this.m_axis.y,i=d.x*this.m_s1+d.y*this.m_a1,n=d.x*this.m_s2+d.y*this.m_a2,a.x-=this.m_invMassA*o,a.y-=this.m_invMassA*e,l-=this.m_invIA*i,m.x+=this.m_invMassB*o,m.y+=this.m_invMassB*e,p+=this.m_invIB*n}else{var g;g=0!=this.m_K.col1.x?-u/this.m_K.col1.x:0,this.m_impulse.x+=g,o=g*this.m_perp.x,e=g*this.m_perp.y,i=g*this.m_s1,n=g*this.m_s2,a.x-=this.m_invMassA*o,a.y-=this.m_invMassA*e,l-=this.m_invIA*i,m.x+=this.m_invMassB*o,m.y+=this.m_invMassB*e,p+=this.m_invIB*n}r.m_linearVelocity.SetV(a),r.m_angularVelocity=l,s.m_linearVelocity.SetV(m),s.m_angularVelocity=p},b2LineJoint.prototype.SolvePositionConstraints=function(t){var o,e,i,n,r,s,a=this.m_bodyA,l=this.m_bodyB,m=a.m_sweep.c,p=a.m_sweep.a,_=l.m_sweep.c,c=l.m_sweep.a,h=0,y=0,u=!1,b=0,x=b2Mat22.FromAngle(p),d=b2Mat22.FromAngle(c);o=x;var f=this.m_localAnchor1.x-this.m_localCenterA.x,v=this.m_localAnchor1.y-this.m_localCenterA.y;e=o.col1.x*f+o.col2.x*v,v=o.col1.y*f+o.col2.y*v,f=e,o=d;var g=this.m_localAnchor2.x-this.m_localCenterB.x,w=this.m_localAnchor2.y-this.m_localCenterB.y;e=o.col1.x*g+o.col2.x*w,w=o.col1.y*g+o.col2.y*w,g=e;var S=_.x+g-m.x-f,C=_.y+w-m.y-v;if(this.m_enableLimit){this.m_axis=b2Math.MulMV(x,this.m_localXAxis1),this.m_a1=(S+f)*this.m_axis.y-(C+v)*this.m_axis.x,this.m_a2=g*this.m_axis.y-w*this.m_axis.x;var A=this.m_axis.x*S+this.m_axis.y*C;b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop?(b=b2Math.Clamp(A,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection),h=b2Math.Abs(A),u=!0):A<=this.m_lowerTranslation?(b=b2Math.Clamp(A-this.m_lowerTranslation+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0),h=this.m_lowerTranslation-A,u=!0):A>=this.m_upperTranslation&&(b=b2Math.Clamp(A-this.m_upperTranslation+b2Settings.b2_linearSlop,0,b2Settings.b2_maxLinearCorrection),h=A-this.m_upperTranslation,u=!0)}this.m_perp=b2Math.MulMV(x,this.m_localYAxis1),this.m_s1=(S+f)*this.m_perp.y-(C+v)*this.m_perp.x,this.m_s2=g*this.m_perp.y-w*this.m_perp.x;var B=new b2Vec2,M=this.m_perp.x*S+this.m_perp.y*C;if(h=b2Math.Max(h,b2Math.Abs(M)),y=0,u)i=this.m_invMassA,n=this.m_invMassB,r=this.m_invIA,s=this.m_invIB,this.m_K.col1.x=i+n+r*this.m_s1*this.m_s1+s*this.m_s2*this.m_s2,this.m_K.col1.y=r*this.m_s1*this.m_a1+s*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=i+n+r*this.m_a1*this.m_a1+s*this.m_a2*this.m_a2,this.m_K.Solve(B,-M,-b);else{i=this.m_invMassA,n=this.m_invMassB,r=this.m_invIA,s=this.m_invIB;var V,I=i+n+r*this.m_s1*this.m_s1+s*this.m_s2*this.m_s2;V=0!=I?-M/I:0,B.x=V,B.y=0}var P=B.x*this.m_perp.x+B.y*this.m_axis.x,D=B.x*this.m_perp.y+B.y*this.m_axis.y,J=B.x*this.m_s1+B.y*this.m_a1,L=B.x*this.m_s2+B.y*this.m_a2;return m.x-=this.m_invMassA*P,m.y-=this.m_invMassA*D,p-=this.m_invIA*J,_.x+=this.m_invMassB*P,_.y+=this.m_invMassB*D,c+=this.m_invIB*L,a.m_sweep.a=p,l.m_sweep.a=c,a.SynchronizeTransform(),l.SynchronizeTransform(),h<=b2Settings.b2_linearSlop&&y<=b2Settings.b2_angularSlop},b2LineJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},b2LineJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},b2LineJoint.prototype.GetReactionForce=function(t){return new b2Vec2(t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x),t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y))},b2LineJoint.prototype.GetReactionTorque=function(t){return t*this.m_impulse.y},b2LineJoint.prototype.GetJointTranslation=function(){var t=this.m_bodyA,o=this.m_bodyB,e=t.GetWorldPoint(this.m_localAnchor1),i=o.GetWorldPoint(this.m_localAnchor2),n=i.x-e.x,r=i.y-e.y,s=t.GetWorldVector(this.m_localXAxis1);return s.x*n+s.y*r},b2LineJoint.prototype.GetJointSpeed=function(){var t,o=this.m_bodyA,e=this.m_bodyB;t=o.m_xf.R;var i=this.m_localAnchor1.x-o.m_sweep.localCenter.x,n=this.m_localAnchor1.y-o.m_sweep.localCenter.y,r=t.col1.x*i+t.col2.x*n;n=t.col1.y*i+t.col2.y*n,i=r,t=e.m_xf.R;var s=this.m_localAnchor2.x-e.m_sweep.localCenter.x,a=this.m_localAnchor2.y-e.m_sweep.localCenter.y;r=t.col1.x*s+t.col2.x*a,a=t.col1.y*s+t.col2.y*a,s=r;var l=o.m_sweep.c.x+i,m=o.m_sweep.c.y+n,p=e.m_sweep.c.x+s,_=e.m_sweep.c.y+a,c=p-l,h=_-m,y=o.GetWorldVector(this.m_localXAxis1),u=o.m_linearVelocity,b=e.m_linearVelocity,x=o.m_angularVelocity,d=e.m_angularVelocity;return c*-x*y.y+h*x*y.x+(y.x*(b.x+-d*a-u.x- -x*n)+y.y*(b.y+d*s-u.y-x*i))},b2LineJoint.prototype.IsLimitEnabled=function(){return this.m_enableLimit},b2LineJoint.prototype.EnableLimit=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t},b2LineJoint.prototype.GetLowerLimit=function(){return this.m_lowerTranslation},b2LineJoint.prototype.GetUpperLimit=function(){return this.m_upperTranslation},b2LineJoint.prototype.SetLimits=function(t,o){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=o},b2LineJoint.prototype.IsMotorEnabled=function(){return this.m_enableMotor},b2LineJoint.prototype.EnableMotor=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t},b2LineJoint.prototype.SetMotorSpeed=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},b2LineJoint.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},b2LineJoint.prototype.SetMaxMotorForce=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t},b2LineJoint.prototype.GetMaxMotorForce=function(){return this.m_maxMotorForce},b2LineJoint.prototype.GetMotorForce=function(){return this.m_motorImpulse},b2LineJoint.prototype.m_localAnchor1=new b2Vec2,b2LineJoint.prototype.m_localAnchor2=new b2Vec2,b2LineJoint.prototype.m_localXAxis1=new b2Vec2,b2LineJoint.prototype.m_localYAxis1=new b2Vec2,b2LineJoint.prototype.m_axis=new b2Vec2,b2LineJoint.prototype.m_perp=new b2Vec2,b2LineJoint.prototype.m_s1=null,b2LineJoint.prototype.m_s2=null,b2LineJoint.prototype.m_a1=null,b2LineJoint.prototype.m_a2=null,b2LineJoint.prototype.m_K=new b2Mat22,b2LineJoint.prototype.m_impulse=new b2Vec2,b2LineJoint.prototype.m_motorMass=null,b2LineJoint.prototype.m_motorImpulse=null,b2LineJoint.prototype.m_lowerTranslation=null,b2LineJoint.prototype.m_upperTranslation=null,b2LineJoint.prototype.m_maxMotorForce=null,b2LineJoint.prototype.m_motorSpeed=null,b2LineJoint.prototype.m_enableLimit=null,b2LineJoint.prototype.m_enableMotor=null,b2LineJoint.prototype.m_limitState=0;var b2ContactSolver=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactSolver.prototype.__constructor=function(){},b2ContactSolver.prototype.__varz=function(){this.m_step=new b2TimeStep,this.m_constraints=new Array}, b2ContactSolver.s_worldManifold=new b2WorldManifold,b2ContactSolver.s_psm=new b2PositionSolverManifold,b2ContactSolver.prototype.Initialize=function(t,o,e,i){var n;this.m_step.Set(t),this.m_allocator=i;var r=0;for(this.m_constraintCount=e;this.m_constraints.length<this.m_constraintCount;)this.m_constraints[this.m_constraints.length]=new b2ContactConstraint;for(r=0;r<e;++r){n=o[r];var s=n.m_fixtureA,a=n.m_fixtureB,l=s.m_shape,m=a.m_shape,p=l.m_radius,_=m.m_radius,c=s.m_body,h=a.m_body,y=n.GetManifold(),u=b2Settings.b2MixFriction(s.GetFriction(),a.GetFriction()),b=b2Settings.b2MixRestitution(s.GetRestitution(),a.GetRestitution()),x=c.m_linearVelocity.x,d=c.m_linearVelocity.y,f=h.m_linearVelocity.x,v=h.m_linearVelocity.y,g=c.m_angularVelocity,w=h.m_angularVelocity;b2Settings.b2Assert(y.m_pointCount>0),b2ContactSolver.s_worldManifold.Initialize(y,c.m_xf,p,h.m_xf,_);var S=b2ContactSolver.s_worldManifold.m_normal.x,C=b2ContactSolver.s_worldManifold.m_normal.y,A=this.m_constraints[r];A.bodyA=c,A.bodyB=h,A.manifold=y,A.normal.x=S,A.normal.y=C,A.pointCount=y.m_pointCount,A.friction=u,A.restitution=b,A.localPlaneNormal.x=y.m_localPlaneNormal.x,A.localPlaneNormal.y=y.m_localPlaneNormal.y,A.localPoint.x=y.m_localPoint.x,A.localPoint.y=y.m_localPoint.y,A.radius=p+_,A.type=y.m_type;for(var B=0;B<A.pointCount;++B){var M=y.m_points[B],V=A.points[B];V.normalImpulse=M.m_normalImpulse,V.tangentImpulse=M.m_tangentImpulse,V.localPoint.SetV(M.m_localPoint);var I=V.rA.x=b2ContactSolver.s_worldManifold.m_points[B].x-c.m_sweep.c.x,P=V.rA.y=b2ContactSolver.s_worldManifold.m_points[B].y-c.m_sweep.c.y,D=V.rB.x=b2ContactSolver.s_worldManifold.m_points[B].x-h.m_sweep.c.x,J=V.rB.y=b2ContactSolver.s_worldManifold.m_points[B].y-h.m_sweep.c.y,L=I*C-P*S,G=D*C-J*S;L*=L,G*=G;var F=c.m_invMass+h.m_invMass+c.m_invI*L+h.m_invI*G;V.normalMass=1/F;var T=c.m_mass*c.m_invMass+h.m_mass*h.m_invMass;T+=c.m_mass*c.m_invI*L+h.m_mass*h.m_invI*G,V.equalizedMass=1/T;var R=C,z=-S,E=I*z-P*R,k=D*z-J*R;E*=E,k*=k;var N=c.m_invMass+h.m_invMass+c.m_invI*E+h.m_invI*k;V.tangentMass=1/N,V.velocityBias=0;var W=f+-w*J-x- -g*P,O=v+w*D-d-g*I,q=A.normal.x*W+A.normal.y*O;q<-b2Settings.b2_velocityThreshold&&(V.velocityBias+=-A.restitution*q)}if(2==A.pointCount){var K=A.points[0],U=A.points[1],j=c.m_invMass,X=c.m_invI,Z=h.m_invMass,H=h.m_invI,Y=K.rA.x*C-K.rA.y*S,Q=K.rB.x*C-K.rB.y*S,$=U.rA.x*C-U.rA.y*S,tt=U.rB.x*C-U.rB.y*S,ot=j+Z+X*Y*Y+H*Q*Q,et=j+Z+X*$*$+H*tt*tt,it=j+Z+X*Y*$+H*Q*tt;ot*ot<100*(ot*et-it*it)?(A.K.col1.Set(ot,it),A.K.col2.Set(it,et),A.K.GetInverse(A.normalMass)):A.pointCount=1}}},b2ContactSolver.prototype.InitVelocityConstraints=function(t){for(var o=0;o<this.m_constraintCount;++o){var e=this.m_constraints[o],i=e.bodyA,n=e.bodyB,r=i.m_invMass,s=i.m_invI,a=n.m_invMass,l=n.m_invI,m=e.normal.x,p=e.normal.y,_=p,c=-m,h=0,y=0;if(t.warmStarting)for(y=e.pointCount,h=0;h<y;++h){var u=e.points[h];u.normalImpulse*=t.dtRatio,u.tangentImpulse*=t.dtRatio;var b=u.normalImpulse*m+u.tangentImpulse*_,x=u.normalImpulse*p+u.tangentImpulse*c;i.m_angularVelocity-=s*(u.rA.x*x-u.rA.y*b),i.m_linearVelocity.x-=r*b,i.m_linearVelocity.y-=r*x,n.m_angularVelocity+=l*(u.rB.x*x-u.rB.y*b),n.m_linearVelocity.x+=a*b,n.m_linearVelocity.y+=a*x}else for(y=e.pointCount,h=0;h<y;++h){var d=e.points[h];d.normalImpulse=0,d.tangentImpulse=0}}},b2ContactSolver.prototype.SolveVelocityConstraints=function(){for(var t,o,e,i,n,r,s,a,l,m,p,_,c,h,y,u,b,x=0,d=0;d<this.m_constraintCount;++d){var f=this.m_constraints[d],v=f.bodyA,g=f.bodyB,w=v.m_angularVelocity,S=g.m_angularVelocity,C=v.m_linearVelocity,A=g.m_linearVelocity,B=v.m_invMass,M=v.m_invI,V=g.m_invMass,I=g.m_invI,P=f.normal.x,D=f.normal.y,J=D,L=-P,G=f.friction;for(x=0;x<f.pointCount;x++)t=f.points[x],o=A.x-S*t.rB.y-C.x+w*t.rA.y,e=A.y+S*t.rB.x-C.y-w*t.rA.x,n=o*J+e*L,r=t.tangentMass*-n,s=G*t.normalImpulse,a=b2Math.Clamp(t.tangentImpulse+r,-s,s),r=a-t.tangentImpulse,l=r*J,m=r*L,C.x-=B*l,C.y-=B*m,w-=M*(t.rA.x*m-t.rA.y*l),A.x+=V*l,A.y+=V*m,S+=I*(t.rB.x*m-t.rB.y*l),t.tangentImpulse=a;f.pointCount;if(1==f.pointCount)t=f.points[0],o=A.x+-S*t.rB.y-C.x- -w*t.rA.y,e=A.y+S*t.rB.x-C.y-w*t.rA.x,i=o*P+e*D,r=-t.normalMass*(i-t.velocityBias),a=t.normalImpulse+r,a=a>0?a:0,r=a-t.normalImpulse,l=r*P,m=r*D,C.x-=B*l,C.y-=B*m,w-=M*(t.rA.x*m-t.rA.y*l),A.x+=V*l,A.y+=V*m,S+=I*(t.rB.x*m-t.rB.y*l),t.normalImpulse=a;else{var F=f.points[0],T=f.points[1],R=F.normalImpulse,z=T.normalImpulse,E=A.x-S*F.rB.y-C.x+w*F.rA.y,k=A.y+S*F.rB.x-C.y-w*F.rA.x,N=A.x-S*T.rB.y-C.x+w*T.rA.y,W=A.y+S*T.rB.x-C.y-w*T.rA.x,O=E*P+k*D,q=N*P+W*D,K=O-F.velocityBias,U=q-T.velocityBias;b=f.K,K-=b.col1.x*R+b.col2.x*z,U-=b.col1.y*R+b.col2.y*z;for(;;){b=f.normalMass;var j=-(b.col1.x*K+b.col2.x*U),X=-(b.col1.y*K+b.col2.y*U);if(j>=0&&X>=0){p=j-R,_=X-z,c=p*P,h=p*D,y=_*P,u=_*D,C.x-=B*(c+y),C.y-=B*(h+u),w-=M*(F.rA.x*h-F.rA.y*c+T.rA.x*u-T.rA.y*y),A.x+=V*(c+y),A.y+=V*(h+u),S+=I*(F.rB.x*h-F.rB.y*c+T.rB.x*u-T.rB.y*y),F.normalImpulse=j,T.normalImpulse=X;break}if(j=-F.normalMass*K,X=0,O=0,q=f.K.col1.y*j+U,j>=0&&q>=0){p=j-R,_=X-z,c=p*P,h=p*D,y=_*P,u=_*D,C.x-=B*(c+y),C.y-=B*(h+u),w-=M*(F.rA.x*h-F.rA.y*c+T.rA.x*u-T.rA.y*y),A.x+=V*(c+y),A.y+=V*(h+u),S+=I*(F.rB.x*h-F.rB.y*c+T.rB.x*u-T.rB.y*y),F.normalImpulse=j,T.normalImpulse=X;break}if(j=0,X=-T.normalMass*U,O=f.K.col2.x*X+K,q=0,X>=0&&O>=0){p=j-R,_=X-z,c=p*P,h=p*D,y=_*P,u=_*D,C.x-=B*(c+y),C.y-=B*(h+u),w-=M*(F.rA.x*h-F.rA.y*c+T.rA.x*u-T.rA.y*y),A.x+=V*(c+y),A.y+=V*(h+u),S+=I*(F.rB.x*h-F.rB.y*c+T.rB.x*u-T.rB.y*y),F.normalImpulse=j,T.normalImpulse=X;break}if(j=0,X=0,O=K,q=U,O>=0&&q>=0){p=j-R,_=X-z,c=p*P,h=p*D,y=_*P,u=_*D,C.x-=B*(c+y),C.y-=B*(h+u),w-=M*(F.rA.x*h-F.rA.y*c+T.rA.x*u-T.rA.y*y),A.x+=V*(c+y),A.y+=V*(h+u),S+=I*(F.rB.x*h-F.rB.y*c+T.rB.x*u-T.rB.y*y),F.normalImpulse=j,T.normalImpulse=X;break}break}}v.m_angularVelocity=w,g.m_angularVelocity=S}},b2ContactSolver.prototype.FinalizeVelocityConstraints=function(){for(var t=0;t<this.m_constraintCount;++t)for(var o=this.m_constraints[t],e=o.manifold,i=0;i<o.pointCount;++i){var n=e.m_points[i],r=o.points[i];n.m_normalImpulse=r.normalImpulse,n.m_tangentImpulse=r.tangentImpulse}},b2ContactSolver.prototype.SolvePositionConstraints=function(t){for(var o=0,e=0;e<this.m_constraintCount;e++){var i=this.m_constraints[e],n=i.bodyA,r=i.bodyB,s=n.m_mass*n.m_invMass,a=n.m_mass*n.m_invI,l=r.m_mass*r.m_invMass,m=r.m_mass*r.m_invI;b2ContactSolver.s_psm.Initialize(i);for(var p=b2ContactSolver.s_psm.m_normal,_=0;_<i.pointCount;_++){var c=i.points[_],h=b2ContactSolver.s_psm.m_points[_],y=b2ContactSolver.s_psm.m_separations[_],u=h.x-n.m_sweep.c.x,b=h.y-n.m_sweep.c.y,x=h.x-r.m_sweep.c.x,d=h.y-r.m_sweep.c.y;o=o<y?o:y;var f=b2Math.Clamp(t*(y+b2Settings.b2_linearSlop),-b2Settings.b2_maxLinearCorrection,0),v=-c.equalizedMass*f,g=v*p.x,w=v*p.y;n.m_sweep.c.x-=s*g,n.m_sweep.c.y-=s*w,n.m_sweep.a-=a*(u*w-b*g),n.SynchronizeTransform(),r.m_sweep.c.x+=l*g,r.m_sweep.c.y+=l*w,r.m_sweep.a+=m*(x*w-d*g),r.SynchronizeTransform()}}return o>-1.5*b2Settings.b2_linearSlop},b2ContactSolver.prototype.m_step=new b2TimeStep,b2ContactSolver.prototype.m_allocator=null,b2ContactSolver.prototype.m_constraints=new Array,b2ContactSolver.prototype.m_constraintCount=0;var b2Simplex=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Simplex.prototype.__constructor=function(){this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3},b2Simplex.prototype.__varz=function(){this.m_v1=new b2SimplexVertex,this.m_v2=new b2SimplexVertex,this.m_v3=new b2SimplexVertex,this.m_vertices=new Array(3)},b2Simplex.prototype.ReadCache=function(t,o,e,i,n){b2Settings.b2Assert(0<=t.count&&t.count<=3);var r,s;this.m_count=t.count;for(var a=this.m_vertices,l=0;l<this.m_count;l++){var m=a[l];m.indexA=t.indexA[l],m.indexB=t.indexB[l],r=o.GetVertex(m.indexA),s=i.GetVertex(m.indexB),m.wA=b2Math.MulX(e,r),m.wB=b2Math.MulX(n,s),m.w=b2Math.SubtractVV(m.wB,m.wA),m.a=0}if(this.m_count>1){var p=t.metric,_=this.GetMetric();(_<.5*p||2*p<_||_<Number.MIN_VALUE)&&(this.m_count=0)}0==this.m_count&&(m=a[0],m.indexA=0,m.indexB=0,r=o.GetVertex(0),s=i.GetVertex(0),m.wA=b2Math.MulX(e,r),m.wB=b2Math.MulX(n,s),m.w=b2Math.SubtractVV(m.wB,m.wA),this.m_count=1)},b2Simplex.prototype.WriteCache=function(t){t.metric=this.GetMetric(),t.count=parseInt(this.m_count);for(var o=this.m_vertices,e=0;e<this.m_count;e++)t.indexA[e]=parseInt(o[e].indexA),t.indexB[e]=parseInt(o[e].indexB)},b2Simplex.prototype.GetSearchDirection=function(){switch(this.m_count){case 1:return this.m_v1.w.GetNegative();case 2:var t=b2Math.SubtractVV(this.m_v2.w,this.m_v1.w);return b2Math.CrossVV(t,this.m_v1.w.GetNegative())>0?b2Math.CrossFV(1,t):b2Math.CrossVF(t,1);default:return b2Settings.b2Assert(!1),new b2Vec2}},b2Simplex.prototype.GetClosestPoint=function(){switch(this.m_count){case 0:return b2Settings.b2Assert(!1),new b2Vec2;case 1:return this.m_v1.w;case 2:return new b2Vec2(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);default:return b2Settings.b2Assert(!1),new b2Vec2}},b2Simplex.prototype.GetWitnessPoints=function(t,o){switch(this.m_count){case 0:b2Settings.b2Assert(!1);break;case 1:t.SetV(this.m_v1.wA),o.SetV(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,o.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,o.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:o.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,o.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y;break;default:b2Settings.b2Assert(!1)}},b2Simplex.prototype.GetMetric=function(){switch(this.m_count){case 0:return b2Settings.b2Assert(!1),0;case 1:return 0;case 2:return b2Math.SubtractVV(this.m_v1.w,this.m_v2.w).Length();case 3:return b2Math.CrossVV(b2Math.SubtractVV(this.m_v2.w,this.m_v1.w),b2Math.SubtractVV(this.m_v3.w,this.m_v1.w));default:return b2Settings.b2Assert(!1),0}},b2Simplex.prototype.Solve2=function(){var t=this.m_v1.w,o=this.m_v2.w,e=b2Math.SubtractVV(o,t),i=-(t.x*e.x+t.y*e.y);if(i<=0)return this.m_v1.a=1,void(this.m_count=1);var n=o.x*e.x+o.y*e.y;if(n<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Set(this.m_v2);var r=1/(n+i);this.m_v1.a=n*r,this.m_v2.a=i*r,this.m_count=2},b2Simplex.prototype.Solve3=function(){var t=this.m_v1.w,o=this.m_v2.w,e=this.m_v3.w,i=b2Math.SubtractVV(o,t),n=b2Math.Dot(t,i),r=b2Math.Dot(o,i),s=r,a=-n,l=b2Math.SubtractVV(e,t),m=b2Math.Dot(t,l),p=b2Math.Dot(e,l),_=p,c=-m,h=b2Math.SubtractVV(e,o),y=b2Math.Dot(o,h),u=b2Math.Dot(e,h),b=u,x=-y,d=b2Math.CrossVV(i,l),f=d*b2Math.CrossVV(o,e),v=d*b2Math.CrossVV(e,t),g=d*b2Math.CrossVV(t,o);if(a<=0&&c<=0)return this.m_v1.a=1,void(this.m_count=1);if(s>0&&a>0&&g<=0){var w=1/(s+a);return this.m_v1.a=s*w,this.m_v2.a=a*w,void(this.m_count=2)}if(_>0&&c>0&&v<=0){var S=1/(_+c);return this.m_v1.a=_*S,this.m_v3.a=c*S,this.m_count=2,void this.m_v2.Set(this.m_v3)}if(s<=0&&x<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Set(this.m_v2);if(_<=0&&b<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Set(this.m_v3);if(b>0&&x>0&&f<=0){var C=1/(b+x);return this.m_v2.a=b*C,this.m_v3.a=x*C,this.m_count=2,void this.m_v1.Set(this.m_v3)}var A=1/(f+v+g);this.m_v1.a=f*A,this.m_v2.a=v*A,this.m_v3.a=g*A,this.m_count=3},b2Simplex.prototype.m_v1=new b2SimplexVertex,b2Simplex.prototype.m_v2=new b2SimplexVertex,b2Simplex.prototype.m_v3=new b2SimplexVertex,b2Simplex.prototype.m_vertices=new Array(3),b2Simplex.prototype.m_count=0;var b2WeldJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2WeldJoint.prototype,b2Joint.prototype),b2WeldJoint.prototype._super=b2Joint.prototype,b2WeldJoint.prototype.__constructor=function(t){this._super.__constructor.apply(this,[t]),this.m_localAnchorA.SetV(t.localAnchorA),this.m_localAnchorB.SetV(t.localAnchorB),this.m_referenceAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_mass=new b2Mat33},b2WeldJoint.prototype.__varz=function(){this.m_localAnchorA=new b2Vec2,this.m_localAnchorB=new b2Vec2,this.m_impulse=new b2Vec3,this.m_mass=new b2Mat33},b2WeldJoint.prototype.InitVelocityConstraints=function(t){var o,e,i=this.m_bodyA,n=this.m_bodyB;o=i.m_xf.R;var r=this.m_localAnchorA.x-i.m_sweep.localCenter.x,s=this.m_localAnchorA.y-i.m_sweep.localCenter.y;e=o.col1.x*r+o.col2.x*s,s=o.col1.y*r+o.col2.y*s,r=e,o=n.m_xf.R;var a=this.m_localAnchorB.x-n.m_sweep.localCenter.x,l=this.m_localAnchorB.y-n.m_sweep.localCenter.y;e=o.col1.x*a+o.col2.x*l,l=o.col1.y*a+o.col2.y*l,a=e;var m=i.m_invMass,p=n.m_invMass,_=i.m_invI,c=n.m_invI;this.m_mass.col1.x=m+p+s*s*_+l*l*c,this.m_mass.col2.x=-s*r*_-l*a*c,this.m_mass.col3.x=-s*_-l*c,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=m+p+r*r*_+a*a*c,this.m_mass.col3.y=r*_+a*c,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=_+c,t.warmStarting?(this.m_impulse.x*=t.dtRatio,this.m_impulse.y*=t.dtRatio,this.m_impulse.z*=t.dtRatio,i.m_linearVelocity.x-=m*this.m_impulse.x,i.m_linearVelocity.y-=m*this.m_impulse.y,i.m_angularVelocity-=_*(r*this.m_impulse.y-s*this.m_impulse.x+this.m_impulse.z),n.m_linearVelocity.x+=p*this.m_impulse.x,n.m_linearVelocity.y+=p*this.m_impulse.y,n.m_angularVelocity+=c*(a*this.m_impulse.y-l*this.m_impulse.x+this.m_impulse.z)):this.m_impulse.SetZero()},b2WeldJoint.prototype.SolveVelocityConstraints=function(t){var o,e,i=this.m_bodyA,n=this.m_bodyB,r=i.m_linearVelocity,s=i.m_angularVelocity,a=n.m_linearVelocity,l=n.m_angularVelocity,m=i.m_invMass,p=n.m_invMass,_=i.m_invI,c=n.m_invI;o=i.m_xf.R;var h=this.m_localAnchorA.x-i.m_sweep.localCenter.x,y=this.m_localAnchorA.y-i.m_sweep.localCenter.y;e=o.col1.x*h+o.col2.x*y,y=o.col1.y*h+o.col2.y*y,h=e,o=n.m_xf.R;var u=this.m_localAnchorB.x-n.m_sweep.localCenter.x,b=this.m_localAnchorB.y-n.m_sweep.localCenter.y;e=o.col1.x*u+o.col2.x*b,b=o.col1.y*u+o.col2.y*b,u=e;var x=a.x-l*b-r.x+s*y,d=a.y+l*u-r.y-s*h,f=l-s,v=new b2Vec3;this.m_mass.Solve33(v,-x,-d,-f),this.m_impulse.Add(v),r.x-=m*v.x,r.y-=m*v.y,s-=_*(h*v.y-y*v.x+v.z),a.x+=p*v.x,a.y+=p*v.y,l+=c*(u*v.y-b*v.x+v.z),i.m_angularVelocity=s,n.m_angularVelocity=l},b2WeldJoint.prototype.SolvePositionConstraints=function(t){var o,e,i=this.m_bodyA,n=this.m_bodyB;o=i.m_xf.R;var r=this.m_localAnchorA.x-i.m_sweep.localCenter.x,s=this.m_localAnchorA.y-i.m_sweep.localCenter.y;e=o.col1.x*r+o.col2.x*s,s=o.col1.y*r+o.col2.y*s,r=e,o=n.m_xf.R;var a=this.m_localAnchorB.x-n.m_sweep.localCenter.x,l=this.m_localAnchorB.y-n.m_sweep.localCenter.y;e=o.col1.x*a+o.col2.x*l,l=o.col1.y*a+o.col2.y*l,a=e;var m=i.m_invMass,p=n.m_invMass,_=i.m_invI,c=n.m_invI,h=n.m_sweep.c.x+a-i.m_sweep.c.x-r,y=n.m_sweep.c.y+l-i.m_sweep.c.y-s,u=n.m_sweep.a-i.m_sweep.a-this.m_referenceAngle,b=10*b2Settings.b2_linearSlop,x=Math.sqrt(h*h+y*y),d=b2Math.Abs(u);x>b&&(_*=1,c*=1),this.m_mass.col1.x=m+p+s*s*_+l*l*c,this.m_mass.col2.x=-s*r*_-l*a*c,this.m_mass.col3.x=-s*_-l*c,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=m+p+r*r*_+a*a*c,this.m_mass.col3.y=r*_+a*c,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=_+c;var f=new b2Vec3;return this.m_mass.Solve33(f,-h,-y,-u),i.m_sweep.c.x-=m*f.x,i.m_sweep.c.y-=m*f.y,i.m_sweep.a-=_*(r*f.y-s*f.x+f.z),n.m_sweep.c.x+=p*f.x,n.m_sweep.c.y+=p*f.y,n.m_sweep.a+=c*(a*f.y-l*f.x+f.z),i.SynchronizeTransform(),n.SynchronizeTransform(),x<=b2Settings.b2_linearSlop&&d<=b2Settings.b2_angularSlop},b2WeldJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)},b2WeldJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)},b2WeldJoint.prototype.GetReactionForce=function(t){return new b2Vec2(t*this.m_impulse.x,t*this.m_impulse.y)},b2WeldJoint.prototype.GetReactionTorque=function(t){return t*this.m_impulse.z},b2WeldJoint.prototype.m_localAnchorA=new b2Vec2,b2WeldJoint.prototype.m_localAnchorB=new b2Vec2,b2WeldJoint.prototype.m_referenceAngle=null,b2WeldJoint.prototype.m_impulse=new b2Vec3,b2WeldJoint.prototype.m_mass=new b2Mat33;var b2Math=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Math.prototype.__constructor=function(){},b2Math.prototype.__varz=function(){},b2Math.IsValid=function(t){return isFinite(t)},b2Math.Dot=function(t,o){return t.x*o.x+t.y*o.y},b2Math.CrossVV=function(t,o){return t.x*o.y-t.y*o.x},b2Math.CrossVF=function(t,o){return new b2Vec2(o*t.y,-o*t.x)},b2Math.CrossFV=function(t,o){return new b2Vec2(-t*o.y,t*o.x)},b2Math.MulMV=function(t,o){return new b2Vec2(t.col1.x*o.x+t.col2.x*o.y,t.col1.y*o.x+t.col2.y*o.y)},b2Math.MulTMV=function(t,o){return new b2Vec2(b2Math.Dot(o,t.col1),b2Math.Dot(o,t.col2))},b2Math.MulX=function(t,o){var e=b2Math.MulMV(t.R,o);return e.x+=t.position.x,e.y+=t.position.y,e},b2Math.MulXT=function(t,o){var e=b2Math.SubtractVV(o,t.position),i=e.x*t.R.col1.x+e.y*t.R.col1.y;return e.y=e.x*t.R.col2.x+e.y*t.R.col2.y,e.x=i,e},b2Math.AddVV=function(t,o){return new b2Vec2(t.x+o.x,t.y+o.y)},b2Math.SubtractVV=function(t,o){return new b2Vec2(t.x-o.x,t.y-o.y)},b2Math.Distance=function(t,o){var e=t.x-o.x,i=t.y-o.y;return Math.sqrt(e*e+i*i)},b2Math.DistanceSquared=function(t,o){var e=t.x-o.x,i=t.y-o.y;return e*e+i*i},b2Math.MulFV=function(t,o){return new b2Vec2(t*o.x,t*o.y)},b2Math.AddMM=function(t,o){return b2Mat22.FromVV(b2Math.AddVV(t.col1,o.col1),b2Math.AddVV(t.col2,o.col2))},b2Math.MulMM=function(t,o){return b2Mat22.FromVV(b2Math.MulMV(t,o.col1),b2Math.MulMV(t,o.col2))},b2Math.MulTMM=function(t,o){var e=new b2Vec2(b2Math.Dot(t.col1,o.col1),b2Math.Dot(t.col2,o.col1)),i=new b2Vec2(b2Math.Dot(t.col1,o.col2),b2Math.Dot(t.col2,o.col2));return b2Mat22.FromVV(e,i)},b2Math.Abs=function(t){return t>0?t:-t},b2Math.AbsV=function(t){return new b2Vec2(b2Math.Abs(t.x),b2Math.Abs(t.y))},b2Math.AbsM=function(t){return b2Mat22.FromVV(b2Math.AbsV(t.col1),b2Math.AbsV(t.col2))},b2Math.Min=function(t,o){return t<o?t:o},b2Math.MinV=function(t,o){return new b2Vec2(b2Math.Min(t.x,o.x),b2Math.Min(t.y,o.y))},b2Math.Max=function(t,o){return t>o?t:o},b2Math.MaxV=function(t,o){return new b2Vec2(b2Math.Max(t.x,o.x),b2Math.Max(t.y,o.y))},b2Math.Clamp=function(t,o,e){return t<o?o:t>e?e:t},b2Math.ClampV=function(t,o,e){return b2Math.MaxV(o,b2Math.MinV(t,e))},b2Math.Swap=function(t,o){var e=t[0];t[0]=o[0],o[0]=e},b2Math.Random=function(){return 2*Math.random()-1},b2Math.RandomRange=function(t,o){var e=Math.random();return e=(o-t)*e+t},b2Math.NextPowerOfTwo=function(t){return t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,t|=t>>8&16777215,(t|=t>>16&65535)+1},b2Math.IsPowerOfTwo=function(t){return t>0&&0==(t&t-1)},b2Math.b2Vec2_zero=new b2Vec2(0,0),b2Math.b2Mat22_identity=b2Mat22.FromVV(new b2Vec2(1,0),new b2Vec2(0,1)),b2Math.b2Transform_identity=new b2Transform(b2Math.b2Vec2_zero,b2Math.b2Mat22_identity);var b2PulleyJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PulleyJoint.prototype,b2Joint.prototype),b2PulleyJoint.prototype._super=b2Joint.prototype,b2PulleyJoint.prototype.__constructor=function(t){this._super.__constructor.apply(this,[t]);this.m_ground=this.m_bodyA.m_world.m_groundBody,this.m_groundAnchor1.x=t.groundAnchorA.x-this.m_ground.m_xf.position.x,this.m_groundAnchor1.y=t.groundAnchorA.y-this.m_ground.m_xf.position.y,this.m_groundAnchor2.x=t.groundAnchorB.x-this.m_ground.m_xf.position.x,this.m_groundAnchor2.y=t.groundAnchorB.y-this.m_ground.m_xf.position.y,this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_ratio=t.ratio,this.m_constant=t.lengthA+this.m_ratio*t.lengthB,this.m_maxLength1=b2Math.Min(t.maxLengthA,this.m_constant-this.m_ratio*b2PulleyJoint.b2_minPulleyLength),this.m_maxLength2=b2Math.Min(t.maxLengthB,(this.m_constant-b2PulleyJoint.b2_minPulleyLength)/this.m_ratio),this.m_impulse=0,this.m_limitImpulse1=0,this.m_limitImpulse2=0},b2PulleyJoint.prototype.__varz=function(){this.m_groundAnchor1=new b2Vec2,this.m_groundAnchor2=new b2Vec2,this.m_localAnchor1=new b2Vec2,this.m_localAnchor2=new b2Vec2,this.m_u1=new b2Vec2,this.m_u2=new b2Vec2},b2PulleyJoint.b2_minPulleyLength=2,b2PulleyJoint.prototype.InitVelocityConstraints=function(t){var o,e=this.m_bodyA,i=this.m_bodyB;o=e.m_xf.R;var n=this.m_localAnchor1.x-e.m_sweep.localCenter.x,r=this.m_localAnchor1.y-e.m_sweep.localCenter.y,s=o.col1.x*n+o.col2.x*r;r=o.col1.y*n+o.col2.y*r,n=s,o=i.m_xf.R;var a=this.m_localAnchor2.x-i.m_sweep.localCenter.x,l=this.m_localAnchor2.y-i.m_sweep.localCenter.y;s=o.col1.x*a+o.col2.x*l,l=o.col1.y*a+o.col2.y*l,a=s;var m=e.m_sweep.c.x+n,p=e.m_sweep.c.y+r,_=i.m_sweep.c.x+a,c=i.m_sweep.c.y+l,h=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,y=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,u=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,b=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y;this.m_u1.Set(m-h,p-y),this.m_u2.Set(_-u,c-b);var x=this.m_u1.Length(),d=this.m_u2.Length();x>b2Settings.b2_linearSlop?this.m_u1.Multiply(1/x):this.m_u1.SetZero(),d>b2Settings.b2_linearSlop?this.m_u2.Multiply(1/d):this.m_u2.SetZero(),this.m_constant-x-this.m_ratio*d>0?(this.m_state=b2Joint.e_inactiveLimit,this.m_impulse=0):this.m_state=b2Joint.e_atUpperLimit,x<this.m_maxLength1?(this.m_limitState1=b2Joint.e_inactiveLimit,this.m_limitImpulse1=0):this.m_limitState1=b2Joint.e_atUpperLimit,d<this.m_maxLength2?(this.m_limitState2=b2Joint.e_inactiveLimit,this.m_limitImpulse2=0):this.m_limitState2=b2Joint.e_atUpperLimit;var f=n*this.m_u1.y-r*this.m_u1.x,v=a*this.m_u2.y-l*this.m_u2.x;if(this.m_limitMass1=e.m_invMass+e.m_invI*f*f,this.m_limitMass2=i.m_invMass+i.m_invI*v*v,this.m_pulleyMass=this.m_limitMass1+this.m_ratio*this.m_ratio*this.m_limitMass2,this.m_limitMass1=1/this.m_limitMass1,this.m_limitMass2=1/this.m_limitMass2,this.m_pulleyMass=1/this.m_pulleyMass,t.warmStarting){this.m_impulse*=t.dtRatio,this.m_limitImpulse1*=t.dtRatio,this.m_limitImpulse2*=t.dtRatio;var g=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.x,w=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.y,S=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.x,C=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.y;e.m_linearVelocity.x+=e.m_invMass*g,e.m_linearVelocity.y+=e.m_invMass*w,e.m_angularVelocity+=e.m_invI*(n*w-r*g),i.m_linearVelocity.x+=i.m_invMass*S,i.m_linearVelocity.y+=i.m_invMass*C,i.m_angularVelocity+=i.m_invI*(a*C-l*S)}else this.m_impulse=0,this.m_limitImpulse1=0,this.m_limitImpulse2=0},b2PulleyJoint.prototype.SolveVelocityConstraints=function(t){var o,e=this.m_bodyA,i=this.m_bodyB;o=e.m_xf.R;var n=this.m_localAnchor1.x-e.m_sweep.localCenter.x,r=this.m_localAnchor1.y-e.m_sweep.localCenter.y,s=o.col1.x*n+o.col2.x*r;r=o.col1.y*n+o.col2.y*r,n=s,o=i.m_xf.R;var a=this.m_localAnchor2.x-i.m_sweep.localCenter.x,l=this.m_localAnchor2.y-i.m_sweep.localCenter.y;s=o.col1.x*a+o.col2.x*l,l=o.col1.y*a+o.col2.y*l,a=s;var m,p,_,c,h,y,u,b,x,d,f;this.m_state==b2Joint.e_atUpperLimit&&(m=e.m_linearVelocity.x+-e.m_angularVelocity*r,p=e.m_linearVelocity.y+e.m_angularVelocity*n,_=i.m_linearVelocity.x+-i.m_angularVelocity*l,c=i.m_linearVelocity.y+i.m_angularVelocity*a,x=-(this.m_u1.x*m+this.m_u1.y*p)-this.m_ratio*(this.m_u2.x*_+this.m_u2.y*c),d=this.m_pulleyMass*-x,f=this.m_impulse,this.m_impulse=b2Math.Max(0,this.m_impulse+d),d=this.m_impulse-f,h=-d*this.m_u1.x,y=-d*this.m_u1.y,u=-this.m_ratio*d*this.m_u2.x,b=-this.m_ratio*d*this.m_u2.y,e.m_linearVelocity.x+=e.m_invMass*h,e.m_linearVelocity.y+=e.m_invMass*y,e.m_angularVelocity+=e.m_invI*(n*y-r*h),i.m_linearVelocity.x+=i.m_invMass*u,i.m_linearVelocity.y+=i.m_invMass*b,i.m_angularVelocity+=i.m_invI*(a*b-l*u)),this.m_limitState1==b2Joint.e_atUpperLimit&&(m=e.m_linearVelocity.x+-e.m_angularVelocity*r,p=e.m_linearVelocity.y+e.m_angularVelocity*n,x=-(this.m_u1.x*m+this.m_u1.y*p),d=-this.m_limitMass1*x,f=this.m_limitImpulse1,this.m_limitImpulse1=b2Math.Max(0,this.m_limitImpulse1+d),d=this.m_limitImpulse1-f,h=-d*this.m_u1.x,y=-d*this.m_u1.y,e.m_linearVelocity.x+=e.m_invMass*h,e.m_linearVelocity.y+=e.m_invMass*y,e.m_angularVelocity+=e.m_invI*(n*y-r*h)),this.m_limitState2==b2Joint.e_atUpperLimit&&(_=i.m_linearVelocity.x+-i.m_angularVelocity*l,c=i.m_linearVelocity.y+i.m_angularVelocity*a,x=-(this.m_u2.x*_+this.m_u2.y*c),d=-this.m_limitMass2*x,f=this.m_limitImpulse2,this.m_limitImpulse2=b2Math.Max(0,this.m_limitImpulse2+d),d=this.m_limitImpulse2-f,u=-d*this.m_u2.x,b=-d*this.m_u2.y,i.m_linearVelocity.x+=i.m_invMass*u,i.m_linearVelocity.y+=i.m_invMass*b,i.m_angularVelocity+=i.m_invI*(a*b-l*u))},b2PulleyJoint.prototype.SolvePositionConstraints=function(t){var o,e,i,n,r,s,a,l,m,p,_,c,h,y,u=this.m_bodyA,b=this.m_bodyB,x=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,d=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,f=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,v=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y,g=0;return this.m_state==b2Joint.e_atUpperLimit&&(o=u.m_xf.R,e=this.m_localAnchor1.x-u.m_sweep.localCenter.x,i=this.m_localAnchor1.y-u.m_sweep.localCenter.y,y=o.col1.x*e+o.col2.x*i,i=o.col1.y*e+o.col2.y*i,e=y,o=b.m_xf.R,n=this.m_localAnchor2.x-b.m_sweep.localCenter.x,r=this.m_localAnchor2.y-b.m_sweep.localCenter.y,y=o.col1.x*n+o.col2.x*r,r=o.col1.y*n+o.col2.y*r,n=y,s=u.m_sweep.c.x+e,a=u.m_sweep.c.y+i,l=b.m_sweep.c.x+n,m=b.m_sweep.c.y+r,this.m_u1.Set(s-x,a-d),this.m_u2.Set(l-f,m-v),p=this.m_u1.Length(),_=this.m_u2.Length(),p>b2Settings.b2_linearSlop?this.m_u1.Multiply(1/p):this.m_u1.SetZero(),_>b2Settings.b2_linearSlop?this.m_u2.Multiply(1/_):this.m_u2.SetZero(),c=this.m_constant-p-this.m_ratio*_,g=b2Math.Max(g,-c),c=b2Math.Clamp(c+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0),h=-this.m_pulleyMass*c,s=-h*this.m_u1.x,a=-h*this.m_u1.y,l=-this.m_ratio*h*this.m_u2.x,m=-this.m_ratio*h*this.m_u2.y,u.m_sweep.c.x+=u.m_invMass*s,u.m_sweep.c.y+=u.m_invMass*a,u.m_sweep.a+=u.m_invI*(e*a-i*s),b.m_sweep.c.x+=b.m_invMass*l,b.m_sweep.c.y+=b.m_invMass*m,b.m_sweep.a+=b.m_invI*(n*m-r*l),u.SynchronizeTransform(),b.SynchronizeTransform()),this.m_limitState1==b2Joint.e_atUpperLimit&&(o=u.m_xf.R,e=this.m_localAnchor1.x-u.m_sweep.localCenter.x,i=this.m_localAnchor1.y-u.m_sweep.localCenter.y,y=o.col1.x*e+o.col2.x*i,i=o.col1.y*e+o.col2.y*i,e=y,s=u.m_sweep.c.x+e,a=u.m_sweep.c.y+i,this.m_u1.Set(s-x,a-d),p=this.m_u1.Length(),p>b2Settings.b2_linearSlop?(this.m_u1.x*=1/p,this.m_u1.y*=1/p):this.m_u1.SetZero(),c=this.m_maxLength1-p,g=b2Math.Max(g,-c),c=b2Math.Clamp(c+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0),h=-this.m_limitMass1*c,s=-h*this.m_u1.x,a=-h*this.m_u1.y,u.m_sweep.c.x+=u.m_invMass*s,u.m_sweep.c.y+=u.m_invMass*a,u.m_sweep.a+=u.m_invI*(e*a-i*s),u.SynchronizeTransform()),this.m_limitState2==b2Joint.e_atUpperLimit&&(o=b.m_xf.R,n=this.m_localAnchor2.x-b.m_sweep.localCenter.x,r=this.m_localAnchor2.y-b.m_sweep.localCenter.y,y=o.col1.x*n+o.col2.x*r,r=o.col1.y*n+o.col2.y*r,n=y,l=b.m_sweep.c.x+n,m=b.m_sweep.c.y+r,this.m_u2.Set(l-f,m-v),_=this.m_u2.Length(),_>b2Settings.b2_linearSlop?(this.m_u2.x*=1/_,this.m_u2.y*=1/_):this.m_u2.SetZero(),c=this.m_maxLength2-_,g=b2Math.Max(g,-c),c=b2Math.Clamp(c+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0),h=-this.m_limitMass2*c,l=-h*this.m_u2.x,m=-h*this.m_u2.y,b.m_sweep.c.x+=b.m_invMass*l,b.m_sweep.c.y+=b.m_invMass*m,b.m_sweep.a+=b.m_invI*(n*m-r*l),b.SynchronizeTransform()),g<b2Settings.b2_linearSlop},b2PulleyJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},b2PulleyJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},b2PulleyJoint.prototype.GetReactionForce=function(t){return new b2Vec2(t*this.m_impulse*this.m_u2.x,t*this.m_impulse*this.m_u2.y)},b2PulleyJoint.prototype.GetReactionTorque=function(t){return 0},b2PulleyJoint.prototype.GetGroundAnchorA=function(){var t=this.m_ground.m_xf.position.Copy();return t.Add(this.m_groundAnchor1),t},b2PulleyJoint.prototype.GetGroundAnchorB=function(){var t=this.m_ground.m_xf.position.Copy();return t.Add(this.m_groundAnchor2),t},b2PulleyJoint.prototype.GetLength1=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchor1),o=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,e=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,i=t.x-o,n=t.y-e;return Math.sqrt(i*i+n*n)},b2PulleyJoint.prototype.GetLength2=function(){var t=this.m_bodyB.GetWorldPoint(this.m_localAnchor2),o=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,e=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y,i=t.x-o,n=t.y-e;return Math.sqrt(i*i+n*n)},b2PulleyJoint.prototype.GetRatio=function(){return this.m_ratio},b2PulleyJoint.prototype.m_ground=null,b2PulleyJoint.prototype.m_groundAnchor1=new b2Vec2,b2PulleyJoint.prototype.m_groundAnchor2=new b2Vec2,b2PulleyJoint.prototype.m_localAnchor1=new b2Vec2,b2PulleyJoint.prototype.m_localAnchor2=new b2Vec2,b2PulleyJoint.prototype.m_u1=new b2Vec2,b2PulleyJoint.prototype.m_u2=new b2Vec2,b2PulleyJoint.prototype.m_constant=null,b2PulleyJoint.prototype.m_ratio=null,b2PulleyJoint.prototype.m_maxLength1=null,b2PulleyJoint.prototype.m_maxLength2=null,b2PulleyJoint.prototype.m_pulleyMass=null,b2PulleyJoint.prototype.m_limitMass1=null,b2PulleyJoint.prototype.m_limitMass2=null,b2PulleyJoint.prototype.m_impulse=null,b2PulleyJoint.prototype.m_limitImpulse1=null,b2PulleyJoint.prototype.m_limitImpulse2=null,b2PulleyJoint.prototype.m_state=0,b2PulleyJoint.prototype.m_limitState1=0,b2PulleyJoint.prototype.m_limitState2=0;var b2PrismaticJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PrismaticJoint.prototype,b2Joint.prototype),b2PrismaticJoint.prototype._super=b2Joint.prototype,b2PrismaticJoint.prototype.__constructor=function(t){this._super.__constructor.apply(this,[t]);this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_localXAxis1.SetV(t.localAxisA),this.m_localYAxis1.x=-this.m_localXAxis1.y,this.m_localYAxis1.y=this.m_localXAxis1.x,this.m_refAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_motorMass=0,this.m_motorImpulse=0,this.m_lowerTranslation=t.lowerTranslation,this.m_upperTranslation=t.upperTranslation,this.m_maxMotorForce=t.maxMotorForce,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=b2Joint.e_inactiveLimit,this.m_axis.SetZero(),this.m_perp.SetZero()},b2PrismaticJoint.prototype.__varz=function(){this.m_localAnchor1=new b2Vec2,this.m_localAnchor2=new b2Vec2,this.m_localXAxis1=new b2Vec2,this.m_localYAxis1=new b2Vec2,this.m_axis=new b2Vec2,this.m_perp=new b2Vec2,this.m_K=new b2Mat33,this.m_impulse=new b2Vec3},b2PrismaticJoint.prototype.InitVelocityConstraints=function(t){var o,e,i=this.m_bodyA,n=this.m_bodyB;this.m_localCenterA.SetV(i.GetLocalCenter()),this.m_localCenterB.SetV(n.GetLocalCenter());var r=i.GetTransform();n.GetTransform();o=i.m_xf.R;var s=this.m_localAnchor1.x-this.m_localCenterA.x,a=this.m_localAnchor1.y-this.m_localCenterA.y;e=o.col1.x*s+o.col2.x*a,a=o.col1.y*s+o.col2.y*a,s=e,o=n.m_xf.R;var l=this.m_localAnchor2.x-this.m_localCenterB.x,m=this.m_localAnchor2.y-this.m_localCenterB.y;e=o.col1.x*l+o.col2.x*m,m=o.col1.y*l+o.col2.y*m,l=e;var p=n.m_sweep.c.x+l-i.m_sweep.c.x-s,_=n.m_sweep.c.y+m-i.m_sweep.c.y-a;this.m_invMassA=i.m_invMass,this.m_invMassB=n.m_invMass,this.m_invIA=i.m_invI,this.m_invIB=n.m_invI,this.m_axis.SetV(b2Math.MulMV(r.R,this.m_localXAxis1)),this.m_a1=(p+s)*this.m_axis.y-(_+a)*this.m_axis.x,this.m_a2=l*this.m_axis.y-m*this.m_axis.x,this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2,this.m_motorMass>Number.MIN_VALUE&&(this.m_motorMass=1/this.m_motorMass),this.m_perp.SetV(b2Math.MulMV(r.R,this.m_localYAxis1)),this.m_s1=(p+s)*this.m_perp.y-(_+a)*this.m_perp.x,this.m_s2=l*this.m_perp.y-m*this.m_perp.x;var c=this.m_invMassA,h=this.m_invMassB,y=this.m_invIA,u=this.m_invIB;if(this.m_K.col1.x=c+h+y*this.m_s1*this.m_s1+u*this.m_s2*this.m_s2, this.m_K.col1.y=y*this.m_s1+u*this.m_s2,this.m_K.col1.z=y*this.m_s1*this.m_a1+u*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=y+u,this.m_K.col2.z=y*this.m_a1+u*this.m_a2,this.m_K.col3.x=this.m_K.col1.z,this.m_K.col3.y=this.m_K.col2.z,this.m_K.col3.z=c+h+y*this.m_a1*this.m_a1+u*this.m_a2*this.m_a2,this.m_enableLimit){var b=this.m_axis.x*p+this.m_axis.y*_;b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop?this.m_limitState=b2Joint.e_equalLimits:b<=this.m_lowerTranslation?this.m_limitState!=b2Joint.e_atLowerLimit&&(this.m_limitState=b2Joint.e_atLowerLimit,this.m_impulse.z=0):b>=this.m_upperTranslation?this.m_limitState!=b2Joint.e_atUpperLimit&&(this.m_limitState=b2Joint.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=b2Joint.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=b2Joint.e_inactiveLimit;if(0==this.m_enableMotor&&(this.m_motorImpulse=0),t.warmStarting){this.m_impulse.x*=t.dtRatio,this.m_impulse.y*=t.dtRatio,this.m_motorImpulse*=t.dtRatio;var x=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x,d=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y,f=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,v=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;i.m_linearVelocity.x-=this.m_invMassA*x,i.m_linearVelocity.y-=this.m_invMassA*d,i.m_angularVelocity-=this.m_invIA*f,n.m_linearVelocity.x+=this.m_invMassB*x,n.m_linearVelocity.y+=this.m_invMassB*d,n.m_angularVelocity+=this.m_invIB*v}else this.m_impulse.SetZero(),this.m_motorImpulse=0},b2PrismaticJoint.prototype.SolveVelocityConstraints=function(t){var o,e,i,n,r=this.m_bodyA,s=this.m_bodyB,a=r.m_linearVelocity,l=r.m_angularVelocity,m=s.m_linearVelocity,p=s.m_angularVelocity;if(this.m_enableMotor&&this.m_limitState!=b2Joint.e_equalLimits){var _=this.m_axis.x*(m.x-a.x)+this.m_axis.y*(m.y-a.y)+this.m_a2*p-this.m_a1*l,c=this.m_motorMass*(this.m_motorSpeed-_),h=this.m_motorImpulse,y=t.dt*this.m_maxMotorForce;this.m_motorImpulse=b2Math.Clamp(this.m_motorImpulse+c,-y,y),c=this.m_motorImpulse-h,o=c*this.m_axis.x,e=c*this.m_axis.y,i=c*this.m_a1,n=c*this.m_a2,a.x-=this.m_invMassA*o,a.y-=this.m_invMassA*e,l-=this.m_invIA*i,m.x+=this.m_invMassB*o,m.y+=this.m_invMassB*e,p+=this.m_invIB*n}var u=this.m_perp.x*(m.x-a.x)+this.m_perp.y*(m.y-a.y)+this.m_s2*p-this.m_s1*l,b=p-l;if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){var x=this.m_axis.x*(m.x-a.x)+this.m_axis.y*(m.y-a.y)+this.m_a2*p-this.m_a1*l,d=this.m_impulse.Copy(),f=this.m_K.Solve33(new b2Vec3,-u,-b,-x);this.m_impulse.Add(f),this.m_limitState==b2Joint.e_atLowerLimit?this.m_impulse.z=b2Math.Max(this.m_impulse.z,0):this.m_limitState==b2Joint.e_atUpperLimit&&(this.m_impulse.z=b2Math.Min(this.m_impulse.z,0));var v=-u-(this.m_impulse.z-d.z)*this.m_K.col3.x,g=-b-(this.m_impulse.z-d.z)*this.m_K.col3.y,w=this.m_K.Solve22(new b2Vec2,v,g);w.x+=d.x,w.y+=d.y,this.m_impulse.x=w.x,this.m_impulse.y=w.y,f.x=this.m_impulse.x-d.x,f.y=this.m_impulse.y-d.y,f.z=this.m_impulse.z-d.z,o=f.x*this.m_perp.x+f.z*this.m_axis.x,e=f.x*this.m_perp.y+f.z*this.m_axis.y,i=f.x*this.m_s1+f.y+f.z*this.m_a1,n=f.x*this.m_s2+f.y+f.z*this.m_a2,a.x-=this.m_invMassA*o,a.y-=this.m_invMassA*e,l-=this.m_invIA*i,m.x+=this.m_invMassB*o,m.y+=this.m_invMassB*e,p+=this.m_invIB*n}else{var S=this.m_K.Solve22(new b2Vec2,-u,-b);this.m_impulse.x+=S.x,this.m_impulse.y+=S.y,o=S.x*this.m_perp.x,e=S.x*this.m_perp.y,i=S.x*this.m_s1+S.y,n=S.x*this.m_s2+S.y,a.x-=this.m_invMassA*o,a.y-=this.m_invMassA*e,l-=this.m_invIA*i,m.x+=this.m_invMassB*o,m.y+=this.m_invMassB*e,p+=this.m_invIB*n}r.m_linearVelocity.SetV(a),r.m_angularVelocity=l,s.m_linearVelocity.SetV(m),s.m_angularVelocity=p},b2PrismaticJoint.prototype.SolvePositionConstraints=function(t){var o,e,i,n,r,s,a=this.m_bodyA,l=this.m_bodyB,m=a.m_sweep.c,p=a.m_sweep.a,_=l.m_sweep.c,c=l.m_sweep.a,h=0,y=0,u=!1,b=0,x=b2Mat22.FromAngle(p),d=b2Mat22.FromAngle(c);o=x;var f=this.m_localAnchor1.x-this.m_localCenterA.x,v=this.m_localAnchor1.y-this.m_localCenterA.y;e=o.col1.x*f+o.col2.x*v,v=o.col1.y*f+o.col2.y*v,f=e,o=d;var g=this.m_localAnchor2.x-this.m_localCenterB.x,w=this.m_localAnchor2.y-this.m_localCenterB.y;e=o.col1.x*g+o.col2.x*w,w=o.col1.y*g+o.col2.y*w,g=e;var S=_.x+g-m.x-f,C=_.y+w-m.y-v;if(this.m_enableLimit){this.m_axis=b2Math.MulMV(x,this.m_localXAxis1),this.m_a1=(S+f)*this.m_axis.y-(C+v)*this.m_axis.x,this.m_a2=g*this.m_axis.y-w*this.m_axis.x;var A=this.m_axis.x*S+this.m_axis.y*C;b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop?(b=b2Math.Clamp(A,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection),h=b2Math.Abs(A),u=!0):A<=this.m_lowerTranslation?(b=b2Math.Clamp(A-this.m_lowerTranslation+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0),h=this.m_lowerTranslation-A,u=!0):A>=this.m_upperTranslation&&(b=b2Math.Clamp(A-this.m_upperTranslation+b2Settings.b2_linearSlop,0,b2Settings.b2_maxLinearCorrection),h=A-this.m_upperTranslation,u=!0)}this.m_perp=b2Math.MulMV(x,this.m_localYAxis1),this.m_s1=(S+f)*this.m_perp.y-(C+v)*this.m_perp.x,this.m_s2=g*this.m_perp.y-w*this.m_perp.x;var B=new b2Vec3,M=this.m_perp.x*S+this.m_perp.y*C,V=c-p-this.m_refAngle;if(h=b2Math.Max(h,b2Math.Abs(M)),y=b2Math.Abs(V),u)i=this.m_invMassA,n=this.m_invMassB,r=this.m_invIA,s=this.m_invIB,this.m_K.col1.x=i+n+r*this.m_s1*this.m_s1+s*this.m_s2*this.m_s2,this.m_K.col1.y=r*this.m_s1+s*this.m_s2,this.m_K.col1.z=r*this.m_s1*this.m_a1+s*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=r+s,this.m_K.col2.z=r*this.m_a1+s*this.m_a2,this.m_K.col3.x=this.m_K.col1.z,this.m_K.col3.y=this.m_K.col2.z,this.m_K.col3.z=i+n+r*this.m_a1*this.m_a1+s*this.m_a2*this.m_a2,this.m_K.Solve33(B,-M,-V,-b);else{i=this.m_invMassA,n=this.m_invMassB,r=this.m_invIA,s=this.m_invIB;var I=i+n+r*this.m_s1*this.m_s1+s*this.m_s2*this.m_s2,P=r*this.m_s1+s*this.m_s2,D=r+s;this.m_K.col1.Set(I,P,0),this.m_K.col2.Set(P,D,0);var J=this.m_K.Solve22(new b2Vec2,-M,-V);B.x=J.x,B.y=J.y,B.z=0}var L=B.x*this.m_perp.x+B.z*this.m_axis.x,G=B.x*this.m_perp.y+B.z*this.m_axis.y,F=B.x*this.m_s1+B.y+B.z*this.m_a1,T=B.x*this.m_s2+B.y+B.z*this.m_a2;return m.x-=this.m_invMassA*L,m.y-=this.m_invMassA*G,p-=this.m_invIA*F,_.x+=this.m_invMassB*L,_.y+=this.m_invMassB*G,c+=this.m_invIB*T,a.m_sweep.a=p,l.m_sweep.a=c,a.SynchronizeTransform(),l.SynchronizeTransform(),h<=b2Settings.b2_linearSlop&&y<=b2Settings.b2_angularSlop},b2PrismaticJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},b2PrismaticJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},b2PrismaticJoint.prototype.GetReactionForce=function(t){return new b2Vec2(t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y))},b2PrismaticJoint.prototype.GetReactionTorque=function(t){return t*this.m_impulse.y},b2PrismaticJoint.prototype.GetJointTranslation=function(){var t=this.m_bodyA,o=this.m_bodyB,e=t.GetWorldPoint(this.m_localAnchor1),i=o.GetWorldPoint(this.m_localAnchor2),n=i.x-e.x,r=i.y-e.y,s=t.GetWorldVector(this.m_localXAxis1);return s.x*n+s.y*r},b2PrismaticJoint.prototype.GetJointSpeed=function(){var t,o=this.m_bodyA,e=this.m_bodyB;t=o.m_xf.R;var i=this.m_localAnchor1.x-o.m_sweep.localCenter.x,n=this.m_localAnchor1.y-o.m_sweep.localCenter.y,r=t.col1.x*i+t.col2.x*n;n=t.col1.y*i+t.col2.y*n,i=r,t=e.m_xf.R;var s=this.m_localAnchor2.x-e.m_sweep.localCenter.x,a=this.m_localAnchor2.y-e.m_sweep.localCenter.y;r=t.col1.x*s+t.col2.x*a,a=t.col1.y*s+t.col2.y*a,s=r;var l=o.m_sweep.c.x+i,m=o.m_sweep.c.y+n,p=e.m_sweep.c.x+s,_=e.m_sweep.c.y+a,c=p-l,h=_-m,y=o.GetWorldVector(this.m_localXAxis1),u=o.m_linearVelocity,b=e.m_linearVelocity,x=o.m_angularVelocity,d=e.m_angularVelocity;return c*-x*y.y+h*x*y.x+(y.x*(b.x+-d*a-u.x- -x*n)+y.y*(b.y+d*s-u.y-x*i))},b2PrismaticJoint.prototype.IsLimitEnabled=function(){return this.m_enableLimit},b2PrismaticJoint.prototype.EnableLimit=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t},b2PrismaticJoint.prototype.GetLowerLimit=function(){return this.m_lowerTranslation},b2PrismaticJoint.prototype.GetUpperLimit=function(){return this.m_upperTranslation},b2PrismaticJoint.prototype.SetLimits=function(t,o){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=o},b2PrismaticJoint.prototype.IsMotorEnabled=function(){return this.m_enableMotor},b2PrismaticJoint.prototype.EnableMotor=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t},b2PrismaticJoint.prototype.SetMotorSpeed=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},b2PrismaticJoint.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},b2PrismaticJoint.prototype.SetMaxMotorForce=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t},b2PrismaticJoint.prototype.GetMotorForce=function(){return this.m_motorImpulse},b2PrismaticJoint.prototype.m_localAnchor1=new b2Vec2,b2PrismaticJoint.prototype.m_localAnchor2=new b2Vec2,b2PrismaticJoint.prototype.m_localXAxis1=new b2Vec2,b2PrismaticJoint.prototype.m_localYAxis1=new b2Vec2,b2PrismaticJoint.prototype.m_refAngle=null,b2PrismaticJoint.prototype.m_axis=new b2Vec2,b2PrismaticJoint.prototype.m_perp=new b2Vec2,b2PrismaticJoint.prototype.m_s1=null,b2PrismaticJoint.prototype.m_s2=null,b2PrismaticJoint.prototype.m_a1=null,b2PrismaticJoint.prototype.m_a2=null,b2PrismaticJoint.prototype.m_K=new b2Mat33,b2PrismaticJoint.prototype.m_impulse=new b2Vec3,b2PrismaticJoint.prototype.m_motorMass=null,b2PrismaticJoint.prototype.m_motorImpulse=null,b2PrismaticJoint.prototype.m_lowerTranslation=null,b2PrismaticJoint.prototype.m_upperTranslation=null,b2PrismaticJoint.prototype.m_maxMotorForce=null,b2PrismaticJoint.prototype.m_motorSpeed=null,b2PrismaticJoint.prototype.m_enableLimit=null,b2PrismaticJoint.prototype.m_enableMotor=null,b2PrismaticJoint.prototype.m_limitState=0;var b2RevoluteJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2RevoluteJoint.prototype,b2Joint.prototype),b2RevoluteJoint.prototype._super=b2Joint.prototype,b2RevoluteJoint.prototype.__constructor=function(t){this._super.__constructor.apply(this,[t]),this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_referenceAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerAngle=t.lowerAngle,this.m_upperAngle=t.upperAngle,this.m_maxMotorTorque=t.maxMotorTorque,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=b2Joint.e_inactiveLimit},b2RevoluteJoint.prototype.__varz=function(){this.K=new b2Mat22,this.K1=new b2Mat22,this.K2=new b2Mat22,this.K3=new b2Mat22,this.impulse3=new b2Vec3,this.impulse2=new b2Vec2,this.reduced=new b2Vec2,this.m_localAnchor1=new b2Vec2,this.m_localAnchor2=new b2Vec2,this.m_impulse=new b2Vec3,this.m_mass=new b2Mat33},b2RevoluteJoint.tImpulse=new b2Vec2,b2RevoluteJoint.prototype.InitVelocityConstraints=function(t){var o,e,i=this.m_bodyA,n=this.m_bodyB;this.m_enableMotor||this.m_enableLimit,o=i.m_xf.R;var r=this.m_localAnchor1.x-i.m_sweep.localCenter.x,s=this.m_localAnchor1.y-i.m_sweep.localCenter.y;e=o.col1.x*r+o.col2.x*s,s=o.col1.y*r+o.col2.y*s,r=e,o=n.m_xf.R;var a=this.m_localAnchor2.x-n.m_sweep.localCenter.x,l=this.m_localAnchor2.y-n.m_sweep.localCenter.y;e=o.col1.x*a+o.col2.x*l,l=o.col1.y*a+o.col2.y*l,a=e;var m=i.m_invMass,p=n.m_invMass,_=i.m_invI,c=n.m_invI;if(this.m_mass.col1.x=m+p+s*s*_+l*l*c,this.m_mass.col2.x=-s*r*_-l*a*c,this.m_mass.col3.x=-s*_-l*c,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=m+p+r*r*_+a*a*c,this.m_mass.col3.y=r*_+a*c,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=_+c,this.m_motorMass=1/(_+c),0==this.m_enableMotor&&(this.m_motorImpulse=0),this.m_enableLimit){var h=n.m_sweep.a-i.m_sweep.a-this.m_referenceAngle;b2Math.Abs(this.m_upperAngle-this.m_lowerAngle)<2*b2Settings.b2_angularSlop?this.m_limitState=b2Joint.e_equalLimits:h<=this.m_lowerAngle?(this.m_limitState!=b2Joint.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=b2Joint.e_atLowerLimit):h>=this.m_upperAngle?(this.m_limitState!=b2Joint.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=b2Joint.e_atUpperLimit):(this.m_limitState=b2Joint.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=b2Joint.e_inactiveLimit;if(t.warmStarting){this.m_impulse.x*=t.dtRatio,this.m_impulse.y*=t.dtRatio,this.m_motorImpulse*=t.dtRatio;var y=this.m_impulse.x,u=this.m_impulse.y;i.m_linearVelocity.x-=m*y,i.m_linearVelocity.y-=m*u,i.m_angularVelocity-=_*(r*u-s*y+this.m_motorImpulse+this.m_impulse.z),n.m_linearVelocity.x+=p*y,n.m_linearVelocity.y+=p*u,n.m_angularVelocity+=c*(a*u-l*y+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0},b2RevoluteJoint.prototype.SolveVelocityConstraints=function(t){var o,e,i,n,r,s,a=this.m_bodyA,l=this.m_bodyB,m=a.m_linearVelocity,p=a.m_angularVelocity,_=l.m_linearVelocity,c=l.m_angularVelocity,h=a.m_invMass,y=l.m_invMass,u=a.m_invI,b=l.m_invI;if(this.m_enableMotor&&this.m_limitState!=b2Joint.e_equalLimits){var x=c-p-this.m_motorSpeed,d=this.m_motorMass*-x,f=this.m_motorImpulse,v=t.dt*this.m_maxMotorTorque;this.m_motorImpulse=b2Math.Clamp(this.m_motorImpulse+d,-v,v),d=this.m_motorImpulse-f,p-=u*d,c+=b*d}if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){o=a.m_xf.R,i=this.m_localAnchor1.x-a.m_sweep.localCenter.x,n=this.m_localAnchor1.y-a.m_sweep.localCenter.y,e=o.col1.x*i+o.col2.x*n,n=o.col1.y*i+o.col2.y*n,i=e,o=l.m_xf.R,r=this.m_localAnchor2.x-l.m_sweep.localCenter.x,s=this.m_localAnchor2.y-l.m_sweep.localCenter.y,e=o.col1.x*r+o.col2.x*s,s=o.col1.y*r+o.col2.y*s,r=e;var g=_.x+-c*s-m.x- -p*n,w=_.y+c*r-m.y-p*i,S=c-p;this.m_mass.Solve33(this.impulse3,-g,-w,-S),this.m_limitState==b2Joint.e_equalLimits?this.m_impulse.Add(this.impulse3):this.m_limitState==b2Joint.e_atLowerLimit?this.m_impulse.z+this.impulse3.z<0&&(this.m_mass.Solve22(this.reduced,-g,-w),this.impulse3.x=this.reduced.x,this.impulse3.y=this.reduced.y,this.impulse3.z=-this.m_impulse.z,this.m_impulse.x+=this.reduced.x,this.m_impulse.y+=this.reduced.y,this.m_impulse.z=0):this.m_limitState==b2Joint.e_atUpperLimit&&this.m_impulse.z+this.impulse3.z>0&&(this.m_mass.Solve22(this.reduced,-g,-w),this.impulse3.x=this.reduced.x,this.impulse3.y=this.reduced.y,this.impulse3.z=-this.m_impulse.z,this.m_impulse.x+=this.reduced.x,this.m_impulse.y+=this.reduced.y,this.m_impulse.z=0),m.x-=h*this.impulse3.x,m.y-=h*this.impulse3.y,p-=u*(i*this.impulse3.y-n*this.impulse3.x+this.impulse3.z),_.x+=y*this.impulse3.x,_.y+=y*this.impulse3.y,c+=b*(r*this.impulse3.y-s*this.impulse3.x+this.impulse3.z)}else{o=a.m_xf.R,i=this.m_localAnchor1.x-a.m_sweep.localCenter.x,n=this.m_localAnchor1.y-a.m_sweep.localCenter.y,e=o.col1.x*i+o.col2.x*n,n=o.col1.y*i+o.col2.y*n,i=e,o=l.m_xf.R,r=this.m_localAnchor2.x-l.m_sweep.localCenter.x,s=this.m_localAnchor2.y-l.m_sweep.localCenter.y,e=o.col1.x*r+o.col2.x*s,s=o.col1.y*r+o.col2.y*s,r=e;var C=_.x+-c*s-m.x- -p*n,A=_.y+c*r-m.y-p*i;this.m_mass.Solve22(this.impulse2,-C,-A),this.m_impulse.x+=this.impulse2.x,this.m_impulse.y+=this.impulse2.y,m.x-=h*this.impulse2.x,m.y-=h*this.impulse2.y,p-=u*(i*this.impulse2.y-n*this.impulse2.x),_.x+=y*this.impulse2.x,_.y+=y*this.impulse2.y,c+=b*(r*this.impulse2.y-s*this.impulse2.x)}a.m_linearVelocity.SetV(m),a.m_angularVelocity=p,l.m_linearVelocity.SetV(_),l.m_angularVelocity=c},b2RevoluteJoint.prototype.SolvePositionConstraints=function(t){var o,e,i,n,r,s=this.m_bodyA,a=this.m_bodyB,l=0,m=0;if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){var p=a.m_sweep.a-s.m_sweep.a-this.m_referenceAngle,_=0;this.m_limitState==b2Joint.e_equalLimits?(o=b2Math.Clamp(p-this.m_lowerAngle,-b2Settings.b2_maxAngularCorrection,b2Settings.b2_maxAngularCorrection),_=-this.m_motorMass*o,l=b2Math.Abs(o)):this.m_limitState==b2Joint.e_atLowerLimit?(o=p-this.m_lowerAngle,l=-o,o=b2Math.Clamp(o+b2Settings.b2_angularSlop,-b2Settings.b2_maxAngularCorrection,0),_=-this.m_motorMass*o):this.m_limitState==b2Joint.e_atUpperLimit&&(o=p-this.m_upperAngle,l=o,o=b2Math.Clamp(o-b2Settings.b2_angularSlop,0,b2Settings.b2_maxAngularCorrection),_=-this.m_motorMass*o),s.m_sweep.a-=s.m_invI*_,a.m_sweep.a+=a.m_invI*_,s.SynchronizeTransform(),a.SynchronizeTransform()}e=s.m_xf.R;var c=this.m_localAnchor1.x-s.m_sweep.localCenter.x,h=this.m_localAnchor1.y-s.m_sweep.localCenter.y;i=e.col1.x*c+e.col2.x*h,h=e.col1.y*c+e.col2.y*h,c=i,e=a.m_xf.R;var y=this.m_localAnchor2.x-a.m_sweep.localCenter.x,u=this.m_localAnchor2.y-a.m_sweep.localCenter.y;i=e.col1.x*y+e.col2.x*u,u=e.col1.y*y+e.col2.y*u,y=i;var b=a.m_sweep.c.x+y-s.m_sweep.c.x-c,x=a.m_sweep.c.y+u-s.m_sweep.c.y-h,d=b*b+x*x,f=Math.sqrt(d);m=f;var v=s.m_invMass,g=a.m_invMass,w=s.m_invI,S=a.m_invI,C=10*b2Settings.b2_linearSlop;if(d>C*C){var A=v+g,B=1/A;n=B*-b,r=B*-x;s.m_sweep.c.x-=.5*v*n,s.m_sweep.c.y-=.5*v*r,a.m_sweep.c.x+=.5*g*n,a.m_sweep.c.y+=.5*g*r,b=a.m_sweep.c.x+y-s.m_sweep.c.x-c,x=a.m_sweep.c.y+u-s.m_sweep.c.y-h}return this.K1.col1.x=v+g,this.K1.col2.x=0,this.K1.col1.y=0,this.K1.col2.y=v+g,this.K2.col1.x=w*h*h,this.K2.col2.x=-w*c*h,this.K2.col1.y=-w*c*h,this.K2.col2.y=w*c*c,this.K3.col1.x=S*u*u,this.K3.col2.x=-S*y*u,this.K3.col1.y=-S*y*u,this.K3.col2.y=S*y*y,this.K.SetM(this.K1),this.K.AddM(this.K2),this.K.AddM(this.K3),this.K.Solve(b2RevoluteJoint.tImpulse,-b,-x),n=b2RevoluteJoint.tImpulse.x,r=b2RevoluteJoint.tImpulse.y,s.m_sweep.c.x-=s.m_invMass*n,s.m_sweep.c.y-=s.m_invMass*r,s.m_sweep.a-=s.m_invI*(c*r-h*n),a.m_sweep.c.x+=a.m_invMass*n,a.m_sweep.c.y+=a.m_invMass*r,a.m_sweep.a+=a.m_invI*(y*r-u*n),s.SynchronizeTransform(),a.SynchronizeTransform(),m<=b2Settings.b2_linearSlop&&l<=b2Settings.b2_angularSlop},b2RevoluteJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},b2RevoluteJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},b2RevoluteJoint.prototype.GetReactionForce=function(t){return new b2Vec2(t*this.m_impulse.x,t*this.m_impulse.y)},b2RevoluteJoint.prototype.GetReactionTorque=function(t){return t*this.m_impulse.z},b2RevoluteJoint.prototype.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle},b2RevoluteJoint.prototype.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity},b2RevoluteJoint.prototype.IsLimitEnabled=function(){return this.m_enableLimit},b2RevoluteJoint.prototype.EnableLimit=function(t){this.m_enableLimit=t},b2RevoluteJoint.prototype.GetLowerLimit=function(){return this.m_lowerAngle},b2RevoluteJoint.prototype.GetUpperLimit=function(){return this.m_upperAngle},b2RevoluteJoint.prototype.SetLimits=function(t,o){this.m_lowerAngle=t,this.m_upperAngle=o},b2RevoluteJoint.prototype.IsMotorEnabled=function(){return this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor},b2RevoluteJoint.prototype.EnableMotor=function(t){this.m_enableMotor=t},b2RevoluteJoint.prototype.SetMotorSpeed=function(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t},b2RevoluteJoint.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},b2RevoluteJoint.prototype.SetMaxMotorTorque=function(t){this.m_maxMotorTorque=t},b2RevoluteJoint.prototype.GetMotorTorque=function(){return this.m_maxMotorTorque},b2RevoluteJoint.prototype.K=new b2Mat22,b2RevoluteJoint.prototype.K1=new b2Mat22,b2RevoluteJoint.prototype.K2=new b2Mat22,b2RevoluteJoint.prototype.K3=new b2Mat22,b2RevoluteJoint.prototype.impulse3=new b2Vec3,b2RevoluteJoint.prototype.impulse2=new b2Vec2,b2RevoluteJoint.prototype.reduced=new b2Vec2,b2RevoluteJoint.prototype.m_localAnchor1=new b2Vec2,b2RevoluteJoint.prototype.m_localAnchor2=new b2Vec2,b2RevoluteJoint.prototype.m_impulse=new b2Vec3,b2RevoluteJoint.prototype.m_motorImpulse=null,b2RevoluteJoint.prototype.m_mass=new b2Mat33,b2RevoluteJoint.prototype.m_motorMass=null,b2RevoluteJoint.prototype.m_enableMotor=null,b2RevoluteJoint.prototype.m_maxMotorTorque=null,b2RevoluteJoint.prototype.m_motorSpeed=null,b2RevoluteJoint.prototype.m_enableLimit=null,b2RevoluteJoint.prototype.m_referenceAngle=null,b2RevoluteJoint.prototype.m_lowerAngle=null,b2RevoluteJoint.prototype.m_upperAngle=null,b2RevoluteJoint.prototype.m_limitState=0;var b2JointDef=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2JointDef.prototype.__constructor=function(){this.type=b2Joint.e_unknownJoint,this.userData=null,this.bodyA=null,this.bodyB=null,this.collideConnected=!1},b2JointDef.prototype.__varz=function(){},b2JointDef.prototype.type=0,b2JointDef.prototype.userData=null,b2JointDef.prototype.bodyA=null,b2JointDef.prototype.bodyB=null,b2JointDef.prototype.collideConnected=null;var b2LineJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2LineJointDef.prototype,b2JointDef.prototype),b2LineJointDef.prototype._super=b2JointDef.prototype,b2LineJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_lineJoint,this.localAxisA.Set(1,0),this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0},b2LineJointDef.prototype.__varz=function(){this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2,this.localAxisA=new b2Vec2},b2LineJointDef.prototype.Initialize=function(t,o,e,i){this.bodyA=t,this.bodyB=o,this.localAnchorA=this.bodyA.GetLocalPoint(e),this.localAnchorB=this.bodyB.GetLocalPoint(e),this.localAxisA=this.bodyA.GetLocalVector(i)},b2LineJointDef.prototype.localAnchorA=new b2Vec2,b2LineJointDef.prototype.localAnchorB=new b2Vec2,b2LineJointDef.prototype.localAxisA=new b2Vec2,b2LineJointDef.prototype.enableLimit=null,b2LineJointDef.prototype.lowerTranslation=null,b2LineJointDef.prototype.upperTranslation=null,b2LineJointDef.prototype.enableMotor=null,b2LineJointDef.prototype.maxMotorForce=null,b2LineJointDef.prototype.motorSpeed=null;var b2DistanceJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2DistanceJoint.prototype,b2Joint.prototype),b2DistanceJoint.prototype._super=b2Joint.prototype,b2DistanceJoint.prototype.__constructor=function(t){this._super.__constructor.apply(this,[t]);this.m_localAnchor1.SetV(t.localAnchorA),this.m_localAnchor2.SetV(t.localAnchorB),this.m_length=t.length,this.m_frequencyHz=t.frequencyHz,this.m_dampingRatio=t.dampingRatio,this.m_impulse=0,this.m_gamma=0,this.m_bias=0},b2DistanceJoint.prototype.__varz=function(){this.m_localAnchor1=new b2Vec2,this.m_localAnchor2=new b2Vec2,this.m_u=new b2Vec2},b2DistanceJoint.prototype.InitVelocityConstraints=function(t){var o,e,i=this.m_bodyA,n=this.m_bodyB;o=i.m_xf.R;var r=this.m_localAnchor1.x-i.m_sweep.localCenter.x,s=this.m_localAnchor1.y-i.m_sweep.localCenter.y;e=o.col1.x*r+o.col2.x*s,s=o.col1.y*r+o.col2.y*s,r=e,o=n.m_xf.R;var a=this.m_localAnchor2.x-n.m_sweep.localCenter.x,l=this.m_localAnchor2.y-n.m_sweep.localCenter.y;e=o.col1.x*a+o.col2.x*l,l=o.col1.y*a+o.col2.y*l,a=e,this.m_u.x=n.m_sweep.c.x+a-i.m_sweep.c.x-r,this.m_u.y=n.m_sweep.c.y+l-i.m_sweep.c.y-s;var m=Math.sqrt(this.m_u.x*this.m_u.x+this.m_u.y*this.m_u.y);m>b2Settings.b2_linearSlop?this.m_u.Multiply(1/m):this.m_u.SetZero();var p=r*this.m_u.y-s*this.m_u.x,_=a*this.m_u.y-l*this.m_u.x,c=i.m_invMass+i.m_invI*p*p+n.m_invMass+n.m_invI*_*_;if(this.m_mass=0!=c?1/c:0,this.m_frequencyHz>0){var h=m-this.m_length,y=2*Math.PI*this.m_frequencyHz,u=2*this.m_mass*this.m_dampingRatio*y,b=this.m_mass*y*y;this.m_gamma=t.dt*(u+t.dt*b),this.m_gamma=0!=this.m_gamma?1/this.m_gamma:0,this.m_bias=h*t.dt*b*this.m_gamma,this.m_mass=c+this.m_gamma,this.m_mass=0!=this.m_mass?1/this.m_mass:0}if(t.warmStarting){this.m_impulse*=t.dtRatio;var x=this.m_impulse*this.m_u.x,d=this.m_impulse*this.m_u.y;i.m_linearVelocity.x-=i.m_invMass*x,i.m_linearVelocity.y-=i.m_invMass*d,i.m_angularVelocity-=i.m_invI*(r*d-s*x),n.m_linearVelocity.x+=n.m_invMass*x,n.m_linearVelocity.y+=n.m_invMass*d,n.m_angularVelocity+=n.m_invI*(a*d-l*x)}else this.m_impulse=0},b2DistanceJoint.prototype.SolveVelocityConstraints=function(t){var o,e=this.m_bodyA,i=this.m_bodyB;o=e.m_xf.R;var n=this.m_localAnchor1.x-e.m_sweep.localCenter.x,r=this.m_localAnchor1.y-e.m_sweep.localCenter.y,s=o.col1.x*n+o.col2.x*r;r=o.col1.y*n+o.col2.y*r,n=s,o=i.m_xf.R;var a=this.m_localAnchor2.x-i.m_sweep.localCenter.x,l=this.m_localAnchor2.y-i.m_sweep.localCenter.y;s=o.col1.x*a+o.col2.x*l,l=o.col1.y*a+o.col2.y*l,a=s;var m=e.m_linearVelocity.x+-e.m_angularVelocity*r,p=e.m_linearVelocity.y+e.m_angularVelocity*n,_=i.m_linearVelocity.x+-i.m_angularVelocity*l,c=i.m_linearVelocity.y+i.m_angularVelocity*a,h=this.m_u.x*(_-m)+this.m_u.y*(c-p),y=-this.m_mass*(h+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=y;var u=y*this.m_u.x,b=y*this.m_u.y;e.m_linearVelocity.x-=e.m_invMass*u,e.m_linearVelocity.y-=e.m_invMass*b,e.m_angularVelocity-=e.m_invI*(n*b-r*u),i.m_linearVelocity.x+=i.m_invMass*u,i.m_linearVelocity.y+=i.m_invMass*b,i.m_angularVelocity+=i.m_invI*(a*b-l*u)},b2DistanceJoint.prototype.SolvePositionConstraints=function(t){var o;if(this.m_frequencyHz>0)return!0;var e=this.m_bodyA,i=this.m_bodyB;o=e.m_xf.R;var n=this.m_localAnchor1.x-e.m_sweep.localCenter.x,r=this.m_localAnchor1.y-e.m_sweep.localCenter.y,s=o.col1.x*n+o.col2.x*r;r=o.col1.y*n+o.col2.y*r,n=s,o=i.m_xf.R;var a=this.m_localAnchor2.x-i.m_sweep.localCenter.x,l=this.m_localAnchor2.y-i.m_sweep.localCenter.y;s=o.col1.x*a+o.col2.x*l,l=o.col1.y*a+o.col2.y*l,a=s;var m=i.m_sweep.c.x+a-e.m_sweep.c.x-n,p=i.m_sweep.c.y+l-e.m_sweep.c.y-r,_=Math.sqrt(m*m+p*p);m/=_,p/=_;var c=_-this.m_length;c=b2Math.Clamp(c,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);var h=-this.m_mass*c;this.m_u.Set(m,p);var y=h*this.m_u.x,u=h*this.m_u.y;return e.m_sweep.c.x-=e.m_invMass*y,e.m_sweep.c.y-=e.m_invMass*u,e.m_sweep.a-=e.m_invI*(n*u-r*y),i.m_sweep.c.x+=i.m_invMass*y,i.m_sweep.c.y+=i.m_invMass*u,i.m_sweep.a+=i.m_invI*(a*u-l*y),e.SynchronizeTransform(),i.SynchronizeTransform(),b2Math.Abs(c)<b2Settings.b2_linearSlop},b2DistanceJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},b2DistanceJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},b2DistanceJoint.prototype.GetReactionForce=function(t){return new b2Vec2(t*this.m_impulse*this.m_u.x,t*this.m_impulse*this.m_u.y)},b2DistanceJoint.prototype.GetReactionTorque=function(t){return 0},b2DistanceJoint.prototype.GetLength=function(){return this.m_length},b2DistanceJoint.prototype.SetLength=function(t){this.m_length=t},b2DistanceJoint.prototype.GetFrequency=function(){return this.m_frequencyHz},b2DistanceJoint.prototype.SetFrequency=function(t){this.m_frequencyHz=t},b2DistanceJoint.prototype.GetDampingRatio=function(){return this.m_dampingRatio},b2DistanceJoint.prototype.SetDampingRatio=function(t){this.m_dampingRatio=t},b2DistanceJoint.prototype.m_localAnchor1=new b2Vec2,b2DistanceJoint.prototype.m_localAnchor2=new b2Vec2,b2DistanceJoint.prototype.m_u=new b2Vec2,b2DistanceJoint.prototype.m_frequencyHz=null,b2DistanceJoint.prototype.m_dampingRatio=null,b2DistanceJoint.prototype.m_gamma=null,b2DistanceJoint.prototype.m_bias=null,b2DistanceJoint.prototype.m_impulse=null,b2DistanceJoint.prototype.m_mass=null,b2DistanceJoint.prototype.m_length=null;var b2PulleyJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PulleyJointDef.prototype,b2JointDef.prototype),b2PulleyJointDef.prototype._super=b2JointDef.prototype,b2PulleyJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_pulleyJoint,this.groundAnchorA.Set(-1,1),this.groundAnchorB.Set(1,1),this.localAnchorA.Set(-1,0),this.localAnchorB.Set(1,0),this.lengthA=0,this.maxLengthA=0,this.lengthB=0,this.maxLengthB=0,this.ratio=1,this.collideConnected=!0},b2PulleyJointDef.prototype.__varz=function(){this.groundAnchorA=new b2Vec2,this.groundAnchorB=new b2Vec2,this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2},b2PulleyJointDef.prototype.Initialize=function(t,o,e,i,n,r,s){this.bodyA=t,this.bodyB=o,this.groundAnchorA.SetV(e),this.groundAnchorB.SetV(i),this.localAnchorA=this.bodyA.GetLocalPoint(n),this.localAnchorB=this.bodyB.GetLocalPoint(r);var a=n.x-e.x,l=n.y-e.y;this.lengthA=Math.sqrt(a*a+l*l);var m=r.x-i.x,p=r.y-i.y;this.lengthB=Math.sqrt(m*m+p*p),this.ratio=s;var _=this.lengthA+this.ratio*this.lengthB;this.maxLengthA=_-this.ratio*b2PulleyJoint.b2_minPulleyLength,this.maxLengthB=(_-b2PulleyJoint.b2_minPulleyLength)/this.ratio},b2PulleyJointDef.prototype.groundAnchorA=new b2Vec2,b2PulleyJointDef.prototype.groundAnchorB=new b2Vec2,b2PulleyJointDef.prototype.localAnchorA=new b2Vec2,b2PulleyJointDef.prototype.localAnchorB=new b2Vec2,b2PulleyJointDef.prototype.lengthA=null,b2PulleyJointDef.prototype.maxLengthA=null,b2PulleyJointDef.prototype.lengthB=null,b2PulleyJointDef.prototype.maxLengthB=null,b2PulleyJointDef.prototype.ratio=null;var b2DistanceJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2DistanceJointDef.prototype,b2JointDef.prototype),b2DistanceJointDef.prototype._super=b2JointDef.prototype,b2DistanceJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_distanceJoint,this.length=1,this.frequencyHz=0,this.dampingRatio=0},b2DistanceJointDef.prototype.__varz=function(){this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2},b2DistanceJointDef.prototype.Initialize=function(t,o,e,i){this.bodyA=t,this.bodyB=o,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(e)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(i));var n=i.x-e.x,r=i.y-e.y;this.length=Math.sqrt(n*n+r*r),this.frequencyHz=0,this.dampingRatio=0},b2DistanceJointDef.prototype.localAnchorA=new b2Vec2,b2DistanceJointDef.prototype.localAnchorB=new b2Vec2,b2DistanceJointDef.prototype.length=null,b2DistanceJointDef.prototype.frequencyHz=null,b2DistanceJointDef.prototype.dampingRatio=null;var b2FrictionJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2FrictionJointDef.prototype,b2JointDef.prototype),b2FrictionJointDef.prototype._super=b2JointDef.prototype,b2FrictionJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_frictionJoint,this.maxForce=0,this.maxTorque=0},b2FrictionJointDef.prototype.__varz=function(){this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2},b2FrictionJointDef.prototype.Initialize=function(t,o,e){this.bodyA=t,this.bodyB=o,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(e)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(e))},b2FrictionJointDef.prototype.localAnchorA=new b2Vec2,b2FrictionJointDef.prototype.localAnchorB=new b2Vec2,b2FrictionJointDef.prototype.maxForce=null,b2FrictionJointDef.prototype.maxTorque=null;var b2WeldJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2WeldJointDef.prototype,b2JointDef.prototype),b2WeldJointDef.prototype._super=b2JointDef.prototype,b2WeldJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_weldJoint,this.referenceAngle=0},b2WeldJointDef.prototype.__varz=function(){this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2},b2WeldJointDef.prototype.Initialize=function(t,o,e){this.bodyA=t,this.bodyB=o, this.localAnchorA.SetV(this.bodyA.GetLocalPoint(e)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(e)),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},b2WeldJointDef.prototype.localAnchorA=new b2Vec2,b2WeldJointDef.prototype.localAnchorB=new b2Vec2,b2WeldJointDef.prototype.referenceAngle=null;var b2GearJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2GearJointDef.prototype,b2JointDef.prototype),b2GearJointDef.prototype._super=b2JointDef.prototype,b2GearJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_gearJoint,this.joint1=null,this.joint2=null,this.ratio=1},b2GearJointDef.prototype.__varz=function(){},b2GearJointDef.prototype.joint1=null,b2GearJointDef.prototype.joint2=null,b2GearJointDef.prototype.ratio=null;var b2Color=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Color.prototype.__constructor=function(t,o,e){this._r=parseInt(255*b2Math.Clamp(t,0,1)),this._g=parseInt(255*b2Math.Clamp(o,0,1)),this._b=parseInt(255*b2Math.Clamp(e,0,1))},b2Color.prototype.__varz=function(){},b2Color.prototype.Set=function(t,o,e){this._r=parseInt(255*b2Math.Clamp(t,0,1)),this._g=parseInt(255*b2Math.Clamp(o,0,1)),this._b=parseInt(255*b2Math.Clamp(e,0,1))},b2Color.prototype.__defineGetter__("r",function(){return this._r}),b2Color.prototype.__defineSetter__("r",function(t){this._r=parseInt(255*b2Math.Clamp(t,0,1))}),b2Color.prototype.__defineGetter__("g",function(){return this._g}),b2Color.prototype.__defineSetter__("g",function(t){this._g=parseInt(255*b2Math.Clamp(t,0,1))}),b2Color.prototype.__defineGetter__("b",function(){return this._g}),b2Color.prototype.__defineSetter__("b",function(t){this._b=parseInt(255*b2Math.Clamp(t,0,1))}),b2Color.prototype.__defineGetter__("color",function(){return this._r<<16|this._g<<8|this._b}),b2Color.prototype._r=0,b2Color.prototype._g=0,b2Color.prototype._b=0;var b2FrictionJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2FrictionJoint.prototype,b2Joint.prototype),b2FrictionJoint.prototype._super=b2Joint.prototype,b2FrictionJoint.prototype.__constructor=function(t){this._super.__constructor.apply(this,[t]),this.m_localAnchorA.SetV(t.localAnchorA),this.m_localAnchorB.SetV(t.localAnchorB),this.m_linearMass.SetZero(),this.m_angularMass=0,this.m_linearImpulse.SetZero(),this.m_angularImpulse=0,this.m_maxForce=t.maxForce,this.m_maxTorque=t.maxTorque},b2FrictionJoint.prototype.__varz=function(){this.m_localAnchorA=new b2Vec2,this.m_localAnchorB=new b2Vec2,this.m_linearImpulse=new b2Vec2,this.m_linearMass=new b2Mat22},b2FrictionJoint.prototype.InitVelocityConstraints=function(t){var o,e,i=this.m_bodyA,n=this.m_bodyB;o=i.m_xf.R;var r=this.m_localAnchorA.x-i.m_sweep.localCenter.x,s=this.m_localAnchorA.y-i.m_sweep.localCenter.y;e=o.col1.x*r+o.col2.x*s,s=o.col1.y*r+o.col2.y*s,r=e,o=n.m_xf.R;var a=this.m_localAnchorB.x-n.m_sweep.localCenter.x,l=this.m_localAnchorB.y-n.m_sweep.localCenter.y;e=o.col1.x*a+o.col2.x*l,l=o.col1.y*a+o.col2.y*l,a=e;var m=i.m_invMass,p=n.m_invMass,_=i.m_invI,c=n.m_invI,h=new b2Mat22;if(h.col1.x=m+p,h.col2.x=0,h.col1.y=0,h.col2.y=m+p,h.col1.x+=_*s*s,h.col2.x+=-_*r*s,h.col1.y+=-_*r*s,h.col2.y+=_*r*r,h.col1.x+=c*l*l,h.col2.x+=-c*a*l,h.col1.y+=-c*a*l,h.col2.y+=c*a*a,h.GetInverse(this.m_linearMass),this.m_angularMass=_+c,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.warmStarting){this.m_linearImpulse.x*=t.dtRatio,this.m_linearImpulse.y*=t.dtRatio,this.m_angularImpulse*=t.dtRatio;var y=this.m_linearImpulse;i.m_linearVelocity.x-=m*y.x,i.m_linearVelocity.y-=m*y.y,i.m_angularVelocity-=_*(r*y.y-s*y.x+this.m_angularImpulse),n.m_linearVelocity.x+=p*y.x,n.m_linearVelocity.y+=p*y.y,n.m_angularVelocity+=c*(a*y.y-l*y.x+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0},b2FrictionJoint.prototype.SolveVelocityConstraints=function(t){var o,e,i=this.m_bodyA,n=this.m_bodyB,r=i.m_linearVelocity,s=i.m_angularVelocity,a=n.m_linearVelocity,l=n.m_angularVelocity,m=i.m_invMass,p=n.m_invMass,_=i.m_invI,c=n.m_invI;o=i.m_xf.R;var h=this.m_localAnchorA.x-i.m_sweep.localCenter.x,y=this.m_localAnchorA.y-i.m_sweep.localCenter.y;e=o.col1.x*h+o.col2.x*y,y=o.col1.y*h+o.col2.y*y,h=e,o=n.m_xf.R;var u=this.m_localAnchorB.x-n.m_sweep.localCenter.x,b=this.m_localAnchorB.y-n.m_sweep.localCenter.y;e=o.col1.x*u+o.col2.x*b,b=o.col1.y*u+o.col2.y*b,u=e;var x,d=l-s,f=-this.m_angularMass*d,v=this.m_angularImpulse;x=t.dt*this.m_maxTorque,this.m_angularImpulse=b2Math.Clamp(this.m_angularImpulse+f,-x,x),f=this.m_angularImpulse-v,s-=_*f,l+=c*f;var g=a.x-l*b-r.x+s*y,w=a.y+l*u-r.y-s*h,S=b2Math.MulMV(this.m_linearMass,new b2Vec2(-g,-w)),C=this.m_linearImpulse.Copy();this.m_linearImpulse.Add(S),x=t.dt*this.m_maxForce,this.m_linearImpulse.LengthSquared()>x*x&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.Multiply(x)),S=b2Math.SubtractVV(this.m_linearImpulse,C),r.x-=m*S.x,r.y-=m*S.y,s-=_*(h*S.y-y*S.x),a.x+=p*S.x,a.y+=p*S.y,l+=c*(u*S.y-b*S.x),i.m_angularVelocity=s,n.m_angularVelocity=l},b2FrictionJoint.prototype.SolvePositionConstraints=function(t){return!0},b2FrictionJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)},b2FrictionJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)},b2FrictionJoint.prototype.GetReactionForce=function(t){return new b2Vec2(t*this.m_linearImpulse.x,t*this.m_linearImpulse.y)},b2FrictionJoint.prototype.GetReactionTorque=function(t){return t*this.m_angularImpulse},b2FrictionJoint.prototype.SetMaxForce=function(t){this.m_maxForce=t},b2FrictionJoint.prototype.GetMaxForce=function(){return this.m_maxForce},b2FrictionJoint.prototype.SetMaxTorque=function(t){this.m_maxTorque=t},b2FrictionJoint.prototype.GetMaxTorque=function(){return this.m_maxTorque},b2FrictionJoint.prototype.m_localAnchorA=new b2Vec2,b2FrictionJoint.prototype.m_localAnchorB=new b2Vec2,b2FrictionJoint.prototype.m_linearImpulse=new b2Vec2,b2FrictionJoint.prototype.m_angularImpulse=null,b2FrictionJoint.prototype.m_maxForce=null,b2FrictionJoint.prototype.m_maxTorque=null,b2FrictionJoint.prototype.m_linearMass=new b2Mat22,b2FrictionJoint.prototype.m_angularMass=null;var b2Distance=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Distance.prototype.__constructor=function(){},b2Distance.prototype.__varz=function(){},b2Distance.Distance=function(t,o,e){++b2Distance.b2_gjkCalls;var i=e.proxyA,n=e.proxyB,r=e.transformA,s=e.transformB,a=b2Distance.s_simplex;a.ReadCache(o,i,r,n,s);for(var l,m=a.m_vertices,p=b2Distance.s_saveA,_=b2Distance.s_saveB,c=0,h=a.GetClosestPoint(),y=h.LengthSquared(),u=y,b=0,x=0;x<20;){for(c=a.m_count,b=0;b<c;b++)p[b]=m[b].indexA,_[b]=m[b].indexB;switch(a.m_count){case 1:break;case 2:a.Solve2();break;case 3:a.Solve3();break;default:b2Settings.b2Assert(!1)}if(3==a.m_count)break;l=a.GetClosestPoint(),u=l.LengthSquared(),y=u;var d=a.GetSearchDirection();if(d.LengthSquared()<Number.MIN_VALUE*Number.MIN_VALUE)break;var f=m[a.m_count];f.indexA=i.GetSupport(b2Math.MulTMV(r.R,d.GetNegative())),f.wA=b2Math.MulX(r,i.GetVertex(f.indexA)),f.indexB=n.GetSupport(b2Math.MulTMV(s.R,d)),f.wB=b2Math.MulX(s,n.GetVertex(f.indexB)),f.w=b2Math.SubtractVV(f.wB,f.wA),++x,++b2Distance.b2_gjkIters;var v=!1;for(b=0;b<c;b++)if(f.indexA==p[b]&&f.indexB==_[b]){v=!0;break}if(v)break;++a.m_count}if(b2Distance.b2_gjkMaxIters=b2Math.Max(b2Distance.b2_gjkMaxIters,x),a.GetWitnessPoints(t.pointA,t.pointB),t.distance=b2Math.SubtractVV(t.pointA,t.pointB).Length(),t.iterations=x,a.WriteCache(o),e.useRadii){var g=i.m_radius,w=n.m_radius;if(t.distance>g+w&&t.distance>Number.MIN_VALUE){t.distance-=g+w;var S=b2Math.SubtractVV(t.pointB,t.pointA);S.Normalize(),t.pointA.x+=g*S.x,t.pointA.y+=g*S.y,t.pointB.x-=w*S.x,t.pointB.y-=w*S.y}else l=new b2Vec2,l.x=.5*(t.pointA.x+t.pointB.x),l.y=.5*(t.pointA.y+t.pointB.y),t.pointA.x=t.pointB.x=l.x,t.pointA.y=t.pointB.y=l.y,t.distance=0}},b2Distance.b2_gjkCalls=0,b2Distance.b2_gjkIters=0,b2Distance.b2_gjkMaxIters=0,b2Distance.s_simplex=new b2Simplex,b2Distance.s_saveA=new Array(3),b2Distance.s_saveB=new Array(3);var b2MouseJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2MouseJoint.prototype,b2Joint.prototype),b2MouseJoint.prototype._super=b2Joint.prototype,b2MouseJoint.prototype.__constructor=function(t){this._super.__constructor.apply(this,[t]),this.m_target.SetV(t.target);var o=this.m_target.x-this.m_bodyB.m_xf.position.x,e=this.m_target.y-this.m_bodyB.m_xf.position.y,i=this.m_bodyB.m_xf.R;this.m_localAnchor.x=o*i.col1.x+e*i.col1.y,this.m_localAnchor.y=o*i.col2.x+e*i.col2.y,this.m_maxForce=t.maxForce,this.m_impulse.SetZero(),this.m_frequencyHz=t.frequencyHz,this.m_dampingRatio=t.dampingRatio,this.m_beta=0,this.m_gamma=0},b2MouseJoint.prototype.__varz=function(){this.K=new b2Mat22,this.K1=new b2Mat22,this.K2=new b2Mat22,this.m_localAnchor=new b2Vec2,this.m_target=new b2Vec2,this.m_impulse=new b2Vec2,this.m_mass=new b2Mat22,this.m_C=new b2Vec2},b2MouseJoint.prototype.InitVelocityConstraints=function(t){var o=this.m_bodyB,e=o.GetMass(),i=2*Math.PI*this.m_frequencyHz,n=2*e*this.m_dampingRatio*i,r=e*i*i;this.m_gamma=t.dt*(n+t.dt*r),this.m_gamma=0!=this.m_gamma?1/this.m_gamma:0,this.m_beta=t.dt*r*this.m_gamma;var s;s=o.m_xf.R;var a=this.m_localAnchor.x-o.m_sweep.localCenter.x,l=this.m_localAnchor.y-o.m_sweep.localCenter.y,m=s.col1.x*a+s.col2.x*l;l=s.col1.y*a+s.col2.y*l,a=m;var p=o.m_invMass,_=o.m_invI;this.K1.col1.x=p,this.K1.col2.x=0,this.K1.col1.y=0,this.K1.col2.y=p,this.K2.col1.x=_*l*l,this.K2.col2.x=-_*a*l,this.K2.col1.y=-_*a*l,this.K2.col2.y=_*a*a,this.K.SetM(this.K1),this.K.AddM(this.K2),this.K.col1.x+=this.m_gamma,this.K.col2.y+=this.m_gamma,this.K.GetInverse(this.m_mass),this.m_C.x=o.m_sweep.c.x+a-this.m_target.x,this.m_C.y=o.m_sweep.c.y+l-this.m_target.y,o.m_angularVelocity*=.98,this.m_impulse.x*=t.dtRatio,this.m_impulse.y*=t.dtRatio,o.m_linearVelocity.x+=p*this.m_impulse.x,o.m_linearVelocity.y+=p*this.m_impulse.y,o.m_angularVelocity+=_*(a*this.m_impulse.y-l*this.m_impulse.x)},b2MouseJoint.prototype.SolveVelocityConstraints=function(t){var o,e,i,n=this.m_bodyB;o=n.m_xf.R;var r=this.m_localAnchor.x-n.m_sweep.localCenter.x,s=this.m_localAnchor.y-n.m_sweep.localCenter.y;e=o.col1.x*r+o.col2.x*s,s=o.col1.y*r+o.col2.y*s,r=e;var a=n.m_linearVelocity.x+-n.m_angularVelocity*s,l=n.m_linearVelocity.y+n.m_angularVelocity*r;o=this.m_mass,e=a+this.m_beta*this.m_C.x+this.m_gamma*this.m_impulse.x,i=l+this.m_beta*this.m_C.y+this.m_gamma*this.m_impulse.y;var m=-(o.col1.x*e+o.col2.x*i),p=-(o.col1.y*e+o.col2.y*i),_=this.m_impulse.x,c=this.m_impulse.y;this.m_impulse.x+=m,this.m_impulse.y+=p;var h=t.dt*this.m_maxForce;this.m_impulse.LengthSquared()>h*h&&this.m_impulse.Multiply(h/this.m_impulse.Length()),m=this.m_impulse.x-_,p=this.m_impulse.y-c,n.m_linearVelocity.x+=n.m_invMass*m,n.m_linearVelocity.y+=n.m_invMass*p,n.m_angularVelocity+=n.m_invI*(r*p-s*m)},b2MouseJoint.prototype.SolvePositionConstraints=function(t){return!0},b2MouseJoint.prototype.GetAnchorA=function(){return this.m_target},b2MouseJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor)},b2MouseJoint.prototype.GetReactionForce=function(t){return new b2Vec2(t*this.m_impulse.x,t*this.m_impulse.y)},b2MouseJoint.prototype.GetReactionTorque=function(t){return 0},b2MouseJoint.prototype.GetTarget=function(){return this.m_target},b2MouseJoint.prototype.SetTarget=function(t){0==this.m_bodyB.IsAwake()&&this.m_bodyB.SetAwake(!0),this.m_target=t},b2MouseJoint.prototype.GetMaxForce=function(){return this.m_maxForce},b2MouseJoint.prototype.SetMaxForce=function(t){this.m_maxForce=t},b2MouseJoint.prototype.GetFrequency=function(){return this.m_frequencyHz},b2MouseJoint.prototype.SetFrequency=function(t){this.m_frequencyHz=t},b2MouseJoint.prototype.GetDampingRatio=function(){return this.m_dampingRatio},b2MouseJoint.prototype.SetDampingRatio=function(t){this.m_dampingRatio=t},b2MouseJoint.prototype.K=new b2Mat22,b2MouseJoint.prototype.K1=new b2Mat22,b2MouseJoint.prototype.K2=new b2Mat22,b2MouseJoint.prototype.m_localAnchor=new b2Vec2,b2MouseJoint.prototype.m_target=new b2Vec2,b2MouseJoint.prototype.m_impulse=new b2Vec2,b2MouseJoint.prototype.m_mass=new b2Mat22,b2MouseJoint.prototype.m_C=new b2Vec2,b2MouseJoint.prototype.m_maxForce=null,b2MouseJoint.prototype.m_frequencyHz=null,b2MouseJoint.prototype.m_dampingRatio=null,b2MouseJoint.prototype.m_beta=null,b2MouseJoint.prototype.m_gamma=null;var b2PrismaticJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PrismaticJointDef.prototype,b2JointDef.prototype),b2PrismaticJointDef.prototype._super=b2JointDef.prototype,b2PrismaticJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_prismaticJoint,this.localAxisA.Set(1,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0},b2PrismaticJointDef.prototype.__varz=function(){this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2,this.localAxisA=new b2Vec2},b2PrismaticJointDef.prototype.Initialize=function(t,o,e,i){this.bodyA=t,this.bodyB=o,this.localAnchorA=this.bodyA.GetLocalPoint(e),this.localAnchorB=this.bodyB.GetLocalPoint(e),this.localAxisA=this.bodyA.GetLocalVector(i),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},b2PrismaticJointDef.prototype.localAnchorA=new b2Vec2,b2PrismaticJointDef.prototype.localAnchorB=new b2Vec2,b2PrismaticJointDef.prototype.localAxisA=new b2Vec2,b2PrismaticJointDef.prototype.referenceAngle=null,b2PrismaticJointDef.prototype.enableLimit=null,b2PrismaticJointDef.prototype.lowerTranslation=null,b2PrismaticJointDef.prototype.upperTranslation=null,b2PrismaticJointDef.prototype.enableMotor=null,b2PrismaticJointDef.prototype.maxMotorForce=null,b2PrismaticJointDef.prototype.motorSpeed=null;var b2TimeOfImpact=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2TimeOfImpact.prototype.__constructor=function(){},b2TimeOfImpact.prototype.__varz=function(){},b2TimeOfImpact.TimeOfImpact=function(t){++b2TimeOfImpact.b2_toiCalls;var o=t.proxyA,e=t.proxyB,i=t.sweepA,n=t.sweepB;b2Settings.b2Assert(i.t0==n.t0),b2Settings.b2Assert(1-i.t0>Number.MIN_VALUE);var r=o.m_radius+e.m_radius,s=t.tolerance,a=0,l=0,m=0;for(b2TimeOfImpact.s_cache.count=0,b2TimeOfImpact.s_distanceInput.useRadii=!1;;){if(i.GetTransform(b2TimeOfImpact.s_xfA,a),n.GetTransform(b2TimeOfImpact.s_xfB,a),b2TimeOfImpact.s_distanceInput.proxyA=o,b2TimeOfImpact.s_distanceInput.proxyB=e,b2TimeOfImpact.s_distanceInput.transformA=b2TimeOfImpact.s_xfA,b2TimeOfImpact.s_distanceInput.transformB=b2TimeOfImpact.s_xfB,b2Distance.Distance(b2TimeOfImpact.s_distanceOutput,b2TimeOfImpact.s_cache,b2TimeOfImpact.s_distanceInput),b2TimeOfImpact.s_distanceOutput.distance<=0){a=1;break}b2TimeOfImpact.s_fcn.Initialize(b2TimeOfImpact.s_cache,o,b2TimeOfImpact.s_xfA,e,b2TimeOfImpact.s_xfB);var p=b2TimeOfImpact.s_fcn.Evaluate(b2TimeOfImpact.s_xfA,b2TimeOfImpact.s_xfB);if(p<=0){a=1;break}if(0==l&&(m=p>r?b2Math.Max(r-s,.75*r):b2Math.Max(p-s,.02*r)),p-m<.5*s){if(0==l){a=1;break}break}var _=a,c=a,h=1,y=p;i.GetTransform(b2TimeOfImpact.s_xfA,h),n.GetTransform(b2TimeOfImpact.s_xfB,h);var u=b2TimeOfImpact.s_fcn.Evaluate(b2TimeOfImpact.s_xfA,b2TimeOfImpact.s_xfB);if(u>=m){a=1;break}for(var b=0;;){var x;x=1&b?c+(m-y)*(h-c)/(u-y):.5*(c+h),i.GetTransform(b2TimeOfImpact.s_xfA,x),n.GetTransform(b2TimeOfImpact.s_xfB,x);var d=b2TimeOfImpact.s_fcn.Evaluate(b2TimeOfImpact.s_xfA,b2TimeOfImpact.s_xfB);if(b2Math.Abs(d-m)<.025*s){_=x;break}if(d>m?(c=x,y=d):(h=x,u=d),++b,++b2TimeOfImpact.b2_toiRootIters,50==b)break}if(b2TimeOfImpact.b2_toiMaxRootIters=b2Math.Max(b2TimeOfImpact.b2_toiMaxRootIters,b),_<(1+100*Number.MIN_VALUE)*a)break;if(a=_,l++,++b2TimeOfImpact.b2_toiIters,1e3==l)break}return b2TimeOfImpact.b2_toiMaxIters=b2Math.Max(b2TimeOfImpact.b2_toiMaxIters,l),a},b2TimeOfImpact.b2_toiCalls=0,b2TimeOfImpact.b2_toiIters=0,b2TimeOfImpact.b2_toiMaxIters=0,b2TimeOfImpact.b2_toiRootIters=0,b2TimeOfImpact.b2_toiMaxRootIters=0,b2TimeOfImpact.s_cache=new b2SimplexCache,b2TimeOfImpact.s_distanceInput=new b2DistanceInput,b2TimeOfImpact.s_xfA=new b2Transform,b2TimeOfImpact.s_xfB=new b2Transform,b2TimeOfImpact.s_fcn=new b2SeparationFunction,b2TimeOfImpact.s_distanceOutput=new b2DistanceOutput;var b2GearJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2GearJoint.prototype,b2Joint.prototype),b2GearJoint.prototype._super=b2Joint.prototype,b2GearJoint.prototype.__constructor=function(t){this._super.__constructor.apply(this,[t]);var o=t.joint1.m_type,e=t.joint2.m_type;this.m_revolute1=null,this.m_prismatic1=null,this.m_revolute2=null,this.m_prismatic2=null;var i,n;this.m_ground1=t.joint1.GetBodyA(),this.m_bodyA=t.joint1.GetBodyB(),o==b2Joint.e_revoluteJoint?(this.m_revolute1=t.joint1,this.m_groundAnchor1.SetV(this.m_revolute1.m_localAnchor1),this.m_localAnchor1.SetV(this.m_revolute1.m_localAnchor2),i=this.m_revolute1.GetJointAngle()):(this.m_prismatic1=t.joint1,this.m_groundAnchor1.SetV(this.m_prismatic1.m_localAnchor1),this.m_localAnchor1.SetV(this.m_prismatic1.m_localAnchor2),i=this.m_prismatic1.GetJointTranslation()),this.m_ground2=t.joint2.GetBodyA(),this.m_bodyB=t.joint2.GetBodyB(),e==b2Joint.e_revoluteJoint?(this.m_revolute2=t.joint2,this.m_groundAnchor2.SetV(this.m_revolute2.m_localAnchor1),this.m_localAnchor2.SetV(this.m_revolute2.m_localAnchor2),n=this.m_revolute2.GetJointAngle()):(this.m_prismatic2=t.joint2,this.m_groundAnchor2.SetV(this.m_prismatic2.m_localAnchor1),this.m_localAnchor2.SetV(this.m_prismatic2.m_localAnchor2),n=this.m_prismatic2.GetJointTranslation()),this.m_ratio=t.ratio,this.m_constant=i+this.m_ratio*n,this.m_impulse=0},b2GearJoint.prototype.__varz=function(){this.m_groundAnchor1=new b2Vec2,this.m_groundAnchor2=new b2Vec2,this.m_localAnchor1=new b2Vec2,this.m_localAnchor2=new b2Vec2,this.m_J=new b2Jacobian},b2GearJoint.prototype.InitVelocityConstraints=function(t){var o,e,i,n,r,s,a,l,m=this.m_ground1,p=this.m_ground2,_=this.m_bodyA,c=this.m_bodyB,h=0;this.m_J.SetZero(),this.m_revolute1?(this.m_J.angularA=-1,h+=_.m_invI):(r=m.m_xf.R,s=this.m_prismatic1.m_localXAxis1,o=r.col1.x*s.x+r.col2.x*s.y,e=r.col1.y*s.x+r.col2.y*s.y,r=_.m_xf.R,i=this.m_localAnchor1.x-_.m_sweep.localCenter.x,n=this.m_localAnchor1.y-_.m_sweep.localCenter.y,l=r.col1.x*i+r.col2.x*n,n=r.col1.y*i+r.col2.y*n,i=l,a=i*e-n*o,this.m_J.linearA.Set(-o,-e),this.m_J.angularA=-a,h+=_.m_invMass+_.m_invI*a*a),this.m_revolute2?(this.m_J.angularB=-this.m_ratio,h+=this.m_ratio*this.m_ratio*c.m_invI):(r=p.m_xf.R,s=this.m_prismatic2.m_localXAxis1,o=r.col1.x*s.x+r.col2.x*s.y,e=r.col1.y*s.x+r.col2.y*s.y,r=c.m_xf.R,i=this.m_localAnchor2.x-c.m_sweep.localCenter.x,n=this.m_localAnchor2.y-c.m_sweep.localCenter.y,l=r.col1.x*i+r.col2.x*n,n=r.col1.y*i+r.col2.y*n,i=l,a=i*e-n*o,this.m_J.linearB.Set(-this.m_ratio*o,-this.m_ratio*e),this.m_J.angularB=-this.m_ratio*a,h+=this.m_ratio*this.m_ratio*(c.m_invMass+c.m_invI*a*a)),this.m_mass=h>0?1/h:0,t.warmStarting?(_.m_linearVelocity.x+=_.m_invMass*this.m_impulse*this.m_J.linearA.x,_.m_linearVelocity.y+=_.m_invMass*this.m_impulse*this.m_J.linearA.y,_.m_angularVelocity+=_.m_invI*this.m_impulse*this.m_J.angularA,c.m_linearVelocity.x+=c.m_invMass*this.m_impulse*this.m_J.linearB.x,c.m_linearVelocity.y+=c.m_invMass*this.m_impulse*this.m_J.linearB.y,c.m_angularVelocity+=c.m_invI*this.m_impulse*this.m_J.angularB):this.m_impulse=0},b2GearJoint.prototype.SolveVelocityConstraints=function(t){var o=this.m_bodyA,e=this.m_bodyB,i=this.m_J.Compute(o.m_linearVelocity,o.m_angularVelocity,e.m_linearVelocity,e.m_angularVelocity),n=-this.m_mass*i;this.m_impulse+=n,o.m_linearVelocity.x+=o.m_invMass*n*this.m_J.linearA.x,o.m_linearVelocity.y+=o.m_invMass*n*this.m_J.linearA.y,o.m_angularVelocity+=o.m_invI*n*this.m_J.angularA,e.m_linearVelocity.x+=e.m_invMass*n*this.m_J.linearB.x,e.m_linearVelocity.y+=e.m_invMass*n*this.m_J.linearB.y,e.m_angularVelocity+=e.m_invI*n*this.m_J.angularB},b2GearJoint.prototype.SolvePositionConstraints=function(t){var o,e,i=this.m_bodyA,n=this.m_bodyB;o=this.m_revolute1?this.m_revolute1.GetJointAngle():this.m_prismatic1.GetJointTranslation(),e=this.m_revolute2?this.m_revolute2.GetJointAngle():this.m_prismatic2.GetJointTranslation();var r=this.m_constant-(o+this.m_ratio*e),s=-this.m_mass*r;return i.m_sweep.c.x+=i.m_invMass*s*this.m_J.linearA.x,i.m_sweep.c.y+=i.m_invMass*s*this.m_J.linearA.y,i.m_sweep.a+=i.m_invI*s*this.m_J.angularA,n.m_sweep.c.x+=n.m_invMass*s*this.m_J.linearB.x,n.m_sweep.c.y+=n.m_invMass*s*this.m_J.linearB.y,n.m_sweep.a+=n.m_invI*s*this.m_J.angularB,i.SynchronizeTransform(),n.SynchronizeTransform(),0<b2Settings.b2_linearSlop},b2GearJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},b2GearJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},b2GearJoint.prototype.GetReactionForce=function(t){return new b2Vec2(t*this.m_impulse*this.m_J.linearB.x,t*this.m_impulse*this.m_J.linearB.y)},b2GearJoint.prototype.GetReactionTorque=function(t){var o=this.m_bodyB.m_xf.R,e=this.m_localAnchor1.x-this.m_bodyB.m_sweep.localCenter.x,i=this.m_localAnchor1.y-this.m_bodyB.m_sweep.localCenter.y,n=o.col1.x*e+o.col2.x*i;i=o.col1.y*e+o.col2.y*i,e=n;var r=this.m_impulse*this.m_J.linearB.x,s=this.m_impulse*this.m_J.linearB.y;return t*(this.m_impulse*this.m_J.angularB-e*s+i*r)},b2GearJoint.prototype.GetRatio=function(){return this.m_ratio},b2GearJoint.prototype.SetRatio=function(t){this.m_ratio=t},b2GearJoint.prototype.m_ground1=null,b2GearJoint.prototype.m_ground2=null,b2GearJoint.prototype.m_revolute1=null,b2GearJoint.prototype.m_prismatic1=null,b2GearJoint.prototype.m_revolute2=null,b2GearJoint.prototype.m_prismatic2=null,b2GearJoint.prototype.m_groundAnchor1=new b2Vec2,b2GearJoint.prototype.m_groundAnchor2=new b2Vec2,b2GearJoint.prototype.m_localAnchor1=new b2Vec2,b2GearJoint.prototype.m_localAnchor2=new b2Vec2,b2GearJoint.prototype.m_J=new b2Jacobian,b2GearJoint.prototype.m_constant=null,b2GearJoint.prototype.m_ratio=null,b2GearJoint.prototype.m_mass=null,b2GearJoint.prototype.m_impulse=null;var b2TOIInput=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2TOIInput.prototype.__constructor=function(){},b2TOIInput.prototype.__varz=function(){this.proxyA=new b2DistanceProxy,this.proxyB=new b2DistanceProxy,this.sweepA=new b2Sweep,this.sweepB=new b2Sweep},b2TOIInput.prototype.proxyA=new b2DistanceProxy,b2TOIInput.prototype.proxyB=new b2DistanceProxy,b2TOIInput.prototype.sweepA=new b2Sweep,b2TOIInput.prototype.sweepB=new b2Sweep,b2TOIInput.prototype.tolerance=null;var b2RevoluteJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2RevoluteJointDef.prototype,b2JointDef.prototype),b2RevoluteJointDef.prototype._super=b2JointDef.prototype,b2RevoluteJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_revoluteJoint,this.localAnchorA.Set(0,0),this.localAnchorB.Set(0,0),this.referenceAngle=0,this.lowerAngle=0,this.upperAngle=0,this.maxMotorTorque=0,this.motorSpeed=0,this.enableLimit=!1,this.enableMotor=!1},b2RevoluteJointDef.prototype.__varz=function(){this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2},b2RevoluteJointDef.prototype.Initialize=function(t,o,e){this.bodyA=t,this.bodyB=o,this.localAnchorA=this.bodyA.GetLocalPoint(e),this.localAnchorB=this.bodyB.GetLocalPoint(e),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},b2RevoluteJointDef.prototype.localAnchorA=new b2Vec2,b2RevoluteJointDef.prototype.localAnchorB=new b2Vec2,b2RevoluteJointDef.prototype.referenceAngle=null,b2RevoluteJointDef.prototype.enableLimit=null,b2RevoluteJointDef.prototype.lowerAngle=null,b2RevoluteJointDef.prototype.upperAngle=null,b2RevoluteJointDef.prototype.enableMotor=null,b2RevoluteJointDef.prototype.motorSpeed=null,b2RevoluteJointDef.prototype.maxMotorTorque=null;var b2MouseJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2MouseJointDef.prototype,b2JointDef.prototype),b2MouseJointDef.prototype._super=b2JointDef.prototype,b2MouseJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_mouseJoint,this.maxForce=0,this.frequencyHz=5,this.dampingRatio=.7},b2MouseJointDef.prototype.__varz=function(){this.target=new b2Vec2},b2MouseJointDef.prototype.target=new b2Vec2,b2MouseJointDef.prototype.maxForce=null,b2MouseJointDef.prototype.frequencyHz=null,b2MouseJointDef.prototype.dampingRatio=null;var b2Contact=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Contact.prototype.__constructor=function(){},b2Contact.prototype.__varz=function(){this.m_nodeA=new b2ContactEdge,this.m_nodeB=new b2ContactEdge,this.m_manifold=new b2Manifold,this.m_oldManifold=new b2Manifold},b2Contact.s_input=new b2TOIInput,b2Contact.e_sensorFlag=1,b2Contact.e_continuousFlag=2,b2Contact.e_islandFlag=4,b2Contact.e_toiFlag=8,b2Contact.e_touchingFlag=16,b2Contact.e_enabledFlag=32,b2Contact.e_filterFlag=64,b2Contact.prototype.Reset=function(t,o){if(this.m_flags=b2Contact.e_enabledFlag,!t||!o)return this.m_fixtureA=null,void(this.m_fixtureB=null);(t.IsSensor()||o.IsSensor())&&(this.m_flags|=b2Contact.e_sensorFlag);var e=t.GetBody(),i=o.GetBody();(e.GetType()!=b2Body.b2_dynamicBody||e.IsBullet()||i.GetType()!=b2Body.b2_dynamicBody||i.IsBullet())&&(this.m_flags|=b2Contact.e_continuousFlag),this.m_fixtureA=t,this.m_fixtureB=o,this.m_manifold.m_pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.contact=null,this.m_nodeA.prev=null,this.m_nodeA.next=null,this.m_nodeA.other=null,this.m_nodeB.contact=null,this.m_nodeB.prev=null,this.m_nodeB.next=null,this.m_nodeB.other=null},b2Contact.prototype.Update=function(t){var o=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=o,this.m_flags|=b2Contact.e_enabledFlag;var e=!1,i=(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag,n=this.m_fixtureA.m_body,r=this.m_fixtureB.m_body,s=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag){if(s){var a=this.m_fixtureA.GetShape(),l=this.m_fixtureB.GetShape(),m=n.GetTransform(),p=r.GetTransform();e=b2Shape.TestOverlap(a,m,l,p)}this.m_manifold.m_pointCount=0}else{if(n.GetType()!=b2Body.b2_dynamicBody||n.IsBullet()||r.GetType()!=b2Body.b2_dynamicBody||r.IsBullet()?this.m_flags|=b2Contact.e_continuousFlag:this.m_flags&=~b2Contact.e_continuousFlag,s){this.Evaluate(),e=this.m_manifold.m_pointCount>0;for(var _=0;_<this.m_manifold.m_pointCount;++_){var c=this.m_manifold.m_points[_];c.m_normalImpulse=0,c.m_tangentImpulse=0;for(var h=c.m_id,y=0;y<this.m_oldManifold.m_pointCount;++y){var u=this.m_oldManifold.m_points[y];if(u.m_id.key==h.key){c.m_normalImpulse=u.m_normalImpulse,c.m_tangentImpulse=u.m_tangentImpulse;break}}}}else this.m_manifold.m_pointCount=0;e!=i&&(n.SetAwake(!0),r.SetAwake(!0))}e?this.m_flags|=b2Contact.e_touchingFlag:this.m_flags&=~b2Contact.e_touchingFlag,0==i&&1==e&&t.BeginContact(this),1==i&&0==e&&t.EndContact(this),0==(this.m_flags&b2Contact.e_sensorFlag)&&t.PreSolve(this,this.m_oldManifold)},b2Contact.prototype.Evaluate=function(){},b2Contact.prototype.ComputeTOI=function(t,o){return b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape()),b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape()),b2Contact.s_input.sweepA=t,b2Contact.s_input.sweepB=o,b2Contact.s_input.tolerance=b2Settings.b2_linearSlop,b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)},b2Contact.prototype.GetManifold=function(){return this.m_manifold},b2Contact.prototype.GetWorldManifold=function(t){var o=this.m_fixtureA.GetBody(),e=this.m_fixtureB.GetBody(),i=this.m_fixtureA.GetShape(),n=this.m_fixtureB.GetShape();t.Initialize(this.m_manifold,o.GetTransform(),i.m_radius,e.GetTransform(),n.m_radius)},b2Contact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag},b2Contact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)==b2Contact.e_continuousFlag},b2Contact.prototype.SetSensor=function(t){t?this.m_flags|=b2Contact.e_sensorFlag:this.m_flags&=~b2Contact.e_sensorFlag},b2Contact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)==b2Contact.e_sensorFlag},b2Contact.prototype.SetEnabled=function(t){t?this.m_flags|=b2Contact.e_enabledFlag:this.m_flags&=~b2Contact.e_enabledFlag},b2Contact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)==b2Contact.e_enabledFlag},b2Contact.prototype.GetNext=function(){return this.m_next},b2Contact.prototype.GetFixtureA=function(){return this.m_fixtureA},b2Contact.prototype.GetFixtureB=function(){return this.m_fixtureB},b2Contact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag},b2Contact.prototype.m_flags=0,b2Contact.prototype.m_prev=null,b2Contact.prototype.m_next=null,b2Contact.prototype.m_nodeA=new b2ContactEdge,b2Contact.prototype.m_nodeB=new b2ContactEdge,b2Contact.prototype.m_fixtureA=null,b2Contact.prototype.m_fixtureB=null,b2Contact.prototype.m_manifold=new b2Manifold,b2Contact.prototype.m_oldManifold=new b2Manifold,b2Contact.prototype.m_toi=null;var b2ContactConstraint=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactConstraint.prototype.__constructor=function(){this.points=new Array(b2Settings.b2_maxManifoldPoints);for(var t=0;t<b2Settings.b2_maxManifoldPoints;t++)this.points[t]=new b2ContactConstraintPoint},b2ContactConstraint.prototype.__varz=function(){this.localPlaneNormal=new b2Vec2,this.localPoint=new b2Vec2,this.normal=new b2Vec2,this.normalMass=new b2Mat22,this.K=new b2Mat22},b2ContactConstraint.prototype.points=null,b2ContactConstraint.prototype.localPlaneNormal=new b2Vec2,b2ContactConstraint.prototype.localPoint=new b2Vec2,b2ContactConstraint.prototype.normal=new b2Vec2,b2ContactConstraint.prototype.normalMass=new b2Mat22,b2ContactConstraint.prototype.K=new b2Mat22,b2ContactConstraint.prototype.bodyA=null,b2ContactConstraint.prototype.bodyB=null,b2ContactConstraint.prototype.type=0,b2ContactConstraint.prototype.radius=null,b2ContactConstraint.prototype.friction=null,b2ContactConstraint.prototype.restitution=null,b2ContactConstraint.prototype.pointCount=0,b2ContactConstraint.prototype.manifold=null;var b2ContactResult=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactResult.prototype.__constructor=function(){},b2ContactResult.prototype.__varz=function(){this.position=new b2Vec2,this.normal=new b2Vec2,this.id=new b2ContactID},b2ContactResult.prototype.shape1=null,b2ContactResult.prototype.shape2=null,b2ContactResult.prototype.position=new b2Vec2,b2ContactResult.prototype.normal=new b2Vec2,b2ContactResult.prototype.normalImpulse=null,b2ContactResult.prototype.tangentImpulse=null,b2ContactResult.prototype.id=new b2ContactID;var b2PolygonContact=function(){b2Contact.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PolygonContact.prototype,b2Contact.prototype),b2PolygonContact.prototype._super=b2Contact.prototype,b2PolygonContact.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2PolygonContact.prototype.__varz=function(){},b2PolygonContact.Create=function(t){return new b2PolygonContact},b2PolygonContact.Destroy=function(t,o){},b2PolygonContact.prototype.Evaluate=function(){var t=this.m_fixtureA.GetBody(),o=this.m_fixtureB.GetBody();b2Collision.CollidePolygons(this.m_manifold,this.m_fixtureA.GetShape(),t.m_xf,this.m_fixtureB.GetShape(),o.m_xf)}, b2PolygonContact.prototype.Reset=function(t,o){this._super.Reset.apply(this,[t,o])};var ClipVertex=function(){this.__varz(),this.__constructor.apply(this,arguments)};ClipVertex.prototype.__constructor=function(){},ClipVertex.prototype.__varz=function(){this.v=new b2Vec2,this.id=new b2ContactID},ClipVertex.prototype.Set=function(t){this.v.SetV(t.v),this.id.Set(t.id)},ClipVertex.prototype.v=new b2Vec2,ClipVertex.prototype.id=new b2ContactID;var b2ContactFilter=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactFilter.prototype.__constructor=function(){},b2ContactFilter.prototype.__varz=function(){},b2ContactFilter.b2_defaultFilter=new b2ContactFilter,b2ContactFilter.prototype.ShouldCollide=function(t,o){var e=t.GetFilterData(),i=o.GetFilterData();return e.groupIndex==i.groupIndex&&0!=e.groupIndex?e.groupIndex>0:0!=(e.maskBits&i.categoryBits)&&0!=(e.categoryBits&i.maskBits)},b2ContactFilter.prototype.RayCollide=function(t,o){return!t||this.ShouldCollide(t,o)};var b2NullContact=function(){b2Contact.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2NullContact.prototype,b2Contact.prototype),b2NullContact.prototype._super=b2Contact.prototype,b2NullContact.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2NullContact.prototype.__varz=function(){},b2NullContact.prototype.Evaluate=function(){};var b2ContactListener=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactListener.prototype.__constructor=function(){},b2ContactListener.prototype.__varz=function(){},b2ContactListener.b2_defaultListener=new b2ContactListener,b2ContactListener.prototype.BeginContact=function(t){},b2ContactListener.prototype.EndContact=function(t){},b2ContactListener.prototype.PreSolve=function(t,o){},b2ContactListener.prototype.PostSolve=function(t,o){};var b2Island=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Island.prototype.__constructor=function(){this.m_bodies=new Array,this.m_contacts=new Array,this.m_joints=new Array},b2Island.prototype.__varz=function(){},b2Island.s_impulse=new b2ContactImpulse,b2Island.prototype.Initialize=function(t,o,e,i,n,r){var s=0;for(this.m_bodyCapacity=t,this.m_contactCapacity=o,this.m_jointCapacity=e,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_allocator=i,this.m_listener=n,this.m_contactSolver=r,s=this.m_bodies.length;s<t;s++)this.m_bodies[s]=null;for(s=this.m_contacts.length;s<o;s++)this.m_contacts[s]=null;for(s=this.m_joints.length;s<e;s++)this.m_joints[s]=null},b2Island.prototype.Clear=function(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0},b2Island.prototype.Solve=function(t,o,e){var i,n,r=0,s=0;for(r=0;r<this.m_bodyCount;++r)i=this.m_bodies[r],i.GetType()==b2Body.b2_dynamicBody&&(i.m_linearVelocity.x+=t.dt*(o.x+i.m_invMass*i.m_force.x),i.m_linearVelocity.y+=t.dt*(o.y+i.m_invMass*i.m_force.y),i.m_angularVelocity+=t.dt*i.m_invI*i.m_torque,i.m_linearVelocity.Multiply(b2Math.Clamp(1-t.dt*i.m_linearDamping,0,1)),i.m_angularVelocity*=b2Math.Clamp(1-t.dt*i.m_angularDamping,0,1));this.m_contactSolver.Initialize(t,this.m_contacts,this.m_contactCount,this.m_allocator);var a=this.m_contactSolver;for(a.InitVelocityConstraints(t),r=0;r<this.m_jointCount;++r)n=this.m_joints[r],n.InitVelocityConstraints(t);for(r=0;r<t.velocityIterations;++r){for(s=0;s<this.m_jointCount;++s)n=this.m_joints[s],n.SolveVelocityConstraints(t);a.SolveVelocityConstraints()}for(r=0;r<this.m_jointCount;++r)n=this.m_joints[r],n.FinalizeVelocityConstraints();for(a.FinalizeVelocityConstraints(),r=0;r<this.m_bodyCount;++r)if(i=this.m_bodies[r],i.GetType()!=b2Body.b2_staticBody){var l=t.dt*i.m_linearVelocity.x,m=t.dt*i.m_linearVelocity.y;l*l+m*m>b2Settings.b2_maxTranslationSquared&&(i.m_linearVelocity.Normalize(),i.m_linearVelocity.x*=b2Settings.b2_maxTranslation*t.inv_dt,i.m_linearVelocity.y*=b2Settings.b2_maxTranslation*t.inv_dt);var p=t.dt*i.m_angularVelocity;p*p>b2Settings.b2_maxRotationSquared&&(i.m_angularVelocity<0?i.m_angularVelocity=-b2Settings.b2_maxRotation*t.inv_dt:i.m_angularVelocity=b2Settings.b2_maxRotation*t.inv_dt),i.m_sweep.c0.SetV(i.m_sweep.c),i.m_sweep.a0=i.m_sweep.a,i.m_sweep.c.x+=t.dt*i.m_linearVelocity.x,i.m_sweep.c.y+=t.dt*i.m_linearVelocity.y,i.m_sweep.a+=t.dt*i.m_angularVelocity,i.SynchronizeTransform()}for(r=0;r<t.positionIterations;++r){var _=a.SolvePositionConstraints(b2Settings.b2_contactBaumgarte),c=!0;for(s=0;s<this.m_jointCount;++s){n=this.m_joints[s];var h=n.SolvePositionConstraints(b2Settings.b2_contactBaumgarte);c=c&&h}if(_&&c)break}if(this.Report(a.m_constraints),e){var y=Number.MAX_VALUE,u=b2Settings.b2_linearSleepTolerance*b2Settings.b2_linearSleepTolerance,b=b2Settings.b2_angularSleepTolerance*b2Settings.b2_angularSleepTolerance;for(r=0;r<this.m_bodyCount;++r)i=this.m_bodies[r],i.GetType()!=b2Body.b2_staticBody&&(0==(i.m_flags&b2Body.e_allowSleepFlag)&&(i.m_sleepTime=0,y=0),0==(i.m_flags&b2Body.e_allowSleepFlag)||i.m_angularVelocity*i.m_angularVelocity>b||b2Math.Dot(i.m_linearVelocity,i.m_linearVelocity)>u?(i.m_sleepTime=0,y=0):(i.m_sleepTime+=t.dt,y=b2Math.Min(y,i.m_sleepTime)));if(y>=b2Settings.b2_timeToSleep)for(r=0;r<this.m_bodyCount;++r)i=this.m_bodies[r],i.SetAwake(!1)}},b2Island.prototype.SolveTOI=function(t){var o=0,e=0;this.m_contactSolver.Initialize(t,this.m_contacts,this.m_contactCount,this.m_allocator);var i=this.m_contactSolver;for(o=0;o<this.m_jointCount;++o)this.m_joints[o].InitVelocityConstraints(t);for(o=0;o<t.velocityIterations;++o)for(i.SolveVelocityConstraints(),e=0;e<this.m_jointCount;++e)this.m_joints[e].SolveVelocityConstraints(t);for(o=0;o<this.m_bodyCount;++o){var n=this.m_bodies[o];if(n.GetType()!=b2Body.b2_staticBody){var r=t.dt*n.m_linearVelocity.x,s=t.dt*n.m_linearVelocity.y;r*r+s*s>b2Settings.b2_maxTranslationSquared&&(n.m_linearVelocity.Normalize(),n.m_linearVelocity.x*=b2Settings.b2_maxTranslation*t.inv_dt,n.m_linearVelocity.y*=b2Settings.b2_maxTranslation*t.inv_dt);var a=t.dt*n.m_angularVelocity;a*a>b2Settings.b2_maxRotationSquared&&(n.m_angularVelocity<0?n.m_angularVelocity=-b2Settings.b2_maxRotation*t.inv_dt:n.m_angularVelocity=b2Settings.b2_maxRotation*t.inv_dt),n.m_sweep.c0.SetV(n.m_sweep.c),n.m_sweep.a0=n.m_sweep.a,n.m_sweep.c.x+=t.dt*n.m_linearVelocity.x,n.m_sweep.c.y+=t.dt*n.m_linearVelocity.y,n.m_sweep.a+=t.dt*n.m_angularVelocity,n.SynchronizeTransform()}}for(o=0;o<t.positionIterations;++o){var l=i.SolvePositionConstraints(.75),m=!0;for(e=0;e<this.m_jointCount;++e){var p=this.m_joints[e].SolvePositionConstraints(b2Settings.b2_contactBaumgarte);m=m&&p}if(l&&m)break}this.Report(i.m_constraints)},b2Island.prototype.Report=function(t){if(null!=this.m_listener)for(var o=0;o<this.m_contactCount;++o){for(var e=this.m_contacts[o],i=t[o],n=0;n<i.pointCount;++n)b2Island.s_impulse.normalImpulses[n]=i.points[n].normalImpulse,b2Island.s_impulse.tangentImpulses[n]=i.points[n].tangentImpulse;this.m_listener.PostSolve(e,b2Island.s_impulse)}},b2Island.prototype.AddBody=function(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t},b2Island.prototype.AddContact=function(t){this.m_contacts[this.m_contactCount++]=t},b2Island.prototype.AddJoint=function(t){this.m_joints[this.m_jointCount++]=t},b2Island.prototype.m_allocator=null,b2Island.prototype.m_listener=null,b2Island.prototype.m_contactSolver=null,b2Island.prototype.m_bodies=null,b2Island.prototype.m_contacts=null,b2Island.prototype.m_joints=null,b2Island.prototype.m_bodyCount=0,b2Island.prototype.m_jointCount=0,b2Island.prototype.m_contactCount=0,b2Island.prototype.m_bodyCapacity=0,b2Island.prototype.m_contactCapacity=0,b2Island.prototype.m_jointCapacity=0;var b2PolyAndEdgeContact=function(){b2Contact.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PolyAndEdgeContact.prototype,b2Contact.prototype),b2PolyAndEdgeContact.prototype._super=b2Contact.prototype,b2PolyAndEdgeContact.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2PolyAndEdgeContact.prototype.__varz=function(){},b2PolyAndEdgeContact.Create=function(t){return new b2PolyAndEdgeContact},b2PolyAndEdgeContact.Destroy=function(t,o){},b2PolyAndEdgeContact.prototype.Evaluate=function(){var t=this.m_fixtureA.GetBody(),o=this.m_fixtureB.GetBody();this.b2CollidePolyAndEdge(this.m_manifold,this.m_fixtureA.GetShape(),t.m_xf,this.m_fixtureB.GetShape(),o.m_xf)},b2PolyAndEdgeContact.prototype.b2CollidePolyAndEdge=function(t,o,e,i,n){},b2PolyAndEdgeContact.prototype.Reset=function(t,o){this._super.Reset.apply(this,[t,o]),b2Settings.b2Assert(t.GetType()==b2Shape.e_polygonShape),b2Settings.b2Assert(o.GetType()==b2Shape.e_edgeShape)};var b2Collision=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Collision.prototype.__constructor=function(){},b2Collision.prototype.__varz=function(){},b2Collision.MakeClipPointVector=function(){var t=new Array(2);return t[0]=new ClipVertex,t[1]=new ClipVertex,t},b2Collision.ClipSegmentToLine=function(t,o,e,i){var n,r=0;n=o[0];var s=n.v;n=o[1];var a=n.v,l=e.x*s.x+e.y*s.y-i,m=e.x*a.x+e.y*a.y-i;if(l<=0&&t[r++].Set(o[0]),m<=0&&t[r++].Set(o[1]),l*m<0){var p=l/(l-m);n=t[r];var _=n.v;_.x=s.x+p*(a.x-s.x),_.y=s.y+p*(a.y-s.y),n=t[r];var c;l>0?(c=o[0],n.id=c.id):(c=o[1],n.id=c.id),++r}return r},b2Collision.EdgeSeparation=function(t,o,e,i,n){var r,s,a=(t.m_vertexCount,t.m_vertices),l=t.m_normals,m=i.m_vertexCount,p=i.m_vertices;r=o.R,s=l[e];var _=r.col1.x*s.x+r.col2.x*s.y,c=r.col1.y*s.x+r.col2.y*s.y;r=n.R;for(var h=r.col1.x*_+r.col1.y*c,y=r.col2.x*_+r.col2.y*c,u=0,b=Number.MAX_VALUE,x=0;x<m;++x){s=p[x];var d=s.x*h+s.y*y;d<b&&(b=d,u=x)}s=a[e],r=o.R;var f=o.position.x+(r.col1.x*s.x+r.col2.x*s.y),v=o.position.y+(r.col1.y*s.x+r.col2.y*s.y);s=p[u],r=n.R;var g=n.position.x+(r.col1.x*s.x+r.col2.x*s.y),w=n.position.y+(r.col1.y*s.x+r.col2.y*s.y);return g-=f,w-=v,g*_+w*c},b2Collision.FindMaxSeparation=function(t,o,e,i,n){var r,s,a=o.m_vertexCount,l=o.m_normals;s=n.R,r=i.m_centroid;var m=n.position.x+(s.col1.x*r.x+s.col2.x*r.y),p=n.position.y+(s.col1.y*r.x+s.col2.y*r.y);s=e.R,r=o.m_centroid,m-=e.position.x+(s.col1.x*r.x+s.col2.x*r.y),p-=e.position.y+(s.col1.y*r.x+s.col2.y*r.y);for(var _=m*e.R.col1.x+p*e.R.col1.y,c=m*e.R.col2.x+p*e.R.col2.y,h=0,y=-Number.MAX_VALUE,u=0;u<a;++u){r=l[u];var b=r.x*_+r.y*c;b>y&&(y=b,h=u)}var x,d=b2Collision.EdgeSeparation(o,e,h,i,n),f=h-1>=0?h-1:a-1,v=b2Collision.EdgeSeparation(o,e,f,i,n),g=h+1<a?h+1:0,w=b2Collision.EdgeSeparation(o,e,g,i,n),S=0,C=0;if(v>d&&v>w)C=-1,S=f,x=v;else{if(!(w>d))return t[0]=h,d;C=1,S=g,x=w}for(;;){if(h=C==-1?S-1>=0?S-1:a-1:S+1<a?S+1:0,!((d=b2Collision.EdgeSeparation(o,e,h,i,n))>x))break;S=h,x=d}return t[0]=S,x},b2Collision.FindIncidentEdge=function(t,o,e,i,n,r){var s,a,l=(o.m_vertexCount,o.m_normals),m=n.m_vertexCount,p=n.m_vertices,_=n.m_normals;s=e.R,a=l[i];var c=s.col1.x*a.x+s.col2.x*a.y,h=s.col1.y*a.x+s.col2.y*a.y;s=r.R;var y=s.col1.x*c+s.col1.y*h;h=s.col2.x*c+s.col2.y*h,c=y;for(var u=0,b=Number.MAX_VALUE,x=0;x<m;++x){a=_[x];var d=c*a.x+h*a.y;d<b&&(b=d,u=x)}var f,v=u,g=v+1<m?v+1:0;f=t[0],a=p[v],s=r.R,f.v.x=r.position.x+(s.col1.x*a.x+s.col2.x*a.y),f.v.y=r.position.y+(s.col1.y*a.x+s.col2.y*a.y),f.id.features.referenceEdge=i,f.id.features.incidentEdge=v,f.id.features.incidentVertex=0,f=t[1],a=p[g],s=r.R,f.v.x=r.position.x+(s.col1.x*a.x+s.col2.x*a.y),f.v.y=r.position.y+(s.col1.y*a.x+s.col2.y*a.y),f.id.features.referenceEdge=i,f.id.features.incidentEdge=g,f.id.features.incidentVertex=1},b2Collision.CollidePolygons=function(t,o,e,i,n){var r;t.m_pointCount=0;var s=o.m_radius+i.m_radius,a=0;b2Collision.s_edgeAO[0]=a;var l=b2Collision.FindMaxSeparation(b2Collision.s_edgeAO,o,e,i,n);if(a=b2Collision.s_edgeAO[0],!(l>s)){var m=0;b2Collision.s_edgeBO[0]=m;var p=b2Collision.FindMaxSeparation(b2Collision.s_edgeBO,i,n,o,e);if(m=b2Collision.s_edgeBO[0],!(p>s)){var _,c,h,y,u,b=0,x=0;p>.98*l+.001?(_=i,c=o,h=n,y=e,b=m,t.m_type=b2Manifold.e_faceB,x=1):(_=o,c=i,h=e,y=n,b=a,t.m_type=b2Manifold.e_faceA,x=0);var d=b2Collision.s_incidentEdge;b2Collision.FindIncidentEdge(d,_,h,b,c,y);var f,v=_.m_vertexCount,g=_.m_vertices,w=g[b];f=b+1<v?g[parseInt(b+1)]:g[0];var S=b2Collision.s_localTangent;S.Set(f.x-w.x,f.y-w.y),S.Normalize();var C=b2Collision.s_localNormal;C.x=S.y,C.y=-S.x;var A=b2Collision.s_planePoint;A.Set(.5*(w.x+f.x),.5*(w.y+f.y));var B=b2Collision.s_tangent;u=h.R,B.x=u.col1.x*S.x+u.col2.x*S.y,B.y=u.col1.y*S.x+u.col2.y*S.y;var M=b2Collision.s_tangent2;M.x=-B.x,M.y=-B.y;var V=b2Collision.s_normal;V.x=B.y,V.y=-B.x;var I=b2Collision.s_v11,P=b2Collision.s_v12;I.x=h.position.x+(u.col1.x*w.x+u.col2.x*w.y),I.y=h.position.y+(u.col1.y*w.x+u.col2.y*w.y),P.x=h.position.x+(u.col1.x*f.x+u.col2.x*f.y),P.y=h.position.y+(u.col1.y*f.x+u.col2.y*f.y);var D=V.x*I.x+V.y*I.y,J=-B.x*I.x-B.y*I.y+s,L=B.x*P.x+B.y*P.y+s,G=b2Collision.s_clipPoints1,F=b2Collision.s_clipPoints2;if(!(b2Collision.ClipSegmentToLine(G,d,M,J)<2||b2Collision.ClipSegmentToLine(F,G,B,L)<2)){t.m_localPlaneNormal.SetV(C),t.m_localPoint.SetV(A);for(var T=0,R=0;R<b2Settings.b2_maxManifoldPoints;++R){r=F[R];if(V.x*r.v.x+V.y*r.v.y-D<=s){var z=t.m_points[T];u=y.R;var E=r.v.x-y.position.x,k=r.v.y-y.position.y;z.m_localPoint.x=E*u.col1.x+k*u.col1.y,z.m_localPoint.y=E*u.col2.x+k*u.col2.y,z.m_id.Set(r.id),z.m_id.features.flip=x,++T}}t.m_pointCount=T}}}},b2Collision.CollideCircles=function(t,o,e,i,n){t.m_pointCount=0;var r,s;r=e.R,s=o.m_p;var a=e.position.x+(r.col1.x*s.x+r.col2.x*s.y),l=e.position.y+(r.col1.y*s.x+r.col2.y*s.y);r=n.R,s=i.m_p;var m=n.position.x+(r.col1.x*s.x+r.col2.x*s.y),p=n.position.y+(r.col1.y*s.x+r.col2.y*s.y),_=m-a,c=p-l,h=_*_+c*c,y=o.m_radius+i.m_radius;h>y*y||(t.m_type=b2Manifold.e_circles,t.m_localPoint.SetV(o.m_p),t.m_localPlaneNormal.SetZero(),t.m_pointCount=1,t.m_points[0].m_localPoint.SetV(i.m_p),t.m_points[0].m_id.key=0)},b2Collision.CollidePolygonAndCircle=function(t,o,e,i,n){t.m_pointCount=0;var r,s,a,l;l=n.R,a=i.m_p;var m=n.position.x+(l.col1.x*a.x+l.col2.x*a.y),p=n.position.y+(l.col1.y*a.x+l.col2.y*a.y);r=m-e.position.x,s=p-e.position.y,l=e.R;for(var _=r*l.col1.x+s*l.col1.y,c=r*l.col2.x+s*l.col2.y,h=0,y=-Number.MAX_VALUE,u=o.m_radius+i.m_radius,b=o.m_vertexCount,x=o.m_vertices,d=o.m_normals,f=0;f<b;++f){a=x[f],r=_-a.x,s=c-a.y,a=d[f];var v=a.x*r+a.y*s;if(v>u)return;v>y&&(y=v,h=f)}var g=h,w=g+1<b?g+1:0,S=x[g],C=x[w];if(y<Number.MIN_VALUE)return t.m_pointCount=1,t.m_type=b2Manifold.e_faceA,t.m_localPlaneNormal.SetV(d[h]),t.m_localPoint.x=.5*(S.x+C.x),t.m_localPoint.y=.5*(S.y+C.y),t.m_points[0].m_localPoint.SetV(i.m_p),void(t.m_points[0].m_id.key=0);var A=(_-S.x)*(C.x-S.x)+(c-S.y)*(C.y-S.y),B=(_-C.x)*(S.x-C.x)+(c-C.y)*(S.y-C.y);if(A<=0){if((_-S.x)*(_-S.x)+(c-S.y)*(c-S.y)>u*u)return;t.m_pointCount=1,t.m_type=b2Manifold.e_faceA,t.m_localPlaneNormal.x=_-S.x,t.m_localPlaneNormal.y=c-S.y,t.m_localPlaneNormal.Normalize(),t.m_localPoint.SetV(S),t.m_points[0].m_localPoint.SetV(i.m_p),t.m_points[0].m_id.key=0}else if(B<=0){if((_-C.x)*(_-C.x)+(c-C.y)*(c-C.y)>u*u)return;t.m_pointCount=1,t.m_type=b2Manifold.e_faceA,t.m_localPlaneNormal.x=_-C.x,t.m_localPlaneNormal.y=c-C.y,t.m_localPlaneNormal.Normalize(),t.m_localPoint.SetV(C),t.m_points[0].m_localPoint.SetV(i.m_p),t.m_points[0].m_id.key=0}else{var M=.5*(S.x+C.x),V=.5*(S.y+C.y);if((y=(_-M)*d[g].x+(c-V)*d[g].y)>u)return;t.m_pointCount=1,t.m_type=b2Manifold.e_faceA,t.m_localPlaneNormal.x=d[g].x,t.m_localPlaneNormal.y=d[g].y,t.m_localPlaneNormal.Normalize(),t.m_localPoint.Set(M,V),t.m_points[0].m_localPoint.SetV(i.m_p),t.m_points[0].m_id.key=0}},b2Collision.TestOverlap=function(t,o){var e=o.lowerBound,i=t.upperBound,n=e.x-i.x,r=e.y-i.y;e=t.lowerBound,i=o.upperBound;var s=e.x-i.x,a=e.y-i.y;return!(n>0||r>0)&&!(s>0||a>0)},b2Collision.b2_nullFeature=255,b2Collision.s_incidentEdge=b2Collision.MakeClipPointVector(),b2Collision.s_clipPoints1=b2Collision.MakeClipPointVector(),b2Collision.s_clipPoints2=b2Collision.MakeClipPointVector(),b2Collision.s_edgeAO=new Array(1),b2Collision.s_edgeBO=new Array(1),b2Collision.s_localTangent=new b2Vec2,b2Collision.s_localNormal=new b2Vec2,b2Collision.s_planePoint=new b2Vec2,b2Collision.s_normal=new b2Vec2,b2Collision.s_tangent=new b2Vec2,b2Collision.s_tangent2=new b2Vec2,b2Collision.s_v11=new b2Vec2,b2Collision.s_v12=new b2Vec2,b2Collision.b2CollidePolyTempVec=new b2Vec2;var b2PolyAndCircleContact=function(){b2Contact.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PolyAndCircleContact.prototype,b2Contact.prototype),b2PolyAndCircleContact.prototype._super=b2Contact.prototype,b2PolyAndCircleContact.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2PolyAndCircleContact.prototype.__varz=function(){},b2PolyAndCircleContact.Create=function(t){return new b2PolyAndCircleContact},b2PolyAndCircleContact.Destroy=function(t,o){},b2PolyAndCircleContact.prototype.Evaluate=function(){var t=this.m_fixtureA.m_body,o=this.m_fixtureB.m_body;b2Collision.CollidePolygonAndCircle(this.m_manifold,this.m_fixtureA.GetShape(),t.m_xf,this.m_fixtureB.GetShape(),o.m_xf)},b2PolyAndCircleContact.prototype.Reset=function(t,o){this._super.Reset.apply(this,[t,o]),b2Settings.b2Assert(t.GetType()==b2Shape.e_polygonShape),b2Settings.b2Assert(o.GetType()==b2Shape.e_circleShape)};var b2ContactPoint=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactPoint.prototype.__constructor=function(){},b2ContactPoint.prototype.__varz=function(){this.position=new b2Vec2,this.velocity=new b2Vec2,this.normal=new b2Vec2,this.id=new b2ContactID},b2ContactPoint.prototype.shape1=null,b2ContactPoint.prototype.shape2=null,b2ContactPoint.prototype.position=new b2Vec2,b2ContactPoint.prototype.velocity=new b2Vec2,b2ContactPoint.prototype.normal=new b2Vec2,b2ContactPoint.prototype.separation=null,b2ContactPoint.prototype.friction=null,b2ContactPoint.prototype.restitution=null,b2ContactPoint.prototype.id=new b2ContactID;var b2CircleContact=function(){b2Contact.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2CircleContact.prototype,b2Contact.prototype),b2CircleContact.prototype._super=b2Contact.prototype,b2CircleContact.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2CircleContact.prototype.__varz=function(){},b2CircleContact.Create=function(t){return new b2CircleContact},b2CircleContact.Destroy=function(t,o){},b2CircleContact.prototype.Evaluate=function(){var t=this.m_fixtureA.GetBody(),o=this.m_fixtureB.GetBody();b2Collision.CollideCircles(this.m_manifold,this.m_fixtureA.GetShape(),t.m_xf,this.m_fixtureB.GetShape(),o.m_xf)},b2CircleContact.prototype.Reset=function(t,o){this._super.Reset.apply(this,[t,o])};var b2EdgeAndCircleContact=function(){b2Contact.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2EdgeAndCircleContact.prototype,b2Contact.prototype),b2EdgeAndCircleContact.prototype._super=b2Contact.prototype,b2EdgeAndCircleContact.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2EdgeAndCircleContact.prototype.__varz=function(){},b2EdgeAndCircleContact.Create=function(t){return new b2EdgeAndCircleContact},b2EdgeAndCircleContact.Destroy=function(t,o){},b2EdgeAndCircleContact.prototype.Evaluate=function(){var t=this.m_fixtureA.GetBody(),o=this.m_fixtureB.GetBody();this.b2CollideEdgeAndCircle(this.m_manifold,this.m_fixtureA.GetShape(),t.m_xf,this.m_fixtureB.GetShape(),o.m_xf)},b2EdgeAndCircleContact.prototype.b2CollideEdgeAndCircle=function(t,o,e,i,n){},b2EdgeAndCircleContact.prototype.Reset=function(t,o){this._super.Reset.apply(this,[t,o])};var b2ContactManager=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactManager.prototype.__constructor=function(){this.m_world=null,this.m_contactCount=0,this.m_contactFilter=b2ContactFilter.b2_defaultFilter,this.m_contactListener=b2ContactListener.b2_defaultListener,this.m_contactFactory=new b2ContactFactory(this.m_allocator),this.m_broadPhase=new b2DynamicTreeBroadPhase},b2ContactManager.prototype.__varz=function(){},b2ContactManager.s_evalCP=new b2ContactPoint,b2ContactManager.prototype.AddPair=function(t,o){var e=t,i=o,n=e.GetBody(),r=i.GetBody();if(n!=r){for(var s=r.GetContactList();s;){if(s.other==n){var a=s.contact.GetFixtureA(),l=s.contact.GetFixtureB();if(a==e&&l==i)return;if(a==i&&l==e)return}s=s.next}if(0!=r.ShouldCollide(n)&&0!=this.m_contactFilter.ShouldCollide(e,i)){var m=this.m_contactFactory.Create(e,i);e=m.GetFixtureA(),i=m.GetFixtureB(),n=e.m_body,r=i.m_body,m.m_prev=null,m.m_next=this.m_world.m_contactList,null!=this.m_world.m_contactList&&(this.m_world.m_contactList.m_prev=m),this.m_world.m_contactList=m,m.m_nodeA.contact=m,m.m_nodeA.other=r,m.m_nodeA.prev=null,m.m_nodeA.next=n.m_contactList,null!=n.m_contactList&&(n.m_contactList.prev=m.m_nodeA),n.m_contactList=m.m_nodeA,m.m_nodeB.contact=m,m.m_nodeB.other=n,m.m_nodeB.prev=null,m.m_nodeB.next=r.m_contactList,null!=r.m_contactList&&(r.m_contactList.prev=m.m_nodeB),r.m_contactList=m.m_nodeB,++this.m_world.m_contactCount}}},b2ContactManager.prototype.FindNewContacts=function(){var t=this;this.m_broadPhase.UpdatePairs(function(o,e){return t.AddPair(o,e)})},b2ContactManager.prototype.Destroy=function(t){var o=t.GetFixtureA(),e=t.GetFixtureB(),i=o.GetBody(),n=e.GetBody();t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_world.m_contactList&&(this.m_world.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA==i.m_contactList&&(i.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB==n.m_contactList&&(n.m_contactList=t.m_nodeB.next),this.m_contactFactory.Destroy(t),--this.m_contactCount},b2ContactManager.prototype.Collide=function(){for(var t=this.m_world.m_contactList;t;){var o=t.GetFixtureA(),e=t.GetFixtureB(),i=o.GetBody(),n=e.GetBody();if(0!=i.IsAwake()||0!=n.IsAwake()){if(t.m_flags&b2Contact.e_filterFlag){if(0==n.ShouldCollide(i)){var r=t;t=r.GetNext(),this.Destroy(r);continue}if(0==this.m_contactFilter.ShouldCollide(o,e)){r=t,t=r.GetNext(),this.Destroy(r);continue}t.m_flags&=~b2Contact.e_filterFlag}var s=o.m_proxy,a=e.m_proxy;0!=this.m_broadPhase.TestOverlap(s,a)?(t.Update(this.m_contactListener),t=t.GetNext()):(r=t,t=r.GetNext(),this.Destroy(r))}else t=t.GetNext()}},b2ContactManager.prototype.m_world=null,b2ContactManager.prototype.m_broadPhase=null,b2ContactManager.prototype.m_contactList=null,b2ContactManager.prototype.m_contactCount=0,b2ContactManager.prototype.m_contactFilter=null,b2ContactManager.prototype.m_contactListener=null,b2ContactManager.prototype.m_contactFactory=null,b2ContactManager.prototype.m_allocator=null;var b2World=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2World.prototype.__constructor=function(t,o){this.m_destructionListener=null,this.m_debugDraw=null,this.m_bodyList=null,this.m_contactList=null,this.m_jointList=null,this.m_controllerList=null,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_controllerCount=0,b2World.m_warmStarting=!0,b2World.m_continuousPhysics=!0,this.m_allowSleep=o,this.m_gravity=t,this.m_inv_dt0=0,this.m_contactManager.m_world=this;var e=new b2BodyDef;this.m_groundBody=this.CreateBody(e)},b2World.prototype.__varz=function(){this.s_stack=new Array,this.m_contactManager=new b2ContactManager,this.m_contactSolver=new b2ContactSolver,this.m_island=new b2Island},b2World.s_timestep2=new b2TimeStep,b2World.s_backupA=new b2Sweep,b2World.s_backupB=new b2Sweep,b2World.s_timestep=new b2TimeStep,b2World.s_queue=new Array,b2World.e_newFixture=1,b2World.e_locked=2,b2World.s_xf=new b2Transform,b2World.s_jointColor=new b2Color(.5,.8,.8),b2World.m_warmStarting=null,b2World.m_continuousPhysics=null,b2World.prototype.Solve=function(t){for(var o,e=this.m_controllerList;e;e=e.m_next)e.Step(t);var i=this.m_island;for(i.Initialize(this.m_bodyCount,this.m_contactCount,this.m_jointCount,null,this.m_contactManager.m_contactListener,this.m_contactSolver),o=this.m_bodyList;o;o=o.m_next)o.m_flags&=~b2Body.e_islandFlag;for(var n=this.m_contactList;n;n=n.m_next)n.m_flags&=~b2Contact.e_islandFlag;for(var r=this.m_jointList;r;r=r.m_next)r.m_islandFlag=!1;for(var s=(this.m_bodyCount,this.s_stack),a=this.m_bodyList;a;a=a.m_next)if(!(a.m_flags&b2Body.e_islandFlag)&&0!=a.IsAwake()&&0!=a.IsActive()&&a.GetType()!=b2Body.b2_staticBody){i.Clear();var l=0;for(s[l++]=a,a.m_flags|=b2Body.e_islandFlag;l>0;)if(o=s[--l],i.AddBody(o),0==o.IsAwake()&&o.SetAwake(!0),o.GetType()!=b2Body.b2_staticBody){for(var m,p=o.m_contactList;p;p=p.next)p.contact.m_flags&b2Contact.e_islandFlag||1!=p.contact.IsSensor()&&0!=p.contact.IsEnabled()&&0!=p.contact.IsTouching()&&(i.AddContact(p.contact),p.contact.m_flags|=b2Contact.e_islandFlag,m=p.other,m.m_flags&b2Body.e_islandFlag||(s[l++]=m,m.m_flags|=b2Body.e_islandFlag));for(var _=o.m_jointList;_;_=_.next)1!=_.joint.m_islandFlag&&(m=_.other,0!=m.IsActive()&&(i.AddJoint(_.joint),_.joint.m_islandFlag=!0,m.m_flags&b2Body.e_islandFlag||(s[l++]=m,m.m_flags|=b2Body.e_islandFlag)))}i.Solve(t,this.m_gravity,this.m_allowSleep);for(var c=0;c<i.m_bodyCount;++c)o=i.m_bodies[c],o.GetType()==b2Body.b2_staticBody&&(o.m_flags&=~b2Body.e_islandFlag)}for(c=0;c<s.length&&s[c];++c)s[c]=null;for(o=this.m_bodyList;o;o=o.m_next)0!=o.IsAwake()&&0!=o.IsActive()&&o.GetType()!=b2Body.b2_staticBody&&o.SynchronizeFixtures();this.m_contactManager.FindNewContacts()},b2World.prototype.SolveTOI=function(t){var o,e,i,n,r,s,a,l=this.m_island;l.Initialize(this.m_bodyCount,b2Settings.b2_maxTOIContactsPerIsland,b2Settings.b2_maxTOIJointsPerIsland,null,this.m_contactManager.m_contactListener,this.m_contactSolver);var m=b2World.s_queue;for(o=this.m_bodyList;o;o=o.m_next)o.m_flags&=~b2Body.e_islandFlag,o.m_sweep.t0=0;var p;for(p=this.m_contactList;p;p=p.m_next)p.m_flags&=~(b2Contact.e_toiFlag|b2Contact.e_islandFlag);for(a=this.m_jointList;a;a=a.m_next)a.m_islandFlag=!1;for(;;){var _=null,c=1;for(p=this.m_contactList;p;p=p.m_next)if(1!=p.IsSensor()&&0!=p.IsEnabled()&&0!=p.IsContinuous()){var h=1;if(p.m_flags&b2Contact.e_toiFlag)h=p.m_toi;else{if(e=p.m_fixtureA,i=p.m_fixtureB,n=e.m_body,r=i.m_body,!(n.GetType()==b2Body.b2_dynamicBody&&0!=n.IsAwake()||r.GetType()==b2Body.b2_dynamicBody&&0!=r.IsAwake()))continue;var y=n.m_sweep.t0;n.m_sweep.t0<r.m_sweep.t0?(y=r.m_sweep.t0,n.m_sweep.Advance(y)):r.m_sweep.t0<n.m_sweep.t0&&(y=n.m_sweep.t0,r.m_sweep.Advance(y)),h=p.ComputeTOI(n.m_sweep,r.m_sweep),b2Settings.b2Assert(0<=h&&h<=1),h>0&&h<1&&(h=(1-h)*y+h)>1&&(h=1),p.m_toi=h,p.m_flags|=b2Contact.e_toiFlag}Number.MIN_VALUE<h&&h<c&&(_=p,c=h)}if(null==_||1-100*Number.MIN_VALUE<c)break;if(e=_.m_fixtureA,i=_.m_fixtureB,n=e.m_body,r=i.m_body,b2World.s_backupA.Set(n.m_sweep),b2World.s_backupB.Set(r.m_sweep),n.Advance(c),r.Advance(c),_.Update(this.m_contactManager.m_contactListener),_.m_flags&=~b2Contact.e_toiFlag,1!=_.IsSensor()&&0!=_.IsEnabled()){if(0!=_.IsTouching()){var u=n;u.GetType()!=b2Body.b2_dynamicBody&&(u=r),l.Clear();var b=0,x=0;for(m[b+x++]=u,u.m_flags|=b2Body.e_islandFlag;x>0;)if(o=m[b++],--x,l.AddBody(o),0==o.IsAwake()&&o.SetAwake(!0),o.GetType()==b2Body.b2_dynamicBody){for(s=o.m_contactList;s&&l.m_contactCount!=l.m_contactCapacity;s=s.next)if(!(s.contact.m_flags&b2Contact.e_islandFlag)&&1!=s.contact.IsSensor()&&0!=s.contact.IsEnabled()&&0!=s.contact.IsTouching()){l.AddContact(s.contact),s.contact.m_flags|=b2Contact.e_islandFlag;var d=s.other;d.m_flags&b2Body.e_islandFlag||(d.GetType()!=b2Body.b2_staticBody&&(d.Advance(c),d.SetAwake(!0)),m[b+x]=d,++x,d.m_flags|=b2Body.e_islandFlag)}for(var f=o.m_jointList;f;f=f.next)l.m_jointCount!=l.m_jointCapacity&&1!=f.joint.m_islandFlag&&(d=f.other,0!=d.IsActive()&&(l.AddJoint(f.joint),f.joint.m_islandFlag=!0,d.m_flags&b2Body.e_islandFlag||(d.GetType()!=b2Body.b2_staticBody&&(d.Advance(c),d.SetAwake(!0)),m[b+x]=d,++x,d.m_flags|=b2Body.e_islandFlag)))}var v=b2World.s_timestep;v.warmStarting=!1,v.dt=(1-c)*t.dt,v.inv_dt=1/v.dt,v.dtRatio=0,v.velocityIterations=t.velocityIterations,v.positionIterations=t.positionIterations,l.SolveTOI(v);var g=0;for(g=0;g<l.m_bodyCount;++g)if(o=l.m_bodies[g],o.m_flags&=~b2Body.e_islandFlag,0!=o.IsAwake()&&o.GetType()==b2Body.b2_dynamicBody)for(o.SynchronizeFixtures(),s=o.m_contactList;s;s=s.next)s.contact.m_flags&=~b2Contact.e_toiFlag;for(g=0;g<l.m_contactCount;++g)p=l.m_contacts[g],p.m_flags&=~(b2Contact.e_toiFlag|b2Contact.e_islandFlag);for(g=0;g<l.m_jointCount;++g)a=l.m_joints[g],a.m_islandFlag=!1;this.m_contactManager.FindNewContacts()}}else n.m_sweep.Set(b2World.s_backupA),r.m_sweep.Set(b2World.s_backupB),n.SynchronizeTransform(),r.SynchronizeTransform()}},b2World.prototype.DrawJoint=function(t){var o=t.GetBodyA(),e=t.GetBodyB(),i=o.m_xf,n=e.m_xf,r=i.position,s=n.position,a=t.GetAnchorA(),l=t.GetAnchorB(),m=b2World.s_jointColor;switch(t.m_type){case b2Joint.e_distanceJoint:this.m_debugDraw.DrawSegment(a,l,m);break;case b2Joint.e_pulleyJoint:var p=t,_=p.GetGroundAnchorA(),c=p.GetGroundAnchorB();this.m_debugDraw.DrawSegment(_,a,m),this.m_debugDraw.DrawSegment(c,l,m),this.m_debugDraw.DrawSegment(_,c,m);break;case b2Joint.e_mouseJoint:this.m_debugDraw.DrawSegment(a,l,m);break;default:o!=this.m_groundBody&&this.m_debugDraw.DrawSegment(r,a,m),this.m_debugDraw.DrawSegment(a,l,m),e!=this.m_groundBody&&this.m_debugDraw.DrawSegment(s,l,m)}},b2World.prototype.DrawShape=function(t,o,e){switch(t.m_type){case b2Shape.e_circleShape:var i=t,n=b2Math.MulX(o,i.m_p),r=i.m_radius,s=o.R.col1;this.m_debugDraw.DrawSolidCircle(n,r,s,e);break;case b2Shape.e_polygonShape:var a=0,l=t,m=l.GetVertexCount(),p=l.GetVertices(),_=new Array(m);for(a=0;a<m;++a)_[a]=b2Math.MulX(o,p[a]);this.m_debugDraw.DrawSolidPolygon(_,m,e);break;case b2Shape.e_edgeShape:var c=t;this.m_debugDraw.DrawSegment(b2Math.MulX(o,c.GetVertex1()),b2Math.MulX(o,c.GetVertex2()),e)}},b2World.prototype.SetDestructionListener=function(t){this.m_destructionListener=t},b2World.prototype.SetContactFilter=function(t){this.m_contactManager.m_contactFilter=t},b2World.prototype.SetContactListener=function(t){this.m_contactManager.m_contactListener=t},b2World.prototype.SetDebugDraw=function(t){this.m_debugDraw=t},b2World.prototype.SetBroadPhase=function(t){var o=this.m_contactManager.m_broadPhase;this.m_contactManager.m_broadPhase=t;for(var e=this.m_bodyList;e;e=e.m_next)for(var i=e.m_fixtureList;i;i=i.m_next)i.m_proxy=t.CreateProxy(o.GetFatAABB(i.m_proxy),i)},b2World.prototype.Validate=function(){this.m_contactManager.m_broadPhase.Validate()},b2World.prototype.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount()},b2World.prototype.CreateBody=function(t){if(1==this.IsLocked())return null;var o=new b2Body(t,this);return o.m_prev=null,o.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=o),this.m_bodyList=o,++this.m_bodyCount,o},b2World.prototype.DestroyBody=function(t){if(1!=this.IsLocked()){for(var o=t.m_jointList;o;){var e=o;o=o.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(e.joint),this.DestroyJoint(e.joint)}for(var i=t.m_controllerList;i;){var n=i;i=i.nextController,n.controller.RemoveBody(t)}for(var r=t.m_contactList;r;){var s=r;r=r.next,this.m_contactManager.Destroy(s.contact)}t.m_contactList=null;for(var a=t.m_fixtureList;a;){var l=a;a=a.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(l),l.DestroyProxy(this.m_contactManager.m_broadPhase),l.Destroy()}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount}},b2World.prototype.CreateJoint=function(t){var o=b2Joint.Create(t,null);o.m_prev=null,o.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=o),this.m_jointList=o,++this.m_jointCount,o.m_edgeA.joint=o, o.m_edgeA.other=o.m_bodyB,o.m_edgeA.prev=null,o.m_edgeA.next=o.m_bodyA.m_jointList,o.m_bodyA.m_jointList&&(o.m_bodyA.m_jointList.prev=o.m_edgeA),o.m_bodyA.m_jointList=o.m_edgeA,o.m_edgeB.joint=o,o.m_edgeB.other=o.m_bodyA,o.m_edgeB.prev=null,o.m_edgeB.next=o.m_bodyB.m_jointList,o.m_bodyB.m_jointList&&(o.m_bodyB.m_jointList.prev=o.m_edgeB),o.m_bodyB.m_jointList=o.m_edgeB;var e=t.bodyA,i=t.bodyB;if(0==t.collideConnected)for(var n=i.GetContactList();n;)n.other==e&&n.contact.FlagForFiltering(),n=n.next;return o},b2World.prototype.DestroyJoint=function(t){var o=t.m_collideConnected;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_jointList&&(this.m_jointList=t.m_next);var e=t.m_bodyA,i=t.m_bodyB;if(e.SetAwake(!0),i.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA==e.m_jointList&&(e.m_jointList=t.m_edgeA.next),t.m_edgeA.prev=null,t.m_edgeA.next=null,t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB==i.m_jointList&&(i.m_jointList=t.m_edgeB.next),t.m_edgeB.prev=null,t.m_edgeB.next=null,b2Joint.Destroy(t,null),--this.m_jointCount,0==o)for(var n=i.GetContactList();n;)n.other==e&&n.contact.FlagForFiltering(),n=n.next},b2World.prototype.AddController=function(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList=t,t.m_world=this,this.m_controllerCount++,t},b2World.prototype.RemoveController=function(t){t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList==t&&(this.m_controllerList=t.m_next),this.m_controllerCount--},b2World.prototype.CreateController=function(t){if(t.m_world!=this)throw new Error("Controller can only be a member of one world");return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t.m_world=this,t},b2World.prototype.DestroyController=function(t){t.Clear(),t.m_next&&(t.m_next.m_prev=t.m_prev),t.m_prev&&(t.m_prev.m_next=t.m_next),t==this.m_controllerList&&(this.m_controllerList=t.m_next),--this.m_controllerCount},b2World.prototype.SetWarmStarting=function(t){b2World.m_warmStarting=t},b2World.prototype.SetContinuousPhysics=function(t){b2World.m_continuousPhysics=t},b2World.prototype.GetBodyCount=function(){return this.m_bodyCount},b2World.prototype.GetJointCount=function(){return this.m_jointCount},b2World.prototype.GetContactCount=function(){return this.m_contactCount},b2World.prototype.SetGravity=function(t){this.m_gravity=t},b2World.prototype.GetGravity=function(){return this.m_gravity},b2World.prototype.GetGroundBody=function(){return this.m_groundBody},b2World.prototype.Step=function(t,o,e){this.m_flags&b2World.e_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_flags&=~b2World.e_newFixture),this.m_flags|=b2World.e_locked;var i=b2World.s_timestep2;i.dt=t,i.velocityIterations=o,i.positionIterations=e,i.inv_dt=t>0?1/t:0,i.dtRatio=this.m_inv_dt0*t,i.warmStarting=b2World.m_warmStarting,this.m_contactManager.Collide(),i.dt>0&&this.Solve(i),b2World.m_continuousPhysics&&i.dt>0&&this.SolveTOI(i),i.dt>0&&(this.m_inv_dt0=i.inv_dt),this.m_flags&=~b2World.e_locked},b2World.prototype.ClearForces=function(){for(var t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0},b2World.prototype.DrawDebugData=function(){if(null!=this.m_debugDraw){this.m_debugDraw.Clear();var t,o,e,i,n,r,s=this.m_debugDraw.GetFlags(),a=(new b2Vec2,new b2Vec2,new b2Vec2,new b2AABB,new b2AABB,[new b2Vec2,new b2Vec2,new b2Vec2,new b2Vec2]),l=new b2Color(0,0,0);if(s&b2DebugDraw.e_shapeBit)for(t=this.m_bodyList;t;t=t.m_next)for(r=t.m_xf,o=t.GetFixtureList();o;o=o.m_next)e=o.GetShape(),0==t.IsActive()?(l.Set(.5,.5,.3),this.DrawShape(e,r,l)):t.GetType()==b2Body.b2_staticBody?(l.Set(.5,.9,.5),this.DrawShape(e,r,l)):t.GetType()==b2Body.b2_kinematicBody?(l.Set(.5,.5,.9),this.DrawShape(e,r,l)):0==t.IsAwake()?(l.Set(.6,.6,.6),this.DrawShape(e,r,l)):(l.Set(.9,.7,.7),this.DrawShape(e,r,l));if(s&b2DebugDraw.e_jointBit)for(i=this.m_jointList;i;i=i.m_next)this.DrawJoint(i);if(s&b2DebugDraw.e_controllerBit)for(var m=this.m_controllerList;m;m=m.m_next)m.Draw(this.m_debugDraw);if(s&b2DebugDraw.e_pairBit){l.Set(.3,.9,.9);for(var p=this.m_contactManager.m_contactList;p;p=p.GetNext()){var _=p.GetFixtureA(),c=p.GetFixtureB(),h=_.GetAABB().GetCenter(),y=c.GetAABB().GetCenter();this.m_debugDraw.DrawSegment(h,y,l)}}if(s&b2DebugDraw.e_aabbBit)for(n=this.m_contactManager.m_broadPhase,a=[new b2Vec2,new b2Vec2,new b2Vec2,new b2Vec2],t=this.m_bodyList;t;t=t.GetNext())if(0!=t.IsActive())for(o=t.GetFixtureList();o;o=o.GetNext()){var u=n.GetFatAABB(o.m_proxy);a[0].Set(u.lowerBound.x,u.lowerBound.y),a[1].Set(u.upperBound.x,u.lowerBound.y),a[2].Set(u.upperBound.x,u.upperBound.y),a[3].Set(u.lowerBound.x,u.upperBound.y),this.m_debugDraw.DrawPolygon(a,4,l)}if(s&b2DebugDraw.e_centerOfMassBit)for(t=this.m_bodyList;t;t=t.m_next)r=b2World.s_xf,r.R=t.m_xf.R,r.position=t.GetWorldCenter(),this.m_debugDraw.DrawTransform(r)}},b2World.prototype.QueryAABB=function(t,o){function e(o){return t(i.GetUserData(o))}var i=this.m_contactManager.m_broadPhase;i.Query(e,o)},b2World.prototype.QueryShape=function(t,o,e){function i(i){var r=n.GetUserData(i);return!b2Shape.TestOverlap(o,e,r.GetShape(),r.GetBody().GetTransform())||t(r)}null==e&&(e=new b2Transform,e.SetIdentity());var n=this.m_contactManager.m_broadPhase,r=new b2AABB;o.ComputeAABB(r,e),n.Query(i,r)},b2World.prototype.QueryPoint=function(t,o){function e(e){var n=i.GetUserData(e);return!n.TestPoint(o)||t(n)}var i=this.m_contactManager.m_broadPhase,n=new b2AABB;n.lowerBound.Set(o.x-b2Settings.b2_linearSlop,o.y-b2Settings.b2_linearSlop),n.upperBound.Set(o.x+b2Settings.b2_linearSlop,o.y+b2Settings.b2_linearSlop),i.Query(e,n)},b2World.prototype.RayCast=function(t,o,e){function i(i,s){var a=n.GetUserData(s),l=a;if(l.RayCast(r,i)){var m=r.fraction,p=new b2Vec2((1-m)*o.x+m*e.x,(1-m)*o.y+m*e.y);return t(l,p,r.normal,m)}return i.maxFraction}var n=this.m_contactManager.m_broadPhase,r=new b2RayCastOutput,s=new b2RayCastInput(o,e);n.RayCast(i,s)},b2World.prototype.RayCastOne=function(t,o){function e(t,o,e,n){return i=t,n}var i;return this.RayCast(e,t,o),i},b2World.prototype.RayCastAll=function(t,o){function e(t,o,e,n){return i[i.length]=t,1}var i=new Array;return this.RayCast(e,t,o),i},b2World.prototype.GetBodyList=function(){return this.m_bodyList},b2World.prototype.GetJointList=function(){return this.m_jointList},b2World.prototype.GetContactList=function(){return this.m_contactList},b2World.prototype.IsLocked=function(){return(this.m_flags&b2World.e_locked)>0},b2World.prototype.s_stack=new Array,b2World.prototype.m_flags=0,b2World.prototype.m_contactManager=new b2ContactManager,b2World.prototype.m_contactSolver=new b2ContactSolver,b2World.prototype.m_island=new b2Island,b2World.prototype.m_bodyList=null,b2World.prototype.m_jointList=null,b2World.prototype.m_contactList=null,b2World.prototype.m_bodyCount=0,b2World.prototype.m_contactCount=0,b2World.prototype.m_jointCount=0,b2World.prototype.m_controllerList=null,b2World.prototype.m_controllerCount=0,b2World.prototype.m_gravity=null,b2World.prototype.m_allowSleep=null,b2World.prototype.m_groundBody=null,b2World.prototype.m_destructionListener=null,b2World.prototype.m_debugDraw=null,b2World.prototype.m_inv_dt0=null,"undefined"!=typeof exports&&(exports.b2BoundValues=b2BoundValues,exports.b2Math=b2Math,exports.b2DistanceOutput=b2DistanceOutput,exports.b2Mat33=b2Mat33,exports.b2ContactPoint=b2ContactPoint,exports.b2PairManager=b2PairManager,exports.b2PositionSolverManifold=b2PositionSolverManifold,exports.b2OBB=b2OBB,exports.b2CircleContact=b2CircleContact,exports.b2PulleyJoint=b2PulleyJoint,exports.b2Pair=b2Pair,exports.b2TimeStep=b2TimeStep,exports.b2FixtureDef=b2FixtureDef,exports.b2World=b2World,exports.b2PrismaticJoint=b2PrismaticJoint,exports.b2Controller=b2Controller,exports.b2ContactID=b2ContactID,exports.b2RevoluteJoint=b2RevoluteJoint,exports.b2JointDef=b2JointDef,exports.b2Transform=b2Transform,exports.b2GravityController=b2GravityController,exports.b2EdgeAndCircleContact=b2EdgeAndCircleContact,exports.b2EdgeShape=b2EdgeShape,exports.b2BuoyancyController=b2BuoyancyController,exports.b2LineJointDef=b2LineJointDef,exports.b2Contact=b2Contact,exports.b2DistanceJoint=b2DistanceJoint,exports.b2Body=b2Body,exports.b2DestructionListener=b2DestructionListener,exports.b2PulleyJointDef=b2PulleyJointDef,exports.b2ContactEdge=b2ContactEdge,exports.b2ContactConstraint=b2ContactConstraint,exports.b2ContactImpulse=b2ContactImpulse,exports.b2DistanceJointDef=b2DistanceJointDef,exports.b2ContactResult=b2ContactResult,exports.b2EdgeChainDef=b2EdgeChainDef,exports.b2Vec2=b2Vec2,exports.b2Vec3=b2Vec3,exports.b2DistanceProxy=b2DistanceProxy,exports.b2FrictionJointDef=b2FrictionJointDef,exports.b2PolygonContact=b2PolygonContact,exports.b2TensorDampingController=b2TensorDampingController,exports.b2ContactFactory=b2ContactFactory,exports.b2WeldJointDef=b2WeldJointDef,exports.b2ConstantAccelController=b2ConstantAccelController,exports.b2GearJointDef=b2GearJointDef,exports.ClipVertex=ClipVertex,exports.b2SeparationFunction=b2SeparationFunction,exports.b2ManifoldPoint=b2ManifoldPoint,exports.b2Color=b2Color,exports.b2PolygonShape=b2PolygonShape,exports.b2DynamicTreePair=b2DynamicTreePair,exports.b2ContactConstraintPoint=b2ContactConstraintPoint,exports.b2FrictionJoint=b2FrictionJoint,exports.b2ContactFilter=b2ContactFilter,exports.b2ControllerEdge=b2ControllerEdge,exports.b2Distance=b2Distance,exports.b2Fixture=b2Fixture,exports.b2DynamicTreeNode=b2DynamicTreeNode,exports.b2MouseJoint=b2MouseJoint,exports.b2DistanceInput=b2DistanceInput,exports.b2BodyDef=b2BodyDef,exports.b2DynamicTreeBroadPhase=b2DynamicTreeBroadPhase,exports.b2Settings=b2Settings,exports.b2Proxy=b2Proxy,exports.b2Point=b2Point,exports.b2BroadPhase=b2BroadPhase,exports.b2Manifold=b2Manifold,exports.b2WorldManifold=b2WorldManifold,exports.b2PrismaticJointDef=b2PrismaticJointDef,exports.b2RayCastOutput=b2RayCastOutput,exports.b2ConstantForceController=b2ConstantForceController,exports.b2TimeOfImpact=b2TimeOfImpact,exports.b2CircleShape=b2CircleShape,exports.b2MassData=b2MassData,exports.b2Joint=b2Joint,exports.b2GearJoint=b2GearJoint,exports.b2DynamicTree=b2DynamicTree,exports.b2JointEdge=b2JointEdge,exports.b2LineJoint=b2LineJoint,exports.b2NullContact=b2NullContact,exports.b2ContactListener=b2ContactListener,exports.b2RayCastInput=b2RayCastInput,exports.b2TOIInput=b2TOIInput,exports.Features=Features,exports.b2FilterData=b2FilterData,exports.b2Island=b2Island,exports.b2ContactManager=b2ContactManager,exports.b2ContactSolver=b2ContactSolver,exports.b2Simplex=b2Simplex,exports.b2AABB=b2AABB,exports.b2Jacobian=b2Jacobian,exports.b2Bound=b2Bound,exports.b2RevoluteJointDef=b2RevoluteJointDef,exports.b2PolyAndEdgeContact=b2PolyAndEdgeContact,exports.b2SimplexVertex=b2SimplexVertex,exports.b2WeldJoint=b2WeldJoint,exports.b2Collision=b2Collision,exports.b2Mat22=b2Mat22,exports.b2SimplexCache=b2SimplexCache,exports.b2PolyAndCircleContact=b2PolyAndCircleContact,exports.b2MouseJointDef=b2MouseJointDef,exports.b2Shape=b2Shape,exports.b2Segment=b2Segment,exports.b2ContactRegister=b2ContactRegister,exports.b2DebugDraw=b2DebugDraw,exports.b2Sweep=b2Sweep);</script> <script>function ghost_create_replay(){return enable_ghost?{num_frames:0,frames:[]}:null}function ghost_create_ghost(){return enable_ghost?{replay:null,frame:0,dist:-100}:null}function ghost_reset_ghost(e){enable_ghost&&null!=e&&(e.frame=0)}function ghost_pause(e){null!=e&&(e.old_frame=e.frame),ghost_reset_ghost(e)}function ghost_resume(e){null!=e&&(e.frame=e.old_frame)}function ghost_get_position(e){if(enable_ghost&&null!=e&&!(e.frame<0)&&null!=e.replay){return e.replay.frames[e.frame].pos}}function ghost_compare_to_replay(e,t,s){enable_ghost&&null!=t&&null!=e&&t.dist<s&&(t.replay=e,t.dist=s,t.frame=0)}function ghost_move_frame(e){enable_ghost&&null!=e&&null!=e.replay&&++e.frame>=e.replay.num_frames&&(e.frame=e.replay.num_frames-1)}function ghost_add_replay_frame(e,t){if(enable_ghost&&null!=e){var s=ghost_get_frame(t);e.frames.push(s),e.num_frames++}}function ghost_draw_frame(e,t){if(enable_ghost&&null!=t&&!(t.frame<0)&&null!=t.replay){var s=t.replay.frames[t.frame];e.fillStyle="#eee",e.strokeStyle="#aaa",e.lineWidth=1/zoom;for(var r=0;r<s.wheels.length;r++)for(w in s.wheels[r])ghost_draw_circle(e,s.wheels[r][w].pos,s.wheels[r][w].rad,s.wheels[r][w].ang);e.strokeStyle="#aaa",e.fillStyle="#eee",e.lineWidth=1/zoom,e.beginPath();for(c in s.chassis)ghost_draw_poly(e,s.chassis[c].vtx,s.chassis[c].num);e.fill(),e.stroke()}}function ghost_get_frame(e){for(var t={chassis:ghost_get_chassis(e.chassis),wheels:[],pos:{x:e.getPosition().x,y:e.getPosition().y}},s=0;s<e.wheels.length;s++)t.wheels[s]=ghost_get_wheel(e.wheels[s]);return t}function ghost_get_chassis(e){var t=[];for(f=e.GetFixtureList();f;f=f.m_next){s=f.GetShape();var r={vtx:[],num:0};r.num=s.m_vertexCount;for(var a=0;a<s.m_vertexCount;a++)r.vtx.push(e.GetWorldPoint(s.m_vertices[a]));t.push(r)}return t}function ghost_get_wheel(e){var t=[];for(f=e.GetFixtureList();f;f=f.m_next){s=f.GetShape();var r={pos:e.GetWorldPoint(s.m_p),rad:s.m_radius,ang:e.m_sweep.a};t.push(r)}return t}function ghost_draw_poly(e,t,s){e.moveTo(t[0].x,t[0].y);for(var r=1;r<s;r++)e.lineTo(t[r].x,t[r].y);e.lineTo(t[0].x,t[0].y)}function ghost_draw_circle(e,t,s,r){e.beginPath(),e.arc(t.x,t.y,s,0,2*Math.PI,!0),e.moveTo(t.x,t.y),e.lineTo(t.x+s*Math.cos(r),t.y+s*Math.sin(r)),e.fill(),e.stroke()}var enable_ghost=!0;</script> <script>function cw_createFloor(){var e=null,r=new b2Vec2(-5,0);cw_floorTiles=new Array,Math.seedrandom(floorseed);for(var o=0;o<maxFloorTiles;o++)e=mutable_floor?cw_createFloorTile(r,1.2*(3*Math.random()-1.5)*o/maxFloorTiles):cw_createFloorTile(r,1.5*(3*Math.random()-1.5)*o/maxFloorTiles),cw_floorTiles.push(e),last_fixture=e.GetFixtureList(),last_world_coords=e.GetWorldPoint(last_fixture.GetShape().m_vertices[3]),r=last_world_coords;world.finishLine=r.x}function cw_createFloorTile(e,r){body_def=new b2BodyDef,body_def.position.Set(e.x,e.y);var o=world.CreateBody(body_def);fix_def=new b2FixtureDef,fix_def.shape=new b2PolygonShape,fix_def.friction=.5;var t=new Array;t.push(new b2Vec2(0,0)),t.push(new b2Vec2(0,-groundPieceHeight)),t.push(new b2Vec2(groundPieceWidth,-groundPieceHeight)),t.push(new b2Vec2(groundPieceWidth,0));var a=new b2Vec2(0,0),i=cw_rotateFloorTile(t,a,r);return fix_def.shape.SetAsArray(i),o.CreateFixture(fix_def),o}function cw_rotateFloorTile(e,r,o){for(var t=new Array,a=0;a<e.length;a++)nc=new Object,nc.x=Math.cos(o)*(e[a].x-r.x)-Math.sin(o)*(e[a].y-r.y)+r.x,nc.y=Math.sin(o)*(e[a].x-r.x)+Math.cos(o)*(e[a].y-r.y)+r.y,t.push(nc);return t}function cw_drawFloor(){ctx.strokeStyle="#000",ctx.fillStyle="#666",ctx.lineWidth=1/zoom,ctx.beginPath();e:for(var e=Math.max(0,last_drawn_tile-20);e<cw_floorTiles.length;e++){var r=cw_floorTiles[e];for(f=r.GetFixtureList();f;f=f.m_next){var o=f.GetShape(),t=r.GetWorldPoint(o.m_vertices[0]).x;if(t>camera_x-5&&t<camera_x+10&&cw_drawVirtualPoly(r,o.m_vertices,o.m_vertexCount),t>camera_x+10){last_drawn_tile=e;break e}}}ctx.fill(),ctx.stroke()}</script> <script>function debug(e,t){t&&(debugbox.innerHTML=""),debugbox.innerHTML+=e+"<br />"}function showDistance(e,t){distanceMeter.innerHTML=e+" meters<br />",heightMeter.innerHTML=t+" meters",e>minimapfogdistance&&(fogdistance.width=800-Math.round(e+15)*minimapscale+"px",minimapfogdistance=e)}function cw_createChassisPart(e,t,a,r){var n=new Array;n.push(t),n.push(a),n.push(b2Vec2.Make(0,0));var i=new b2FixtureDef;i.shape=new b2PolygonShape,i.density=r,i.friction=10,i.restitution=.2,i.filter.groupIndex=-1,i.shape.SetAsArray(n,3),e.CreateFixture(i)}function cw_createChassis(e,t){var a=new b2BodyDef;a.type=b2Body.b2_dynamicBody,a.position.Set(0,4);var r=world.CreateBody(a);return cw_createChassisPart(r,e[0],e[1],t),cw_createChassisPart(r,e[1],e[2],t),cw_createChassisPart(r,e[2],e[3],t),cw_createChassisPart(r,e[3],e[4],t),cw_createChassisPart(r,e[4],e[5],t),cw_createChassisPart(r,e[5],e[6],t),cw_createChassisPart(r,e[6],e[7],t),cw_createChassisPart(r,e[7],e[0],t),r.vertex_list=e,r}function cw_createWheel(e,t){var a=new b2BodyDef;a.type=b2Body.b2_dynamicBody,a.position.Set(0,0);var r=world.CreateBody(a),n=new b2FixtureDef;return n.shape=new b2CircleShape(e),n.density=t,n.friction=1,n.restitution=.2,n.filter.groupIndex=-1,r.CreateFixture(n),r}function cw_createRandomCar(){var e=new Object;e.wheelCount=2,e.wheel_radius=[],e.wheel_density=[],e.wheel_vertex=[];for(var t=0;t<e.wheelCount;t++)e.wheel_radius[t]=Math.random()*wheelRadiusRange+wheelMinRadius,e.wheel_density[t]=Math.random()*wheelDensityRange+wheelMinDensity;e.chassis_density=Math.random()*chassisDensityRange+chassisMinDensity,e.vertex_list=new Array,e.vertex_list.push(new b2Vec2(Math.random()*chassisAxisRange+chassisMinAxis,0)),e.vertex_list.push(new b2Vec2(Math.random()*chassisAxisRange+chassisMinAxis,Math.random()*chassisAxisRange+chassisMinAxis)),e.vertex_list.push(new b2Vec2(0,Math.random()*chassisAxisRange+chassisMinAxis)),e.vertex_list.push(new b2Vec2(-Math.random()*chassisAxisRange-chassisMinAxis,Math.random()*chassisAxisRange+chassisMinAxis)),e.vertex_list.push(new b2Vec2(-Math.random()*chassisAxisRange-chassisMinAxis,0)),e.vertex_list.push(new b2Vec2(-Math.random()*chassisAxisRange-chassisMinAxis,-Math.random()*chassisAxisRange-chassisMinAxis)),e.vertex_list.push(new b2Vec2(0,-Math.random()*chassisAxisRange-chassisMinAxis)),e.vertex_list.push(new b2Vec2(Math.random()*chassisAxisRange+chassisMinAxis,-Math.random()*chassisAxisRange-chassisMinAxis));for(var a=[],t=0;t<8;t++)a.push(t);for(var t=0;t<e.wheelCount;t++){var r=Math.floor(Math.random()*a.length);e.wheel_vertex[t]=a[r],a.splice(r,1)}return e}function cw_generationZero(){for(var e=0;e<generationSize;e++){var t=cw_createRandomCar();t.index=e,cw_carGeneration.push(t)}gen_counter=0,cw_deadCars=0,leaderPosition=new Object,leaderPosition.x=0,leaderPosition.y=0,cw_materializeGeneration(),document.getElementById("generation").innerHTML="0",document.getElementById("population").innerHTML=generationSize.toString(),ghost=ghost_create_ghost()}function cw_materializeGeneration(){cw_carArray=new Array;for(var e=0;e<generationSize;e++)cw_carArray.push(new cw_Car(cw_carGeneration[e]))}function cw_nextGeneration(){var e,t=new Array;cw_getChampions(),cw_topScores.push({i:gen_counter,v:cw_carScores[0].v,x:cw_carScores[0].x,y:cw_carScores[0].y,y2:cw_carScores[0].y2}),plot_graphs();for(var a=0;a<gen_champions;a++)cw_carScores[a].car_def.is_elite=!0,cw_carScores[a].car_def.index=a,t.push(cw_carScores[a].car_def);for(a=gen_champions;a<generationSize;a++){for(var r=cw_getParents(),n=r;n==r;)n=cw_getParents();e=cw_makeChild(cw_carScores[r].car_def,cw_carScores[n].car_def),e=cw_mutate(e),e.is_elite=!1,e.index=a,t.push(e)}cw_carScores=new Array,cw_carGeneration=t,gen_counter++,cw_materializeGeneration(),cw_deadCars=0,leaderPosition=new Object,leaderPosition.x=0,leaderPosition.y=0,document.getElementById("generation").innerHTML=gen_counter.toString(),document.getElementById("cars").innerHTML="",document.getElementById("population").innerHTML=generationSize.toString()}function cw_getChampions(){var e=new Array;cw_carScores.sort(function(e,t){return e.v>t.v?-1:1});for(var t=0;t<generationSize;t++)e.push(cw_carScores[t].i);return e}function cw_getParents(){var e=Math.random();return 0==e?0:Math.floor(-Math.log(e)*generationSize)%generationSize}function cw_makeChild(e,t){var a=new Object;for(swapPoint1=Math.round(Math.random()*(nAttributes-1)),swapPoint2=swapPoint1;swapPoint2==swapPoint1;)swapPoint2=Math.round(Math.random()*(nAttributes-1));var r=[e,t],n=0,i=0,o=r[0].wheelCount==r[1].wheelCount;o||(i=Math.floor(2*Math.random())),a.wheelCount=r[i].wheelCount,a.wheel_radius=[];for(var s=0;s<a.wheelCount;s++)n=o?cw_chooseParent(n,s):i,a.wheel_radius[s]=r[n].wheel_radius[s];a.wheel_vertex=[];for(var s=0;s<a.wheelCount;s++)n=o?cw_chooseParent(n,s+2):i,a.wheel_vertex[s]=r[n].wheel_vertex[s];a.wheel_density=[];for(var s=0;s<a.wheelCount;s++)n=o?cw_chooseParent(n,s+12):i,a.wheel_density[s]=r[n].wheel_density[s];return a.vertex_list=new Array,n=cw_chooseParent(n,4),a.vertex_list[0]=r[n].vertex_list[0],n=cw_chooseParent(n,5),a.vertex_list[1]=r[n].vertex_list[1],n=cw_chooseParent(n,6),a.vertex_list[2]=r[n].vertex_list[2],n=cw_chooseParent(n,7),a.vertex_list[3]=r[n].vertex_list[3],n=cw_chooseParent(n,8),a.vertex_list[4]=r[n].vertex_list[4],n=cw_chooseParent(n,9),a.vertex_list[5]=r[n].vertex_list[5],n=cw_chooseParent(n,10),a.vertex_list[6]=r[n].vertex_list[6],n=cw_chooseParent(n,11),a.vertex_list[7]=r[n].vertex_list[7],n=cw_chooseParent(n,14),a.chassis_density=r[n].chassis_density,a}function cw_mutate1(e,t,a){var r=a*mutation_range,n=e-.5*r;return n<t&&(n=t),n>t+(a-r)&&(n=t+(a-r)),n+r*Math.random()}function cw_mutatev(e,t,a,r){if(!(Math.random()>=gen_mutation)){var n=e.vertex_list[t],i=0,o=0;0!=a&&(i=a*cw_mutate1(a*n.x,chassisMinAxis,chassisAxisRange)),0!=r&&(o=r*cw_mutate1(r*n.y,chassisMinAxis,chassisAxisRange)),e.vertex_list.splice(t,1,new b2Vec2(i,o))}}function cw_mutate(e){for(var t=0;t<e.wheelCount;t++)Math.random()<gen_mutation&&(e.wheel_radius[t]=cw_mutate1(e.wheel_radius[t],wheelMinRadius,wheelRadiusRange));for(var a=mutation_range<gen_mutation?mutation_range:gen_mutation,t=0;t<e.wheelCount;t++)Math.random()<a&&(e.wheel_vertex[t]=Math.floor(8*Math.random())%8);for(var t=0;t<e.wheelCount;t++)Math.random()<gen_mutation&&(e.wheel_density[t]=cw_mutate1(e.wheel_density[t],wheelMinDensity,wheelDensityRange));return Math.random()<gen_mutation&&(e.chassis_density=cw_mutate1(e.chassis_density,chassisMinDensity,chassisDensityRange)),cw_mutatev(e,0,1,0),cw_mutatev(e,1,1,1),cw_mutatev(e,2,0,1),cw_mutatev(e,3,-1,1),cw_mutatev(e,4,-1,0),cw_mutatev(e,5,-1,-1),cw_mutatev(e,6,0,-1),cw_mutatev(e,7,1,-1),e}function cw_chooseParent(e,t){return swapPoint1==t||swapPoint2==t?1==e?0:1:e}function cw_setMutation(e){gen_mutation=parseFloat(e)}function cw_setMutationRange(e){mutation_range=parseFloat(e)}function cw_setMutableFloor(e){mutable_floor=1==e}function cw_setGravity(e){gravity=new b2Vec2(0,-parseFloat(e)),world.GetGravity().y!=gravity.y&&world.SetGravity(gravity)}function cw_setEliteSize(e){gen_champions=parseInt(e,10)}function cw_drawScreen(){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.save(),cw_setCameraPosition(),ctx.translate(200-camera_x*zoom,200+camera_y*zoom),ctx.scale(zoom,-zoom),cw_drawFloor(),ghost_draw_frame(ctx,ghost),cw_drawCars(),ctx.restore()}function cw_minimapCamera(e,t){minimapcamera.left=Math.round((2+camera_x)*minimapscale)+"px",minimapcamera.top=Math.round((31-camera_y)*minimapscale)+"px"}function cw_setCameraTarget(e){camera_target=e}function cw_setCameraPosition(){if(camera_target>=0)var e=cw_carArray[camera_target].getPosition();else var e=leaderPosition;var t=camera_y-e.y,a=camera_x-e.x;camera_y-=cameraspeed*t,camera_x-=cameraspeed*a,cw_minimapCamera(camera_x,camera_y)}function cw_drawGhostReplay(){carPosition=ghost_get_position(ghost),camera_x=carPosition.x,camera_y=carPosition.y,cw_minimapCamera(camera_x,camera_y),showDistance(Math.round(100*carPosition.x)/100,Math.round(100*carPosition.y)/100),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.save(),ctx.translate(200-carPosition.x*zoom,200+carPosition.y*zoom),ctx.scale(zoom,-zoom),ghost_draw_frame(ctx,ghost),ghost_move_frame(ghost),cw_drawFloor(),ctx.restore()}function cw_drawCars(){for(var e=cw_carArray.length-1;e>=0;e--)if(myCar=cw_carArray[e],myCar.alive&&(myCarPos=myCar.getPosition(),!(myCarPos.x<camera_x-5))){ctx.strokeStyle="#444",ctx.lineWidth=1/zoom;for(var t=0;t<myCar.wheels.length;t++)for(i=myCar.wheels[t],f=i.GetFixtureList();f;f=f.m_next){var a=f.GetShape(),r=Math.round(255-255*(f.m_density-wheelMinDensity)/wheelDensityRange).toString(),n="rgb("+r+","+r+","+r+")";cw_drawCircle(i,a.m_p,a.m_radius,i.m_sweep.a,n)}myCar.is_elite?(ctx.strokeStyle="#3F72AF",ctx.fillStyle="#DBE2EF"):(ctx.strokeStyle="#F7C873",ctx.fillStyle="#FAEBCD"),ctx.beginPath();var i=myCar.chassis;for(f=i.GetFixtureList();f;f=f.m_next){var a=f.GetShape();cw_drawVirtualPoly(i,a.m_vertices,a.m_vertexCount)}ctx.fill(),ctx.stroke()}}function toggleDisplay(){cw_paused||(canvas.width=canvas.width,doDraw?(doDraw=!1,cw_stopSimulation(),cw_runningInterval=setInterval(function(){for(var e=performance.now()+1e3/screenfps;e>performance.now();)simulationStep()},1)):(doDraw=!0,clearInterval(cw_runningInterval),cw_startSimulation()))}function cw_drawVirtualPoly(e,t,a){var r=e.GetWorldPoint(t[0]);ctx.moveTo(r.x,r.y);for(var n=1;n<a;n++)p=e.GetWorldPoint(t[n]),ctx.lineTo(p.x,p.y);ctx.lineTo(r.x,r.y)}function cw_drawPoly(e,t,a){ctx.beginPath();var r=e.GetWorldPoint(t[0]);ctx.moveTo(r.x,r.y);for(var n=1;n<a;n++)p=e.GetWorldPoint(t[n]),ctx.lineTo(p.x,p.y);ctx.lineTo(r.x,r.y),ctx.fill(),ctx.stroke()}function cw_drawCircle(e,t,a,r,n){var i=e.GetWorldPoint(t);ctx.fillStyle=n,ctx.beginPath(),ctx.arc(i.x,i.y,a,0,2*Math.PI,!0),ctx.moveTo(i.x,i.y),ctx.lineTo(i.x+a*Math.cos(r),i.y+a*Math.sin(r)),ctx.fill(),ctx.stroke()}function cw_drawMiniMap(){var e=null,t=new b2Vec2(-5,0);minimapfogdistance=0,fogdistance.width="800px",minimapcanvas.width=minimapcanvas.width,minimapctx.strokeStyle="#3F72AF",minimapctx.beginPath(),minimapctx.moveTo(0,35*minimapscale);for(var a=0;a<cw_floorTiles.length;a++)e=cw_floorTiles[a],last_fixture=e.GetFixtureList(),last_world_coords=e.GetWorldPoint(last_fixture.GetShape().m_vertices[3]),t=last_world_coords,minimapctx.lineTo((t.x+5)*minimapscale,(35-t.y)*minimapscale);minimapctx.stroke()}function saveProgress(){localStorage.cw_savedGeneration=JSON.stringify(cw_carGeneration),localStorage.cw_genCounter=gen_counter,localStorage.cw_ghost=JSON.stringify(ghost),localStorage.cw_topScores=JSON.stringify(cw_topScores),localStorage.cw_floorSeed=floorseed}function restoreProgress(){if(void 0===localStorage.cw_savedGeneration||null==localStorage.cw_savedGeneration)return void alert("No saved progress found");for(cw_stopSimulation(),cw_carGeneration=JSON.parse(localStorage.cw_savedGeneration),gen_counter=localStorage.cw_genCounter,ghost=JSON.parse(localStorage.cw_ghost),cw_topScores=JSON.parse(localStorage.cw_topScores),floorseed=localStorage.cw_floorSeed,document.getElementById("newseed").value=floorseed,b=world.m_bodyList;b;b=b.m_next)world.DestroyBody(b);Math.seedrandom(floorseed),cw_createFloor(),cw_drawMiniMap(),Math.seedrandom(),cw_materializeGeneration(),cw_deadCars=0,leaderPosition=new Object,leaderPosition.x=0,leaderPosition.y=0,document.getElementById("generation").innerHTML=gen_counter,document.getElementById("cars").innerHTML="",document.getElementById("population").innerHTML=generationSize,cw_startSimulation()}function simulationStep(){world.Step(1/box2dfps,20,20),ghost_move_frame(ghost);for(var e=0;e<generationSize;e++)cw_carArray[e].alive&&(ghost_add_replay_frame(cw_carArray[e].replay,cw_carArray[e]),cw_carArray[e].frames++,position=cw_carArray[e].getPosition(),cw_carArray[e].minimapmarker.style.left=Math.round((position.x+5)*minimapscale)+"px",cw_carArray[e].healthBar.width=Math.round(cw_carArray[e].health/max_car_health*100)+"%",cw_carArray[e].checkDeath()?(cw_carArray[e].kill(),cw_deadCars++,document.getElementById("population").innerHTML=(generationSize-cw_deadCars).toString(),cw_carArray[e].minimapmarker.style.borderLeft="1px solid #3F72AF",cw_deadCars>=generationSize&&cw_newRound(),leaderPosition.leader==e&&cw_findLeader()):position.x>leaderPosition.x&&(leaderPosition=position,leaderPosition.leader=e));showDistance(Math.round(100*leaderPosition.x)/100,Math.round(100*leaderPosition.y)/100)}function cw_findLeader(){for(var e=0;e<cw_carArray.length;e++)cw_carArray[e].alive&&(position=cw_carArray[e].getPosition(),position.x>0&&(leaderPosition=position,leaderPosition.leader=e))}function cw_newRound(){mutable_floor?(ghost=null,floorseed=btoa(Math.seedrandom()),world=new b2World(gravity,doSleep),cw_createFloor(),cw_drawMiniMap()):ghost_reset_ghost(ghost),cw_nextGeneration(),camera_x=camera_y=0,cw_setCameraTarget(-1)}function cw_startSimulation(){cw_runningInterval=setInterval(simulationStep,Math.round(1e3/box2dfps)),cw_drawInterval=setInterval(cw_drawScreen,Math.round(1e3/screenfps))}function cw_stopSimulation(){clearInterval(cw_runningInterval),clearInterval(cw_drawInterval)}function cw_kill(){var e=myCar.maxPosition/myCar.frames*box2dfps,t=myCar.maxPosition,a=t+e;document.getElementById("cars").innerHTML+=Math.round(100*t)/100+"m + "+Math.round(100*e)/100+" m/s = "+Math.round(100*a)/100+"pts<br />",ghost_compare_to_replay(replay,ghost,a),cw_carScores.push({i:current_car_index,v:a,s:e,x:t,y:myCar.maxPositiony,y2:myCar.minPositiony}),current_car_index++,cw_killCar(),current_car_index>=generationSize&&(cw_nextGeneration(),current_car_index=0),myCar=cw_createNextCar(),last_drawn_tile=0}function cw_resetPopulation(){document.getElementById("generation").innerHTML="",document.getElementById("cars").innerHTML="",document.getElementById("topscores").innerHTML="",cw_clearGraphics(),cw_carArray=new Array,cw_carGeneration=new Array,cw_carScores=new Array,cw_topScores=new Array,cw_graphTop=new Array,cw_graphElite=new Array,cw_graphAverage=new Array,lastmax=0,lastaverage=0,lasteliteaverage=0,swapPoint1=0,swapPoint2=0,cw_generationZero()}function cw_resetWorld(){for(doDraw=!0,cw_stopSimulation(),b=world.m_bodyList;b;b=b.m_next)world.DestroyBody(b);floorseed=document.getElementById("newseed").value,Math.seedrandom(floorseed),cw_createFloor(),cw_drawMiniMap(),Math.seedrandom(),cw_resetPopulation(),cw_startSimulation()}function cw_confirmResetWorld(){if(!confirm("Really reset world?"))return!1;cw_resetWorld()}function cw_pauseSimulation(){cw_paused=!0,clearInterval(cw_runningInterval),clearInterval(cw_drawInterval),old_last_drawn_tile=last_drawn_tile,last_drawn_tile=0,ghost_pause(ghost)}function cw_resumeSimulation(){cw_paused=!1,ghost_resume(ghost),last_drawn_tile=old_last_drawn_tile,cw_runningInterval=setInterval(simulationStep,Math.round(1e3/box2dfps)),cw_drawInterval=setInterval(cw_drawScreen,Math.round(1e3/screenfps))}function cw_startGhostReplay(){doDraw||toggleDisplay(),cw_pauseSimulation(),cw_ghostReplayInterval=setInterval(cw_drawGhostReplay,Math.round(1e3/screenfps))}function cw_stopGhostReplay(){clearInterval(cw_ghostReplayInterval),cw_ghostReplayInterval=null,cw_findLeader(),camera_x=leaderPosition.x,camera_y=leaderPosition.y,cw_resumeSimulation()}function cw_toggleGhostReplay(e){null==cw_ghostReplayInterval?(cw_startGhostReplay(),e.value="Resume simulation"):(cw_stopGhostReplay(),e.value="View top replay")}function cw_init(){for(var e=document.getElementsByName("minimapmarker")[0],t=document.getElementsByName("healthbar")[0],a=0;a<generationSize;a++){var r=e.cloneNode(!0);r.id="bar"+a,r.style.paddingTop=9*a+"px",minimapholder.appendChild(r);var n=t.cloneNode(!0);n.getElementsByTagName("DIV")[0].id="health"+a,n.car_index=a,document.getElementById("health").appendChild(n)}e.parentNode.removeChild(e),t.parentNode.removeChild(t),floorseed=btoa(Math.seedrandom()),world=new b2World(gravity,doSleep),cw_createFloor(),cw_drawMiniMap(),cw_generationZero(),cw_runningInterval=setInterval(simulationStep,Math.round(1e3/box2dfps)),cw_drawInterval=setInterval(cw_drawScreen,Math.round(1e3/screenfps))}function relMouseCoords(e){var t=0,a=0,r=0,n=0,i=this;do{t+=i.offsetLeft-i.scrollLeft,a+=i.offsetTop-i.scrollTop}while(i=i.offsetParent);return r=e.pageX-t,n=e.pageY-a,{x:r,y:n}}var ghost,timeStep=1/60,doDraw=!0,cw_paused=!1,box2dfps=60,screenfps=60,debugbox=document.getElementById("debug"),canvas=document.getElementById("mainbox"),ctx=canvas.getContext("2d"),cameraspeed=.05,camera_y=0,camera_x=0,camera_target=-1,minimapcamera=document.getElementById("minimapcamera").style,graphcanvas=document.getElementById("graphcanvas"),graphctx=graphcanvas.getContext("2d"),graphheight=250,graphwidth=400,minimapcanvas=document.getElementById("minimap"),minimapctx=minimapcanvas.getContext("2d"),minimapscale=3,minimapfogdistance=0,fogdistance=document.getElementById("minimapfog").style,generationSize=20,cw_carArray=new Array,cw_carGeneration=new Array,cw_carScores=new Array,cw_topScores=new Array,cw_graphTop=new Array,cw_graphElite=new Array,cw_graphAverage=new Array,gen_champions=1,gen_parentality=.2,gen_mutation=.05,mutation_range=1,gen_counter=0,nAttributes=15,gravity=new b2Vec2(0,-9.81),doSleep=!0,world,zoom=70,mutable_floor=!1,maxFloorTiles=200,cw_floorTiles=new Array,last_drawn_tile=0,groundPieceWidth=1.5,groundPieceHeight=.15,chassisAxisRange=1.1,chassisMinAxis=.1,chassisMinDensity=30,chassisDensityRange=300,wheelRadiusRange=.5,wheelMinRadius=.2,wheelDensityRange=100,wheelMinDensity=40,velocityIndex=0,deathSpeed=.1,max_car_health=10*box2dfps,car_health=max_car_health,motorSpeed=20,swapPoint1=0,swapPoint2=0,cw_ghostReplayInterval=null,distanceMeter=document.getElementById("distancemeter"),heightMeter=document.getElementById("heightmeter"),leaderPosition=new Object;leaderPosition.x=0,leaderPosition.y=0,minimapcamera.width=12*minimapscale+"px",minimapcamera.height=6*minimapscale+"px";var cw_Car=function(){this.__constructor.apply(this,arguments)};cw_Car.prototype.chassis=null,cw_Car.prototype.wheels=[],cw_Car.prototype.__constructor=function(e){this.velocityIndex=0,this.health=max_car_health,this.maxPosition=0,this.maxPositiony=0,this.minPositiony=0,this.frames=0,this.car_def=e,this.alive=!0,this.is_elite=e.is_elite,this.healthBar=document.getElementById("health"+e.index).style,this.healthBarText=document.getElementById("health"+e.index).nextSibling.nextSibling,this.healthBarText.innerHTML=e.index,this.minimapmarker=document.getElementById("bar"+e.index),this.is_elite?(this.healthBar.backgroundColor="#3F72AF",this.minimapmarker.style.borderLeft="1px solid #3F72AF",this.minimapmarker.innerHTML=e.index):(this.healthBar.backgroundColor="#F7C873",this.minimapmarker.style.borderLeft="1px solid #F7C873",this.minimapmarker.innerHTML=e.index),this.chassis=cw_createChassis(e.vertex_list,e.chassis_density),this.wheels=[];for(var t=0;t<e.wheelCount;t++)this.wheels[t]=cw_createWheel(e.wheel_radius[t],e.wheel_density[t]);for(var a=this.chassis.GetMass(),t=0;t<e.wheelCount;t++)a+=this.wheels[t].GetMass();for(var r=[],t=0;t<e.wheelCount;t++)r[t]=a*-gravity.y/e.wheel_radius[t];for(var n=new b2RevoluteJointDef,t=0;t<e.wheelCount;t++){var i=this.chassis.vertex_list[e.wheel_vertex[t]];n.localAnchorA.Set(i.x,i.y),n.localAnchorB.Set(0,0),n.maxMotorTorque=r[t],n.motorSpeed=-motorSpeed,n.enableMotor=!0,n.bodyA=this.chassis,n.bodyB=this.wheels[t];world.CreateJoint(n)}this.replay=ghost_create_replay(),ghost_add_replay_frame(this.replay,this)},cw_Car.prototype.getPosition=function(){return this.chassis.GetPosition()},cw_Car.prototype.draw=function(){drawObject(this.chassis);for(var e=0;e<this.wheels.length;e++)drawObject(this.wheels[e])},cw_Car.prototype.kill=function(){var e=this.maxPosition/this.frames*box2dfps,t=this.maxPosition,a=t+e;ghost_compare_to_replay(this.replay,ghost,a),cw_carScores.push({car_def:this.car_def,v:a,s:e,x:t,y:this.maxPositiony,y2:this.minPositiony}),world.DestroyBody(this.chassis);for(var r=0;r<this.wheels.length;r++)world.DestroyBody(this.wheels[r]);this.alive=!1,camera_target==this.car_def.index&&cw_setCameraTarget(-1)},cw_Car.prototype.checkDeath=function(){var e=this.getPosition();if(e.x>world.finishLine)return this.healthBar.width="0",!0;if(e.y>this.maxPositiony&&(this.maxPositiony=e.y),e.y<this.minPositiony&&(this.minPositiony=e.y),e.x>this.maxPosition+.02)this.health=max_car_health,this.maxPosition=e.x;else if(e.x>this.maxPosition&&(this.maxPosition=e.x),Math.abs(this.chassis.GetLinearVelocity().x)<.001&&(this.health-=5),--this.health<=0)return this.healthBarText.innerHTML="&dagger;",this.healthBar.width="0",!0},HTMLDivElement.prototype.relMouseCoords=relMouseCoords,minimapholder.onclick=function(e){for(var t=minimapholder.relMouseCoords(e),a={index:0,dist:Math.abs((cw_carArray[0].getPosition().x+6)*minimapscale-t.x),x:cw_carArray[0].getPosition().x},r=0,n=0;n<cw_carArray.length;n++)if(cw_carArray[n].alive){var i=cw_carArray[n].getPosition(),o=Math.abs((i.x+6)*minimapscale-t.x);o<a.dist&&(a.index=n,a.dist=o,a.x=i.x),r=Math.max(i.x,r)}cw_setCameraTarget(a.x==r?-1:a.index)},cw_init();</script> <script>function cw_storeGraphScores(){cw_graphAverage.push(cw_average(cw_carScores)),cw_graphElite.push(cw_eliteaverage(cw_carScores)),cw_graphTop.push(cw_carScores[0].v)}function cw_plotTop(){var r=cw_graphTop.length;graphctx.strokeStyle="#C83B3B",graphctx.beginPath(),graphctx.moveTo(0,0);for(var t=0;t<r;t++)graphctx.lineTo(400*(t+1)/r,cw_graphTop[t]);graphctx.stroke()}function cw_plotElite(){var r=cw_graphElite.length;graphctx.strokeStyle="#7BC74D",graphctx.beginPath(),graphctx.moveTo(0,0);for(var t=0;t<r;t++)graphctx.lineTo(400*(t+1)/r,cw_graphElite[t]);graphctx.stroke()}function cw_plotAverage(){var r=cw_graphAverage.length;graphctx.strokeStyle="#3F72AF",graphctx.beginPath(),graphctx.moveTo(0,0);for(var t=0;t<r;t++)graphctx.lineTo(400*(t+1)/r,cw_graphAverage[t]);graphctx.stroke()}function plot_graphs(){cw_storeGraphScores(),cw_clearGraphics(),cw_plotAverage(),cw_plotElite(),cw_plotTop(),cw_listTopScores()}function cw_eliteaverage(r){for(var t=0,e=0;e<Math.floor(generationSize/2);e++)t+=r[e].v;return t/Math.floor(generationSize/2)}function cw_average(r){for(var t=0,e=0;e<generationSize;e++)t+=r[e].v;return t/generationSize}function cw_clearGraphics(){graphcanvas.width=graphcanvas.width,graphctx.translate(0,graphheight),graphctx.scale(1,-1),graphctx.lineWidth=1,graphctx.strokeStyle="#3F72AF",graphctx.beginPath(),graphctx.moveTo(0,graphheight/2),graphctx.lineTo(graphwidth,graphheight/2),graphctx.moveTo(0,graphheight/4),graphctx.lineTo(graphwidth,graphheight/4),graphctx.moveTo(0,3*graphheight/4),graphctx.lineTo(graphwidth,3*graphheight/4),graphctx.stroke()}function cw_listTopScores(){document.getElementById("topscores").innerHTML="<b>Top Scores:</b><br />",cw_topScores.sort(function(r,t){return r.v>t.v?-1:1});for(var r=0;r<Math.min(10,cw_topScores.length);r++)document.getElementById("topscores").innerHTML+="#"+(r+1)+": "+Math.round(100*cw_topScores[r].v)/100+" d:"+Math.round(100*cw_topScores[r].x)/100+" h:"+Math.round(100*cw_topScores[r].y2)/100+"/"+Math.round(100*cw_topScores[r].y)/100+"m (Gen "+cw_topScores[r].i+")<br />"}</script> <script type="text/javascript">var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-25432661-3"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}();</script> </body> </html> 
